<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#e91e8c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>{% block title %}ä¸ƒå¤¢å­¦ç¿’ã‚¢ãƒ—ãƒª{% endblock %}</title>

    <style>
        input[type="text"],
        textarea,
        .ql-editor {
            ime-mode: active;
        }
    </style>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

    <!-- PWA -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icon-192.png') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icon-192.png') }}">

    {% block head %}{% endblock %}
</head>

<body>
    {% if current_user.is_authenticated %}
    <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
    <header class="header">
        <div class="header-content">
            <a href="{{ url_for('dashboard') }}" class="logo">ğŸ“š ä¸ƒå¤¢å­¦ç¿’</a>

            <!-- PCç”¨ãƒŠãƒ“ -->
            <nav class="nav">
                <a href="{{ url_for('dashboard') }}"
                    class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}">ğŸ  ãƒ›ãƒ¼ãƒ </a>
                {% if current_user.is_teacher() %}
                <a href="{{ url_for('create_problem') }}"
                    class="nav-link {% if request.endpoint == 'create_problem' %}active{% endif %}">âœï¸ å•é¡Œ</a>
                <a href="{{ url_for('manage_students') }}"
                    class="nav-link {% if request.endpoint == 'manage_students' %}active{% endif %}">ğŸ‘¥ ç”Ÿå¾’</a>
                <a href="{{ url_for('teacher_japanese_problems') }}"
                    class="nav-link {% if 'japanese' in request.endpoint %}active{% endif %}">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</a>
                <a href="{{ url_for('manage_announcements') }}"
                    class="nav-link {% if request.endpoint == 'manage_announcements' %}active{% endif %}">ğŸ“¢ é€£çµ¡</a>
                {% endif %}
            </nav>

            <div class="user-info">
                <span class="user-name">{{ current_user.display_name }}</span>
                <a href="{{ url_for('settings') }}" class="btn btn-secondary btn-sm">âš™ï¸</a>
            </div>
        </div>
    </header>
    {% endif %}

    <main class="main">
        <div class="container">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} fade-in">{{ message }}</div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            {% block content %}{% endblock %}
        </div>
    </main>

    {% if current_user.is_authenticated %}
    <!-- ãƒœãƒˆãƒ ãƒŠãƒ“ï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰ -->
    <nav class="bottom-nav">
        <a href="{{ url_for('dashboard') }}"
            class="bottom-nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}">
            <span class="nav-icon">ğŸ </span>
            <span>ãƒ›ãƒ¼ãƒ </span>
        </a>
        {% if current_user.is_teacher() %}
        <a href="{{ url_for('create_problem') }}"
            class="bottom-nav-link {% if request.endpoint == 'create_problem' %}active{% endif %}">
            <span class="nav-icon">âœï¸</span>
            <span>å•é¡Œ</span>
        </a>
        <a href="{{ url_for('manage_students') }}"
            class="bottom-nav-link {% if request.endpoint == 'manage_students' %}active{% endif %}">
            <span class="nav-icon">ğŸ‘¥</span>
            <span>ç”Ÿå¾’</span>
        </a>
        <a href="{{ url_for('manage_announcements') }}"
            class="bottom-nav-link {% if request.endpoint == 'manage_announcements' %}active{% endif %}">
            <span class="nav-icon">ğŸ“¢</span>
            <span>é€£çµ¡</span>
        </a>
        <a href="{{ url_for('teacher_japanese_problems') }}"
            class="bottom-nav-link {% if 'japanese' in request.endpoint %}active{% endif %}">
            <span class="nav-icon">ğŸ‡¯ğŸ‡µ</span>
            <span>æ—¥æœ¬èª</span>
        </a>
        {% endif %}
        <a href="{{ url_for('settings') }}"
            class="bottom-nav-link {% if request.endpoint == 'settings' %}active{% endif %}">
            <span class="nav-icon">âš™ï¸</span>
            <span>è¨­å®š</span>
        </a>
    </nav>
    {% endif %}

    <!-- ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ -->
    <div id="install-banner" class="install-banner">
        <div class="install-banner-content">
            <div class="install-banner-icon">ğŸ“±</div>
            <div class="install-banner-text">
                <div class="install-banner-title">ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</div>
                <div class="install-banner-desc">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦å¿«é©ã«ä½¿ãˆã¾ã™</div>
            </div>
            <button id="install-btn" class="install-btn">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
            <button id="install-close" class="install-close">Ã—</button>
        </div>
    </div>

    <style>
        .install-banner {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 16px;
            right: 16px;
            z-index: 9998;
            animation: slideUp 0.3s ease-out;
        }

        @media (min-width: 600px) {
            .install-banner {
                left: auto;
                right: 20px;
                bottom: 20px;
                max-width: 360px;
            }
        }

        .install-banner-content {
            background: linear-gradient(135deg, #e91e8c, #ff6b9d);
            color: white;
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(233, 30, 140, 0.4);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .install-banner-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .install-banner-text {
            flex: 1;
            min-width: 0;
        }

        .install-banner-title {
            font-weight: 700;
            font-size: 1rem;
        }

        .install-banner-desc {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 2px;
        }

        .install-btn {
            background: white;
            color: #e91e8c;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            transition: transform 0.2s;
        }

        .install-btn:hover {
            transform: scale(1.05);
        }

        .install-close {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            flex-shrink: 0;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>

    <script>
        // PWA ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        let deferredPrompt = null;
        const installBanner = document.getElementById('install-banner');
        const installBtn = document.getElementById('install-btn');
        const installClose = document.getElementById('install-close');

        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯èƒ½ã«ãªã£ãŸã¨ã
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã‹ã€24æ™‚é–“ä»¥å†…ã«é–‰ã˜ã¦ã„ãŸã‚‰è¡¨ç¤ºã—ãªã„
            const dismissed = localStorage.getItem('install-banner-dismissed');
            if (dismissed && Date.now() - parseInt(dismissed) < 24 * 60 * 60 * 1000) {
                return;
            }

            // ãƒãƒŠãƒ¼è¡¨ç¤º
            if (installBanner) {
                installBanner.style.display = 'block';
            }
        });

        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;

                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;

                if (outcome === 'accepted') {
                    console.log('ã‚¢ãƒ—ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸ');
                }
                deferredPrompt = null;
                installBanner.style.display = 'none';
            });
        }

        // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
        if (installClose) {
            installClose.addEventListener('click', () => {
                installBanner.style.display = 'none';
                localStorage.setItem('install-banner-dismissed', Date.now().toString());
            });
        }

        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†æ™‚
        window.addEventListener('appinstalled', () => {
            installBanner.style.display = 'none';
            deferredPrompt = null;
        });
    </script>

    <script src="{{ url_for('static', filename='js/editor.js') }}"></script>
    <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
    {% block scripts %}{% endblock %}
</body>

</html>