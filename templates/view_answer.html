{% extends "base.html" %}

{% block title %}å›ç­”ç¢ºèª - çŸ³å·ä¸ƒå¤¢è¬›å¸«å°‚ç”¨å­¦ç¿’ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="page-header">
        <h1 class="page-title">{{ answer.student.display_name }}ã•ã‚“ã®å›ç­”</h1>
        <a href="{{ url_for('view_problem', problem_id=answer.problem.id) }}" class="btn btn-secondary">â† å•é¡Œã«æˆ»ã‚‹</a>
    </div>

    <!-- å•é¡Œå†…å®¹ -->
    <div class="card" style="margin-bottom: 1.5rem;">
        <h2 class="card-title">ğŸ“‹ å•é¡Œ: {{ answer.problem.title }}</h2>
        <div class="editor-container" style="min-height: auto;">
            <div class="ql-container ql-snow" style="border: none;">
                <div class="ql-editor">{{ answer.problem.content|safe }}</div>
            </div>
        </div>
    </div>

    <!-- ç”Ÿå¾’ã®å›ç­” -->
    <div class="card" style="margin-bottom: 1.5rem;">
        <h2 class="card-title">ğŸ“ ç”Ÿå¾’ã®å›ç­”</h2>
        <div class="editor-container" style="min-height: auto;">
            <div class="ql-container ql-snow" style="border: none;">
                <div class="ql-editor">
                    {% if answer.problem.problem_type == 'mixed' %}
                    <!-- è¤‡åˆå•é¡Œï¼ˆå›ç­”åŸ‹ã‚è¾¼ã¿è¡¨ç¤ºï¼‰ -->
                    <div id="mixed-answer-result-container">
                        {{ answer.problem.content|safe }}
                    </div>
                    {% else %}
                    {{ answer.content|safe }}
                    {% endif %}
                </div>
            </div>
        </div>
        <div style="margin-top: 1rem; color: var(--text-muted); font-size: 0.875rem;">
            æå‡ºæ—¥: {{ answer.submitted_at|jst('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}
        </div>
    </div>

    <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å…¥åŠ›/è¡¨ç¤º -->
    <div class="card">
        <h2 class="card-title">ğŸ’¬ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h2>

        {% if answer.feedback %}
        <!-- æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º -->
        <div class="feedback-box" style="margin: 0;">
            <div class="feedback-header" style="justify-content: space-between;">
                <span>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å†…å®¹</span>
                {% if answer.feedback.score is not none %}
                <span class="score-display">{{ answer.feedback.score }}ç‚¹</span>
                {% endif %}
            </div>
            <div class="feedback-content">{{ answer.feedback.content|safe }}</div>
            <div style="margin-top: 0.75rem; color: var(--text-muted); font-size: 0.75rem;">
                {{ answer.feedback.created_at|jst('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}
            </div>
        </div>
        <div style="margin-top: 1rem; text-align: right;">
            <form method="POST" action="{{ url_for('delete_feedback', feedback_id=answer.feedback.id) }}"
                style="display: inline;">
                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirmDelete('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">
                    ğŸ—‘ï¸ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å‰Šé™¤
                </button>
            </form>
        </div>
        {% else %}
        <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form id="feedback-form" method="POST" action="{{ url_for('send_feedback', answer_id=answer.id) }}">
            <div class="form-group">
                <label class="form-label" for="score">ç‚¹æ•°ï¼ˆä»»æ„ï¼‰</label>
                <input type="number" id="score" name="score" class="form-input" min="0" max="100" placeholder="0-100"
                    style="max-width: 150px;">
            </div>

            <div class="form-group">
                <label class="form-label">ã‚³ãƒ¡ãƒ³ãƒˆ</label>
                <div class="editor-container">
                    <div id="feedback-editor"></div>
                </div>
                <input type="hidden" id="feedback-content" name="content">
            </div>

            <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="submit" class="btn btn-success">ğŸ“¤ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ä¿¡</button>
            </div>
        </form>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    /* è¤‡åˆå•é¡Œç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .mixed-option-label {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 8px;
    }

    .mixed-option-label.selected {
        background: rgba(233, 30, 140, 0.05);
        border-color: var(--primary);
        font-weight: bold;
        color: var(--primary);
    }

    .widget-replacement {
        margin: 16px 0;
        padding: 16px;
        background: #fff;
        border: 2px solid var(--primary);
        border-radius: 12px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- è¤‡åˆå•é¡Œ (Mixed: å›ç­”è¡¨ç¤º) ---
        {% if answer.problem.problem_type == 'mixed' %}
        const viewContainer = document.getElementById('mixed-answer-result-container');
        if (viewContainer) {
            const viewWidgets = viewContainer.querySelectorAll('.question-widget');
            let savedAnswers = [];
            try {
                savedAnswers = JSON.parse('{{ answer.content|replace("'", "\\'")|safe }}');
            } catch (e) {
                console.error('å›ç­”ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
            }

            viewWidgets.forEach((widget, index) => {
                const type = widget.dataset.widgetType;
                const answerData = savedAnswers[index]; // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ç…§åˆ

                // èª¬æ˜æ–‡ã®å–å¾— (ã‚ã‚Œã°)
                const descDiv = widget.querySelector('.widget-description');
                const descriptionHtml = descDiv ? descDiv.outerHTML : '';

                const replacement = document.createElement('div');
                replacement.className = 'widget-replacement';
                replacement.style.border = '2px solid #ccc'; // Readonly style
                replacement.style.background = '#f9f9f9';

                if (!answerData) {
                    replacement.innerHTML = '<div style="color:red">å›ç­”ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
                    widget.replaceWith(replacement);
                    return;
                }

                if (type === 'choice') {
                    // å˜ä¸€é¸æŠ
                    replacement.innerHTML = `
                            ${descriptionHtml}
                            <div class="mixed-option-label selected" style="pointer-events:none;">
                                <span style="margin-right:8px;">âœ…</span> ${answerData.choice_text}
                            </div>
                        `;
                } else if (type === 'checkbox') {
                    // è¤‡æ•°é¸æŠ
                    let html = `${descriptionHtml}<div style="display:flex; flex-direction:column; gap:4px;">`;
                    answerData.choice_text.forEach(txt => {
                        html += `
                            <div class="mixed-option-label selected" style="pointer-events:none;">
                                <span style="margin-right:8px;">âœ…</span> ${txt}
                            </div>`;
                    });
                    html += '</div>';
                    replacement.innerHTML = html;
                } else if (type === 'text') {
                    // è¨˜è¿°
                    const val = answerData.value ? answerData.value.replace(/\n/g, '<br>') : '(ç©ºæ¬„)';
                    replacement.innerHTML = `
                            ${descriptionHtml}
                            <div style="background:white; padding:12px; border-radius:4px; border:1px solid #ddd;">
                                ${val}
                            </div>
                        `;
                }
                widget.replaceWith(replacement);
            });
        }
        {% endif %}
    });
</script>

{% if not answer.feedback %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const quill = initEditor('feedback-editor');
        setupEditorForm('feedback-form', quill, 'feedback-content');
    });
</script>
{% endif %}
{% endblock %}