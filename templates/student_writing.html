{% extends "base.html" %}

{% block content %}
<style>
    .problem-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem;
    }

    .back-link {
        display: inline-block;
        margin-bottom: 1rem;
        color: #666;
        text-decoration: none;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    .completion-banner {
        background: #e8f5e9;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border: 1px solid #c8e6c9;
    }

    .teacher-feedback {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px dashed #aaa;
    }

    .writing-card {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .kanji-display {
        text-align: center;
        margin-bottom: 2rem;
    }

    .kanji-large {
        font-family: 'Klee One', 'Zen Kurenaido', 'YuKyokasho', serif;
        font-size: 10rem;
        color: #333;
        display: inline-block;
        line-height: 1.1;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
        text-align: left;
    }

    .info-box {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 8px;
    }

    .info-label {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 0.3rem;
    }

    .info-value {
        font-size: 1.1rem;
        color: #333;
        font-weight: 500;
    }

    .info-value.reading {
        color: #d32f2f;
        font-size: 1.3rem;
    }

    .audio-section {
        margin: 1.5rem 0;
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .audio-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.8rem 1.5rem;
        font-size: 1rem;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .audio-btn:hover {
        transform: translateY(-2px);
    }

    /* æ›¸ãé †ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .stroke-animation-section {
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        border: 2px solid #4caf50;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        text-align: center;
    }

    .stroke-animation-title {
        color: #2e7d32;
        font-weight: bold;
        font-size: 1.2rem;
        margin-bottom: 1rem;
    }

    .animation-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 2rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }

    .kanji-animation-box {
        width: 250px;
        height: 250px;
        background: white;
        border: 3px solid #81c784;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }

    #kanji-svg {
        width: 220px;
        height: 220px;
    }

    #kanji-svg path {
        fill: none;
        stroke: #333;
        stroke-width: 4;
        stroke-linecap: round;
        stroke-linejoin: round;
    }

    .animation-controls {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .anim-btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s;
    }

    .anim-btn.play {
        background: #4caf50;
        color: white;
    }

    .anim-btn.play:hover {
        background: #388e3c;
    }

    .anim-btn.reset {
        background: #ff9800;
        color: white;
    }

    .anim-btn.reset:hover {
        background: #f57c00;
    }

    .anim-btn.step {
        background: #2196f3;
        color: white;
    }

    .anim-btn.step:hover {
        background: #1976d2;
    }

    .stroke-counter {
        margin-top: 1rem;
        font-size: 1.2rem;
        color: #2e7d32;
        font-weight: bold;
    }

    .loading-indicator {
        color: #666;
        font-style: italic;
    }

    /* ä¾‹æ–‡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .example-section {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 2px solid #2196f3;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        text-align: left;
    }

    .example-title {
        color: #1565c0;
        font-weight: bold;
        font-size: 1rem;
        margin-bottom: 0.8rem;
    }

    .example-text {
        font-size: 1.2rem;
        color: #333;
        line-height: 1.8;
    }

    /* æ›¸ãæ–¹ã‚¬ã‚¤ãƒ‰ */
    .stroke-guide {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        border: 2px solid #ff9800;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1.5rem 0;
    }

    .stroke-guide-title {
        color: #e65100;
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 1rem;
        text-align: center;
    }

    .stroke-types {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        text-align: center;
    }

    .stroke-type {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stroke-icon {
        font-size: 2.5rem;
        display: block;
        margin-bottom: 0.5rem;
    }

    .stroke-name {
        font-weight: bold;
        color: #333;
        margin-bottom: 0.3rem;
    }

    .stroke-desc {
        font-size: 0.85rem;
        color: #666;
    }

    /* ä¸­å›½äººå‘ã‘æ³¨æ„ */
    .attention-section {
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        border: 2px solid #f44336;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        text-align: left;
    }

    .attention-title {
        color: #c62828;
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 0.8rem;
    }

    .attention-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .attention-list li {
        padding: 0.5rem 0;
        border-bottom: 1px dashed #ef9a9a;
        color: #333;
    }

    .attention-list li:last-child {
        border-bottom: none;
    }

    .attention-list li::before {
        content: "âš ï¸ ";
    }

    /* ãªãã‚Šç·´ç¿’ */
    .practice-section {
        margin-top: 2rem;
        border: 3px solid #4caf50;
        border-radius: 12px;
        background: white;
        padding: 1.5rem;
    }

    .practice-title {
        text-align: center;
        color: #2e7d32;
        margin-bottom: 1rem;
    }

    .practice-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
    }

    .practice-box {
        position: relative;
        aspect-ratio: 1;
        border: 2px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        background: #fafafa;
        container-type: size;
    }

    .trace-guide {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Klee One', 'YuKyokasho', serif;
        font-size: 80cqh;
        /* è¦ªã‚³ãƒ³ãƒ†ãƒŠã®é«˜ã•ã®80% */
        line-height: 1;
        color: rgba(0, 0, 0, 0.12);
        pointer-events: none;
        z-index: 1;
    }

    /* Fallback for browsers not supporting container queries */
    @supports not (font-size: 80cqh) {
        .trace-guide {
            font-size: 10rem;
        }
    }

    .cross-guide {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image:
            linear-gradient(to right, transparent 49.5%, #e0e0e0 49.5%, #e0e0e0 50.5%, transparent 50.5%),
            linear-gradient(to bottom, transparent 49.5%, #e0e0e0 49.5%, #e0e0e0 50.5%, transparent 50.5%);
        z-index: 0;
        pointer-events: none;
    }

    .practice-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2;
        touch-action: none;
    }

    .canvas-controls {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .practice-box-wrapper {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .box-controls {
        display: flex;
        gap: 0.3rem;
        justify-content: center;
    }

    .mini-btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
        background: #f5f5f5;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
    }

    .mini-btn:hover {
        background: #e0e0e0;
    }

    .control-btn {
        padding: 0.5rem 1rem;
        background: #f5f5f5;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
    }

    .control-btn:hover {
        background: #e0e0e0;
    }

    .complete-section {
        text-align: center;
        margin-top: 2rem;
    }

    .complete-btn {
        background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
        color: white;
        border: none;
        padding: 1rem 3rem;
        font-size: 1.2rem;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(76, 175, 80, 0.3);
    }

    .complete-btn:hover {
        transform: translateY(-2px);
    }
</style>

<div class="problem-container">
    <a href="{{ url_for('dashboard') }}" class="back-link">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>

    <h2>âœï¸ æ›¸ãå–ã‚Šç·´ç¿’</h2>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <div
        style="display: flex; justify-content: space-between; align-items: center; background: #f5f5f5; padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem;">
        {% if nav.prev_id %}
        <a href="{{ url_for('student_writing', assignment_id=nav.prev_id) }}"
            style="padding: 0.5rem 1rem; background: #2196f3; color: white; border: none; border-radius: 6px; text-decoration: none; font-size: 0.9rem;">â†
            å‰ã®å•é¡Œ</a>
        {% else %}
        <span style="padding: 0.5rem 1rem; background: #ccc; color: white; border-radius: 6px; font-size: 0.9rem;">â†
            å‰ã®å•é¡Œ</span>
        {% endif %}

        <div style="display: flex; gap: 6px; align-items: center;">
            {% for item in nav.group_items %}
            <a href="{{ url_for('student_writing', assignment_id=item.id) }}"
                style="width: 12px; height: 12px; border-radius: 50%; display: inline-block;
                      {% if item.id == assignment.id %}background: #2196f3; transform: scale(1.3);{% elif item.teacher_feedback %}background: #ff9800;{% elif item.completed %}background: #4caf50;{% else %}background: #ddd;{% endif %}"
                title="{{ item.writing.word }} {% if item.completed %}(å®Œäº†){% endif %}{% if item.teacher_feedback %} - ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ã‚Š{% endif %}">
            </a>
            {% endfor %}
        </div>
        <span style="font-weight: bold; color: #333; margin: 0 1rem;">{{ nav.current }} / {{ nav.total }}</span>

        {% if nav.next_id %}
        <a href="{{ url_for('student_writing', assignment_id=nav.next_id) }}"
            style="padding: 0.5rem 1rem; background: #2196f3; color: white; border: none; border-radius: 6px; text-decoration: none; font-size: 0.9rem;">æ¬¡ã®å•é¡Œ
            â†’</a>
        {% else %}
        <span style="padding: 0.5rem 1rem; background: #ccc; color: white; border-radius: 6px; font-size: 0.9rem;">æ¬¡ã®å•é¡Œ
            â†’</span>
        {% endif %}
    </div>

    {% if assignment.completed %}
    <div class="completion-banner">
        <h3>âœ… ã“ã®å•é¡Œã¯ç·´ç¿’æ¸ˆã¿ã§ã™</h3>
        <div class="completed-date">å®Œäº†æ—¥: {{ assignment.completed_at|jst('%Y/%m/%d %H:%M') }}</div>
        <p style="margin: 0.5rem 0 0; font-size: 0.9rem; color: #666;">å†åº¦ç·´ç¿’ã—ã¦æå‡ºã—ç›´ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
    </div>
    {% endif %}

    {% if assignment.teacher_feedback %}
    <div
        style="margin-bottom: 1rem; padding: 1rem; background: #fff3e0; border: 1px solid #ffcc80; border-radius: 8px;">
        <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem; color: #e65100;">ğŸ’¬ å…ˆç”Ÿã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯:</h4>
        <div>{{ assignment.teacher_feedback }}</div>
    </div>
    {% endif %}

    <div class="writing-card">
        <div class="kanji-display">
            <span class="kanji-large">{{ assignment.writing.word }}</span>
        </div>

        <div class="audio-section">
            <button type="button" class="audio-btn" onclick="speakWord()">ğŸ”Š æ¼¢å­—ã‚’èª­ã‚€</button>
            <button type="button" class="audio-btn" onclick="speakReading()">ğŸ”Š èª­ã¿æ–¹: {{ assignment.writing.reading
                }}</button>
        </div>

        <div class="info-grid">
            <div class="info-box">
                <div class="info-label">èª­ã¿æ–¹</div>
                <div class="info-value reading">{{ assignment.writing.reading }}</div>
            </div>
            <div class="info-box">
                <div class="info-label">æ„å‘³ï¼ˆä¸­å›½èªï¼‰</div>
                <div class="info-value">{{ assignment.writing.meaning }}</div>
            </div>
            {% if assignment.writing.stroke_count %}
            <div class="info-box">
                <div class="info-label">ç”»æ•°</div>
                <div class="info-value">{{ assignment.writing.stroke_count }}ç”»</div>
            </div>
            {% endif %}
        </div>

        <!-- æ›¸ãé †ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆKanjiVGä½¿ç”¨ï¼‰ -->
        <div class="stroke-animation-section">
            <div class="stroke-animation-title">ğŸ“ æ›¸ãé †ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</div>
            <div class="animation-container">
                <div class="kanji-animation-box">
                    <div id="kanji-svg-container">
                        <p class="loading-indicator">æ›¸ãé †ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
            </div>
            <div class="stroke-counter" id="stroke-counter">æº–å‚™ä¸­...</div>
            <div class="animation-controls">
                <button class="anim-btn play" onclick="playAnimation()">â–¶ï¸ å†ç”Ÿ</button>
                <button class="anim-btn step" onclick="nextStroke()">â­ï¸ æ¬¡ã®ç”»</button>
                <button class="anim-btn reset" onclick="resetAnimation()">ğŸ”„ æœ€åˆã‹ã‚‰</button>
            </div>
            <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
                â€» èµ¤ã„ç·šãŒç¾åœ¨ã®ç”»ã§ã™ã€‚KanjiVGãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
            </p>
        </div>

        <!-- ä¾‹æ–‡ -->
        <div class="example-section">
            <div class="example-title">ğŸ“ ä¾‹æ–‡</div>
            <div class="example-text" id="example-text">
                {% if assignment.writing.example %}
                {{ assignment.writing.example }}
                {% else %}
                <span id="generated-example"></span>
                {% endif %}
            </div>
            <button type="button" class="audio-btn" style="margin-top: 1rem; font-size: 0.9rem; padding: 0.5rem 1rem;"
                onclick="speakExample()">
                ğŸ”Š ä¾‹æ–‡ã‚’èª­ã‚€
            </button>
        </div>

        <!-- æ›¸ãæ–¹ã®ãƒã‚¤ãƒ³ãƒˆ -->
        <div class="stroke-guide">
            <div class="stroke-guide-title">âœï¸ æ›¸ãæ–¹ã®ãƒã‚¤ãƒ³ãƒˆ</div>
            <div class="stroke-types">
                <div class="stroke-type">
                    <span class="stroke-icon">â– </span>
                    <div class="stroke-name">æ­¢ã‚ï¼ˆã¨ã‚ï¼‰</div>
                    <div class="stroke-desc">ç­†ã‚’ã—ã£ã‹ã‚Šæ­¢ã‚ã¦çµ‚ã‚ã‚‹</div>
                </div>
                <div class="stroke-type">
                    <span class="stroke-icon">â†—</span>
                    <div class="stroke-name">è·³ã­ï¼ˆã¯ã­ï¼‰</div>
                    <div class="stroke-desc">ç­†ã‚’è·³ã­ä¸Šã’ã¦çµ‚ã‚ã‚‹</div>
                </div>
                <div class="stroke-type">
                    <span class="stroke-icon">ã€œ</span>
                    <div class="stroke-name">æ‰•ã„ï¼ˆã¯ã‚‰ã„ï¼‰</div>
                    <div class="stroke-desc">ç­†ã‚’æ‰•ã£ã¦ç´°ãçµ‚ã‚ã‚‹</div>
                </div>
            </div>
        </div>

        <!-- ä¸­å›½äººå‘ã‘æ³¨æ„ç‚¹ -->
        <div class="attention-section">
            <div class="attention-title">ğŸ‡¨ğŸ‡³ ä¸­å›½äººå­¦ç¿’è€…ã¸ã®æ³¨æ„ç‚¹</div>
            <ul class="attention-list" id="attention-list"></ul>
        </div>

        <!-- ãªãã‚Šç·´ç¿’ -->
        <div class="practice-section">
            <h3 class="practice-title">ğŸ“ ãªãã£ã¦ç·´ç¿’ã—ã‚ˆã†</h3>
            <p style="text-align: center; color: #666; margin-bottom: 1rem;">è–„ã„æ–‡å­—ã‚’ãªãã£ã¦ç·´ç¿’ã—ã¾ã—ã‚‡ã†</p>
            <div class="practice-grid">
                <div class="practice-box-wrapper">
                    <div class="practice-box">
                        <div class="cross-guide"></div>
                        <div class="trace-guide">{{ assignment.writing.word }}</div>
                        <canvas class="practice-canvas" id="canvas1"></canvas>
                    </div>
                    <div class="box-controls">
                        <button class="mini-btn" onclick="undoCanvas(0)">â†©ï¸ æˆ»ã™</button>
                        <button class="mini-btn" onclick="clearCanvas(0)">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="practice-box-wrapper">
                    <div class="practice-box">
                        <div class="cross-guide"></div>
                        <div class="trace-guide">{{ assignment.writing.word }}</div>
                        <canvas class="practice-canvas" id="canvas2"></canvas>
                    </div>
                    <div class="box-controls">
                        <button class="mini-btn" onclick="undoCanvas(1)">â†©ï¸ æˆ»ã™</button>
                        <button class="mini-btn" onclick="clearCanvas(1)">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="practice-box-wrapper">
                    <div class="practice-box">
                        <div class="cross-guide"></div>
                        <div class="trace-guide">{{ assignment.writing.word }}</div>
                        <canvas class="practice-canvas" id="canvas3"></canvas>
                    </div>
                    <div class="box-controls">
                        <button class="mini-btn" onclick="undoCanvas(2)">â†©ï¸ æˆ»ã™</button>
                        <button class="mini-btn" onclick="clearCanvas(2)">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="practice-box-wrapper">
                    <div class="practice-box">
                        <div class="cross-guide"></div>
                        <div class="trace-guide" style="color: transparent;">{{ assignment.writing.word }}</div>
                        <canvas class="practice-canvas" id="canvas4"></canvas>
                    </div>
                    <div class="box-controls">
                        <button class="mini-btn" onclick="undoCanvas(3)">â†©ï¸ æˆ»ã™</button>
                        <button class="mini-btn" onclick="clearCanvas(3)">ğŸ—‘ï¸</button>
                    </div>
                </div>
            </div>
            <div class="canvas-controls">
                <button class="control-btn" onclick="undoAllCanvases()">â†©ï¸ å…¨ã¦1ã¤æˆ»ã™</button>
                <button class="control-btn" onclick="clearAllCanvases()">ğŸ—‘ï¸ å…¨ã¦ã‚¯ãƒªã‚¢</button>
                <button class="control-btn" onclick="toggleGuide()">ğŸ‘ï¸ ã‚¬ã‚¤ãƒ‰è¡¨ç¤ºåˆ‡æ›¿</button>
            </div>
        </div>
    </div>

    <div class="complete-section">
        <p id="validation-message" style="color: #f44336; margin-bottom: 1rem; display: none;">
            âš ï¸ 4ãƒã‚¹å…¨ã¦ã«ç·´ç¿’ã—ã¦ã‹ã‚‰æå‡ºã—ã¦ãã ã•ã„
        </p>
        <form method="POST" id="complete-form" onsubmit="return validateSubmission()">
            <input type="hidden" name="action" value="complete">
            <input type="hidden" name="result_image" id="result-image-input">
            <button type="submit" class="complete-btn">
                {% if assignment.completed %}ğŸ”„ å†æå‡ºã—ã¦æ›´æ–°{% else %}âœ… ç·´ç¿’å®Œäº†ï¼{% endif %}
            </button>
        </form>
    </div>
</div>

<script>
    const word = "{{ assignment.writing.word }}";
    const reading = "{{ assignment.writing.reading }}";
    const strokeCountFromDB = {{ assignment.writing.stroke_count or 0 }};

    // éŸ³å£°èª­ã¿ä¸Šã’
    function speakText(text) {
        if ('speechSynthesis' in window) {
            speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP';
            u.rate = 0.8;
            const voices = speechSynthesis.getVoices();
            const jpVoice = voices.find(v => v.lang.includes('ja'));
            if (jpVoice) u.voice = jpVoice;
            speechSynthesis.speak(u);
        }
    }

    function speakWord() { speakText(word); }
    function speakReading() { speakText(reading); }
    function speakExample() {
        const ex = document.getElementById('example-text').textContent;
        speakText(ex);
    }

    if ('speechSynthesis' in window) {
        speechSynthesis.getVoices();
        speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
    }

    // KanjiVG ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨æ›¸ãé †ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    let strokePaths = [];
    let currentStroke = 0;
    let totalStrokes = 0;
    let animationInterval = null;

    async function loadKanjiVG() {
        const char = word[0];
        const codePoint = char.charCodeAt(0).toString(16).padStart(5, '0');

        // KanjiVG CDNã‹ã‚‰SVGã‚’å–å¾—
        const urls = [
            `https://raw.githubusercontent.com/KanjiVG/kanjivg/master/kanji/${codePoint}.svg`,
            `https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg@master/kanji/${codePoint}.svg`
        ];

        let svgText = null;
        for (const url of urls) {
            try {
                const response = await fetch(url);
                if (response.ok) {
                    svgText = await response.text();
                    break;
                }
            } catch (e) {
                console.log('Failed to fetch from:', url);
            }
        }

        const container = document.getElementById('kanji-svg-container');

        if (svgText) {
            // SVGã‚’ãƒ‘ãƒ¼ã‚¹
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
            const svg = svgDoc.querySelector('svg');

            if (svg) {
                // SVGã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´
                svg.setAttribute('width', '220');
                svg.setAttribute('height', '220');
                svg.setAttribute('id', 'kanji-svg');

                // ã™ã¹ã¦ã®ãƒ‘ã‚¹ã‚’å–å¾—
                const paths = svg.querySelectorAll('path');
                strokePaths = Array.from(paths);
                totalStrokes = strokePaths.length;

                // åˆæœŸçŠ¶æ…‹ï¼šã™ã¹ã¦éè¡¨ç¤º
                strokePaths.forEach(path => {
                    path.style.stroke = '#333';
                    path.style.strokeWidth = '4';
                    path.style.fill = 'none';
                    path.style.opacity = '0';
                });

                container.innerHTML = '';
                container.appendChild(svg);

                updateCounter();
                return;
            }
        }

        // KanjiVGãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        container.innerHTML = `
            <div style="font-size: 120px; font-family: 'Klee One', serif; color: #333;">
                ${char}
            </div>
            <p style="position: absolute; bottom: 5px; font-size: 0.8rem; color: #999;">
                æ›¸ãé †ãƒ‡ãƒ¼ã‚¿ãªã—
            </p>
        `;
        totalStrokes = strokeCountFromDB || 1;
        updateCounter();
    }

    function updateCounter() {
        document.getElementById('stroke-counter').textContent =
            `${currentStroke} / ${totalStrokes} ç”»`;
    }

    function showStrokes(upTo) {
        strokePaths.forEach((path, index) => {
            if (index < upTo) {
                path.style.opacity = '1';
                path.style.stroke = (index === upTo - 1) ? '#e53935' : '#333';
                path.style.strokeWidth = (index === upTo - 1) ? '6' : '4';
            } else {
                path.style.opacity = '0';
            }
        });
    }

    function playAnimation() {
        if (animationInterval) clearInterval(animationInterval);
        currentStroke = 0;
        showStrokes(0);

        animationInterval = setInterval(() => {
            if (currentStroke < totalStrokes) {
                currentStroke++;
                showStrokes(currentStroke);
                updateCounter();
            } else {
                clearInterval(animationInterval);
            }
        }, 600);
    }

    function nextStroke() {
        if (currentStroke < totalStrokes) {
            currentStroke++;
            showStrokes(currentStroke);
            updateCounter();
        }
    }

    function resetAnimation() {
        if (animationInterval) clearInterval(animationInterval);
        currentStroke = 0;
        showStrokes(0);
        updateCounter();
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«KanjiVGãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    loadKanjiVG();

    // ä¾‹æ–‡è‡ªå‹•ç”Ÿæˆ
    {% if not assignment.writing.example %}
    const examples = {
        'å¤©': 'ä»Šæ—¥ã¯å¤©æ°—ãŒã„ã„ã§ã™ã€‚', 'æ°—': 'æ°—ã‚’ã¤ã‘ã¦å¸°ã£ã¦ã­ã€‚', 'ç©º': 'ç©ºãŒã¨ã¦ã‚‚é’ã„ã§ã™ã€‚',
        'å±±': 'å¯Œå£«å±±ã¯æ—¥æœ¬ã§ä¸€ç•ªé«˜ã„å±±ã§ã™ã€‚', 'å·': 'å·ã§æ³³ãã®ã¯æ°—æŒã¡ã„ã„ã€‚', 'æµ·': 'å¤ã¯æµ·ã§æ³³ããŸã„ã§ã™ã€‚',
        'èŠ±': 'æ¡œã®èŠ±ãŒãã‚Œã„ã«å’²ã„ã¦ã„ã¾ã™ã€‚', 'é›¨': 'æ˜æ—¥ã¯é›¨ãŒé™ã‚‹ã§ã—ã‚‡ã†ã€‚', 'é›ª': 'å†¬ã«é›ªãŒé™ã‚Šã¾ã™ã€‚',
        'é¢¨': 'ä»Šæ—¥ã¯é¢¨ãŒå¼·ã„ã§ã™ã€‚', 'ç«': 'ç«ã‚’ä½¿ã†ã¨ãã¯æ³¨æ„ã—ã¦ãã ã•ã„ã€‚', 'æ°´': 'æ°´ã‚’é£²ã‚“ã§ãã ã•ã„ã€‚',
        'åœŸ': 'åœŸã‚’è§¦ã‚‹ã¨æ‰‹ãŒæ±šã‚Œã¾ã™ã€‚', 'é‡‘': 'é‡‘æ›œæ—¥ã«ä¼šã„ã¾ã—ã‚‡ã†ã€‚', 'æœ¨': 'æœ¨ã®ä¸‹ã§ä¼‘ã¿ã¾ã—ã‚‡ã†ã€‚',
        'æ—¥': 'æ—¥æ›œæ—¥ã¯ä¼‘ã¿ã§ã™ã€‚', 'æœˆ': 'æœˆãŒãã‚Œã„ã«è¦‹ãˆã¾ã™ã€‚', 'å¹´': 'æ–°ã—ã„å¹´ãŒå§‹ã¾ã‚Šã¾ã—ãŸã€‚',
        'äºº': 'ãŸãã•ã‚“ã®äººãŒã„ã¾ã™ã€‚', 'å­': 'å­ã©ã‚‚ãŸã¡ãŒéŠã‚“ã§ã„ã¾ã™ã€‚', 'å¥³': 'å¥³ã®äººãŒæ­©ã„ã¦ã„ã¾ã™ã€‚',
        'ç”·': 'ç”·ã®äººãŒèµ°ã£ã¦ã„ã¾ã™ã€‚', 'å­¦': 'æ—¥æœ¬èªã‚’å­¦ã‚“ã§ã„ã¾ã™ã€‚', 'æ ¡': 'å­¦æ ¡ã«è¡Œãã¾ã™ã€‚',
        'å…ˆ': 'å…ˆç”Ÿã«èã„ã¦ãã ã•ã„ã€‚', 'ç”Ÿ': 'ç”Ÿå¾’ãŒæ•™å®¤ã«ã„ã¾ã™ã€‚', 'æœ¬': 'æœ¬ã‚’èª­ã‚€ã®ãŒå¥½ãã§ã™ã€‚',
        'æ–‡': 'æ–‡ã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚', 'å­—': 'å­—ã‚’ãã‚Œã„ã«æ›¸ã„ã¦ãã ã•ã„ã€‚', 'èª': 'æ—¥æœ¬èªã‚’è©±ã›ã¾ã™ã‹ã€‚',
        'èª­': 'æœ¬ã‚’èª­ã¿ã¾ã—ãŸã€‚', 'æ›¸': 'æ‰‹ç´™ã‚’æ›¸ãã¾ã—ãŸã€‚', 'è©±': 'å‹é”ã¨è©±ã—ã¾ã—ãŸã€‚',
        'è': 'éŸ³æ¥½ã‚’èãã¾ã™ã€‚', 'è¦‹': 'ãƒ†ãƒ¬ãƒ“ã‚’è¦‹ã¾ã™ã€‚', 'é£Ÿ': 'æœã”é£¯ã‚’é£Ÿã¹ã¾ã—ãŸã€‚',
        'é£²': 'ãŠèŒ¶ã‚’é£²ã¿ã¾ã—ãŸã€‚', 'è¡Œ': 'å­¦æ ¡ã«è¡Œãã¾ã™ã€‚', 'æ¥': 'å‹é”ãŒæ¥ã¾ã—ãŸã€‚',
        'å¸°': 'å®¶ã«å¸°ã‚Šã¾ã™ã€‚', 'è²·': 'æœ¬ã‚’è²·ã„ã¾ã—ãŸã€‚', 'å£²': 'ãŠåº—ã§å£²ã£ã¦ã„ã¾ã™ã€‚',
        'å…¥': 'éƒ¨å±‹ã«å…¥ã‚Šã¾ã™ã€‚', 'å‡º': 'å¤–ã«å‡ºã¾ã™ã€‚', 'ç«‹': 'ç«‹ã£ã¦ãã ã•ã„ã€‚',
        'åº§': 'åº§ã£ã¦ãã ã•ã„ã€‚', 'èµ°': 'å…¬åœ’ã‚’èµ°ã‚Šã¾ã™ã€‚', 'æ­©': 'é“ã‚’æ­©ãã¾ã™ã€‚',
        'æ­¢': 'ã“ã“ã§æ­¢ã¾ã£ã¦ãã ã•ã„ã€‚', 'ä¼‘': 'å°‘ã—ä¼‘ã¿ã¾ã—ã‚‡ã†ã€‚', 'å¯': 'ã‚‚ã†å¯ã¾ã™ã€‚',
        'èµ·': 'æœæ—©ãèµ·ãã¾ã™ã€‚', 'é–‹': 'ãƒ‰ã‚¢ã‚’é–‹ã‘ã¦ãã ã•ã„ã€‚', 'é–‰': 'çª“ã‚’é–‰ã‚ã¦ãã ã•ã„ã€‚',
        'å§‹': 'æˆæ¥­ãŒå§‹ã¾ã‚Šã¾ã™ã€‚', 'çµ‚': 'æˆæ¥­ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚', 'ä½œ': 'æ–™ç†ã‚’ä½œã‚Šã¾ã™ã€‚',
        'ä½¿': 'ãƒ‘ã‚½ã‚³ãƒ³ã‚’ä½¿ã„ã¾ã™ã€‚', 'åƒ': 'ä¼šç¤¾ã§åƒã„ã¦ã„ã¾ã™ã€‚', 'éŠ': 'å…¬åœ’ã§éŠã³ã¾ã™ã€‚',
        'æ³³': 'ãƒ—ãƒ¼ãƒ«ã§æ³³ãã¾ã™ã€‚', 'ä¹—': 'ãƒã‚¹ã«ä¹—ã‚Šã¾ã™ã€‚', 'é™': 'é›»è»Šã‚’é™ã‚Šã¾ã™ã€‚',
        'å¾…': 'ã“ã“ã§å¾…ã£ã¦ãã ã•ã„ã€‚', 'æŒ': 'è·ç‰©ã‚’æŒã¡ã¾ã™ã€‚', 'é€': 'æ‰‹ç´™ã‚’é€ã‚Šã¾ã™ã€‚',
        'å±Š': 'è·ç‰©ãŒå±Šãã¾ã—ãŸã€‚', 'å±Š': 'è·ç‰©ãŒå±Šãã¾ã—ãŸã€‚', 'å±Š': 'è·ç‰©ãŒå±Šãã¾ã—ãŸã€‚',
        'ä¼š': 'å‹é”ã«ä¼šã„ã¾ã—ãŸã€‚', 'åˆ¥': 'ãŠåˆ¥ã‚Œã‚’è¨€ã„ã¾ã—ãŸã€‚', 'çŸ¥': 'å½¼ã‚’çŸ¥ã£ã¦ã„ã¾ã™ã€‚',
        'æ€': 'ãã†æ€ã„ã¾ã™ã€‚', 'è€ƒ': 'ã‚ˆãè€ƒãˆã¦ãã ã•ã„ã€‚', 'åˆ†': 'æ„å‘³ãŒåˆ†ã‹ã‚Šã¾ã—ãŸã€‚',
        'æ•™': 'æ—¥æœ¬èªã‚’æ•™ãˆã¦ã„ã¾ã™ã€‚', 'ç¿’': 'æ¼¢å­—ã‚’ç¿’ã„ã¾ã™ã€‚', 'è¦š': 'å˜èªã‚’è¦šãˆã¾ã™ã€‚',
        'å¿˜': 'ç´„æŸã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ã€‚', 'ç­”': 'è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚', 'å•': 'å•é¡Œã‚’è§£ãã¾ã™ã€‚',
        'è©¦': 'è©¦é¨“ã‚’å—ã‘ã¾ã™ã€‚', 'åˆ': 'è©¦é¨“ã«åˆæ ¼ã—ã¾ã—ãŸã€‚', 'è½': 'è©¦é¨“ã«è½ã¡ã¾ã—ãŸã€‚',
        'å—': 'æ‰‹ç´™ã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚', 'å–': 'å†™çœŸã‚’å–ã‚Šã¾ã—ãŸã€‚', 'é¸': 'å¥½ããªè‰²ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚',
        'æ±º': 'äºˆå®šã‚’æ±ºã‚ã¾ã—ãŸã€‚', 'å¤‰': 'å¤©æ°—ãŒå¤‰ã‚ã‚Šã¾ã—ãŸã€‚', 'åŒ': 'åŒã˜æ„è¦‹ã§ã™ã€‚',
        'é•': 'ç­”ãˆãŒé•ã„ã¾ã™ã€‚', 'æ­£': 'æ­£ã—ã„ç­”ãˆã§ã™ã€‚', 'é–“': 'é–“é•ãˆã¾ã—ãŸã€‚',
        'æ—©': 'æ—©ãèµ·ãã¦ãã ã•ã„ã€‚', 'é…': 'é…ããªã£ã¦ã™ã¿ã¾ã›ã‚“ã€‚', 'é•·': 'é«ªãŒé•·ã„ã§ã™ã€‚',
        'çŸ­': 'æ™‚é–“ãŒçŸ­ã„ã§ã™ã€‚', 'é«˜': 'å±±ãŒé«˜ã„ã§ã™ã€‚', 'ä½': 'å£°ãŒä½ã„ã§ã™ã€‚',
        'å¤§': 'å¤§ãã„çŠ¬ãŒã„ã¾ã™ã€‚', 'å°': 'å°ã•ã„çŒ«ãŒã„ã¾ã™ã€‚', 'å¤š': 'äººãŒå¤šã„ã§ã™ã€‚',
        'å°‘': 'æ™‚é–“ãŒå°‘ãªã„ã§ã™ã€‚', 'æ–°': 'æ–°ã—ã„æœ¬ã‚’è²·ã„ã¾ã—ãŸã€‚', 'å¤': 'å¤ã„å»ºç‰©ã§ã™ã€‚',
        'è‹¥': 'è‹¥ã„äººãŒå¤šã„ã§ã™ã€‚', 'è€': 'è€äººã‚’åŠ©ã‘ã¾ã—ãŸã€‚', 'æ˜': 'éƒ¨å±‹ãŒæ˜ã‚‹ã„ã§ã™ã€‚',
        'æš—': 'å¤œã¯æš—ã„ã§ã™ã€‚', 'å¼·': 'é¢¨ãŒå¼·ã„ã§ã™ã€‚', 'å¼±': 'ä½“ãŒå¼±ã„ã§ã™ã€‚',
        'é‡': 'è·ç‰©ãŒé‡ã„ã§ã™ã€‚', 'è»½': 'ã‹ã°ã‚“ãŒè»½ã„ã§ã™ã€‚', 'åºƒ': 'éƒ¨å±‹ãŒåºƒã„ã§ã™ã€‚',
        'ç‹­': 'é“ãŒç‹­ã„ã§ã™ã€‚', 'æ·±': 'å·ãŒæ·±ã„ã§ã™ã€‚', 'æµ…': 'ãƒ—ãƒ¼ãƒ«ãŒæµ…ã„ã§ã™ã€‚',
        'ç†±': 'ãŠæ¹¯ãŒç†±ã„ã§ã™ã€‚', 'å†·': 'æ°´ãŒå†·ãŸã„ã§ã™ã€‚', 'æ¸©': 'ãŠé¢¨å‘‚ãŒæ¸©ã‹ã„ã§ã™ã€‚',
        'æ¶¼': 'é¢¨ãŒæ¶¼ã—ã„ã§ã™ã€‚', 'æš–': 'éƒ¨å±‹ãŒæš–ã‹ã„ã§ã™ã€‚', 'å¯’': 'ä»Šæ—¥ã¯å¯’ã„ã§ã™ã€‚',
        'æš‘': 'å¤ã¯æš‘ã„ã§ã™ã€‚', 'ç”˜': 'ã‚±ãƒ¼ã‚­ãŒç”˜ã„ã§ã™ã€‚', 'è¾›': 'ã‚«ãƒ¬ãƒ¼ãŒè¾›ã„ã§ã™ã€‚',
        'è‹¦': 'ã‚³ãƒ¼ãƒ’ãƒ¼ãŒè‹¦ã„ã§ã™ã€‚', 'é…¸': 'ãƒ¬ãƒ¢ãƒ³ãŒé…¸ã£ã±ã„ã§ã™ã€‚', 'å¡©': 'å¡©ã‚’å…¥ã‚Œã™ãã¾ã—ãŸã€‚',
        'ç™½': 'é›ªãŒç™½ã„ã§ã™ã€‚', 'é»’': 'é«ªãŒé»’ã„ã§ã™ã€‚', 'èµ¤': 'ã‚Šã‚“ã”ãŒèµ¤ã„ã§ã™ã€‚',
        'é’': 'ç©ºãŒé’ã„ã§ã™ã€‚', 'é»„': 'ãƒãƒŠãƒŠãŒé»„è‰²ã„ã§ã™ã€‚', 'ç·‘': 'è‘‰ãŒç·‘è‰²ã§ã™ã€‚',
        'è‰²': 'å¥½ããªè‰²ã¯ä½•ã§ã™ã‹ã€‚', 'å½¢': 'ä¸¸ã„å½¢ã§ã™ã€‚', 'éŸ³': 'éŸ³æ¥½ã‚’è´ãã¾ã™ã€‚',
        'å£°': 'å¤§ããªå£°ã§è©±ã—ã¦ãã ã•ã„ã€‚', 'é¡”': 'é¡”ã‚’æ´—ã„ã¾ã—ãŸã€‚', 'é ­': 'é ­ãŒç—›ã„ã§ã™ã€‚',
        'ç›®': 'ç›®ãŒç–²ã‚Œã¾ã—ãŸã€‚', 'è€³': 'è€³ã§èãã¾ã™ã€‚', 'å£': 'å£ã‚’é–‹ã‘ã¦ãã ã•ã„ã€‚',
        'é¼»': 'é¼»ãŒé«˜ã„ã§ã™ã€‚', 'æ­¯': 'æ­¯ã‚’ç£¨ãã¾ã™ã€‚', 'èˆŒ': 'èˆŒãŒç—›ã„ã§ã™ã€‚',
        'é¦–': 'é¦–ãŒç—›ã„ã§ã™ã€‚', 'è‚©': 'è‚©ãŒã“ã‚Šã¾ã—ãŸã€‚', 'è…•': 'è…•ãŒé•·ã„ã§ã™ã€‚',
        'æ‰‹': 'æ‰‹ã‚’æ´—ã„ã¾ã—ã‚‡ã†ã€‚', 'æŒ‡': 'æŒ‡ã‚’å‹•ã‹ã—ã¦ãã ã•ã„ã€‚', 'çˆª': 'çˆªã‚’åˆ‡ã‚Šã¾ã—ãŸã€‚',
        'èƒ¸': 'èƒ¸ãŒç—›ã„ã§ã™ã€‚', 'è…¹': 'ãŠè…¹ãŒç©ºãã¾ã—ãŸã€‚', 'èƒŒ': 'èƒŒãŒé«˜ã„ã§ã™ã€‚',
        'è…°': 'è…°ãŒç—›ã„ã§ã™ã€‚', 'è¶³': 'è¶³ãŒç–²ã‚Œã¾ã—ãŸã€‚', 'è†': 'è†ã‚’æ›²ã’ã¦ãã ã•ã„ã€‚',
        'å¿ƒ': 'å¿ƒã‚’è¾¼ã‚ã¦ä½œã‚Šã¾ã—ãŸã€‚', 'åŠ›': 'åŠ›ã‚’åˆã‚ã›ã¦é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚', 'ä½“': 'ä½“ã‚’å‹•ã‹ã—ã¾ã—ã‚‡ã†ã€‚',
        'ç—…': 'ç—…æ°—ã«ãªã‚Šã¾ã—ãŸã€‚', 'åŒ»': 'åŒ»è€…ã«è¡Œãã¾ã—ãŸã€‚', 'è–¬': 'è–¬ã‚’é£²ã¿ã¾ã—ãŸã€‚',
        'ç—›': 'é ­ãŒç—›ã„ã§ã™ã€‚', 'å…ƒ': 'å…ƒæ°—ã§ã™ã‹ã€‚', 'å¥': 'å¥åº·ãŒå¤§åˆ‡ã§ã™ã€‚',
        'åº·': 'å¥åº·ã«æ°—ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚', 'çˆ¶': 'çˆ¶ã¯ä¼šç¤¾å“¡ã§ã™ã€‚', 'æ¯': 'æ¯ã¯æ–™ç†ãŒä¸Šæ‰‹ã§ã™ã€‚',
        'å…„': 'å…„ã¯å¤§å­¦ç”Ÿã§ã™ã€‚', 'å§‰': 'å§‰ã¯çœ‹è­·å¸«ã§ã™ã€‚', 'å¼Ÿ': 'å¼Ÿã¯ã¾ã å°å­¦ç”Ÿã§ã™ã€‚',
        'å¦¹': 'å¦¹ã¯é«˜æ ¡ç”Ÿã§ã™ã€‚', 'è¦ª': 'è¦ªã«æ„Ÿè¬ã—ã¦ã„ã¾ã™ã€‚', 'å®¶': 'å®¶ã«å¸°ã‚Šã¾ã™ã€‚',
        'æ—': 'å®¶æ—ã¯4äººã§ã™ã€‚', 'å‹': 'å‹é”ã¨éŠã³ã¾ã—ãŸã€‚', 'é”': 'å‹é”ãŒãŸãã•ã‚“ã„ã¾ã™ã€‚'
    };

    const el = document.getElementById('generated-example');
    if (el) {
        let ex = '';
        for (const char of word) {
            if (examples[char]) { ex = examples[char]; break; }
        }
        el.textContent = ex || `ã€Œ${word}ã€ã‚’ä½¿ã£ã¦æ–‡ã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`;
    }
    {% endif %}

    // æ³¨æ„ãƒã‚¤ãƒ³ãƒˆ
    const attentionPoints = {
        'å¤©': ['ä¸Šã®æ¨ªç·šã®ã»ã†ãŒé•·ã„ã§ã™'],
        'å…¥': ['ã€Œäººã€ã¨é–“é•ãˆã‚„ã™ã„'],
        'äºº': ['ã€Œå…¥ã€ã¨é–“é•ãˆã‚„ã™ã„'],
        'é“': ['ã—ã‚“ã«ã‚‡ã†ã¯æœ€å¾Œã«æ›¸ã'],
        'é': ['ã—ã‚“ã«ã‚‡ã†ã¯æœ€å¾Œã«æ›¸ã'],
        'è¿”': ['ã—ã‚“ã«ã‚‡ã†ã¯æœ€å¾Œã«æ›¸ã'],
        'å­¦': ['å­ã®ä¸Šã«ã€Œâºã€ãŒã¤ã'],
        'é»’': ['ä¸‹ã¯ã€Œç¬ã€4ã¤ã®ç‚¹'],
        'ç‚¹': ['ä¸‹ã¯ã€Œç¬ã€4ã¤ã®ç‚¹'],
        'ç†±': ['ä¸‹ã¯ã€Œç¬ã€4ã¤ã®ç‚¹'],
        'è‰': ['è‰ã‹ã‚“ã‚€ã‚Šã¯3ç”»'],
        'èŠ±': ['è‰ã‹ã‚“ã‚€ã‚Šã¯3ç”»'],
        'è‘‰': ['è‰ã‹ã‚“ã‚€ã‚Šã¯3ç”»'],
        'èª¬': ['è¨€ã¹ã‚“ã¯7ç”»'],
        'è©±': ['è¨€ã¹ã‚“ã¯7ç”»'],
        'èª­': ['è¨€ã¹ã‚“ã¯7ç”»'],
        'èª': ['è¨€ã¹ã‚“ã¯7ç”»'],
        'é’': ['æœˆã®ä¸­ã¯2æœ¬ç·š'],
        'ç›´': ['ç›®ã®ä¸­ã¯3æœ¬ç·š'],
        'å…·': ['ç›®ã®ä¸­ã¯2æœ¬ç·š'],
        'ä»¤': ['æœ€å¾Œã¯ç‚¹'],
        'ä»Š': ['æœ€å¾Œã¯ç‚¹'],
        'ä¼š': ['ä¸‹ã¯ã€Œäº‘ã€'],
        'é›²': ['ä¸‹ã¯ã€Œäº‘ã€'],
        'default': ['æ›¸ãé †ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†', 'ã¨ã‚ãƒ»ã¯ã­ãƒ»ã¯ã‚‰ã„ã«æ³¨æ„']
    };

    function showAttention() {
        const list = document.getElementById('attention-list');
        let points = [];
        for (const char of word) {
            if (attentionPoints[char]) {
                points = points.concat(attentionPoints[char].map(p => `ã€Œ${char}ã€: ${p}`));
            }
        }
        if (points.length === 0) points = attentionPoints['default'];
        list.innerHTML = points.map(p => `<li>${p}</li>`).join('');
    }
    showAttention();

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆå±¥æ­´æ©Ÿèƒ½ä»˜ãï¼‰
    const canvases = ['canvas1', 'canvas2', 'canvas3', 'canvas4'].map(id => {
        const canvas = document.getElementById(id);
        const ctx = canvas.getContext('2d');
        return { canvas, ctx, isDrawing: false, lastX: 0, lastY: 0, history: [], currentPath: [] };
    });

    function initCanvas(c) {
        const parent = c.canvas.parentElement;
        c.canvas.width = parent.clientWidth;
        c.canvas.height = parent.clientHeight;
        c.ctx.strokeStyle = '#333';
        c.ctx.lineWidth = Math.max(4, c.canvas.width / 40);
        c.ctx.lineCap = 'round';
        c.ctx.lineJoin = 'round';
    }

    function redrawCanvas(c) {
        c.ctx.clearRect(0, 0, c.canvas.width, c.canvas.height);
        c.ctx.strokeStyle = '#333';
        c.ctx.lineWidth = Math.max(4, c.canvas.width / 40);
        c.ctx.lineCap = 'round';
        c.ctx.lineJoin = 'round';

        // å±¥æ­´ã‚’å†æç”»
        for (const path of c.history) {
            if (path.length < 2) continue;
            c.ctx.beginPath();
            c.ctx.moveTo(path[0].x, path[0].y);
            for (let i = 1; i < path.length; i++) {
                c.ctx.lineTo(path[i].x, path[i].y);
            }
            c.ctx.stroke();
        }
    }

    function setupCanvas(c) {
        const getPos = (e) => {
            const rect = c.canvas.getBoundingClientRect();
            let x, y;
            if (e.touches) { x = e.touches[0].clientX; y = e.touches[0].clientY; }
            else { x = e.clientX; y = e.clientY; }
            return {
                x: (x - rect.left) * (c.canvas.width / rect.width),
                y: (y - rect.top) * (c.canvas.height / rect.height)
            };
        };

        const start = (e) => {
            c.isDrawing = true;
            const pos = getPos(e);
            c.lastX = pos.x;
            c.lastY = pos.y;
            c.currentPath = [{ x: pos.x, y: pos.y }];
        };

        const draw = (e) => {
            if (!c.isDrawing) return;
            const pos = getPos(e);
            c.ctx.beginPath();
            c.ctx.moveTo(c.lastX, c.lastY);
            c.ctx.lineTo(pos.x, pos.y);
            c.ctx.stroke();
            c.lastX = pos.x;
            c.lastY = pos.y;
            c.currentPath.push({ x: pos.x, y: pos.y });
        };

        const stop = () => {
            if (c.isDrawing && c.currentPath.length > 1) {
                c.history.push([...c.currentPath]);
            }
            c.isDrawing = false;
            c.currentPath = [];
        };

        c.canvas.addEventListener('mousedown', start);
        c.canvas.addEventListener('mousemove', draw);
        c.canvas.addEventListener('mouseup', stop);
        c.canvas.addEventListener('mouseout', stop);
        c.canvas.addEventListener('touchstart', (e) => { e.preventDefault(); start(e); }, { passive: false });
        c.canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); }, { passive: false });
        c.canvas.addEventListener('touchend', stop);
    }

    canvases.forEach(c => { initCanvas(c); setupCanvas(c); });
    window.addEventListener('resize', () => canvases.forEach(c => { initCanvas(c); redrawCanvas(c); }));

    // å€‹åˆ¥ã®ã‚­ãƒ£ãƒ³ãƒã‚¹æ“ä½œ
    function undoCanvas(index) {
        const c = canvases[index];
        if (c.history.length > 0) {
            c.history.pop();
            redrawCanvas(c);
        }
    }

    function clearCanvas(index) {
        const c = canvases[index];
        c.history = [];
        c.ctx.clearRect(0, 0, c.canvas.width, c.canvas.height);
    }

    // å…¨ä½“ã®æ“ä½œ
    function undoAllCanvases() {
        canvases.forEach(c => {
            if (c.history.length > 0) {
                c.history.pop();
                redrawCanvas(c);
            }
        });
    }

    function clearAllCanvases() {
        canvases.forEach(c => {
            c.history = [];
            c.ctx.clearRect(0, 0, c.canvas.width, c.canvas.height);
        });
    }

    let guideVisible = true;
    function toggleGuide() {
        guideVisible = !guideVisible;
        document.querySelectorAll('.trace-guide').forEach((el, i) => {
            if (i < 3) el.style.opacity = guideVisible ? '1' : '0';
        });
    }

    // æå‡ºå‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateSubmission() {
        const emptyBoxes = [];
        canvases.forEach((c, index) => {
            if (c.history.length === 0) {
                emptyBoxes.push(index + 1);
            }
        });

        if (emptyBoxes.length > 0) {
            const msg = document.getElementById('validation-message');
            if (msg) {
                msg.style.display = 'block';
                msg.textContent = `âš ï¸ ${emptyBoxes.join('ã€')}ç•ªç›®ã®ãƒã‚¹ã«ç·´ç¿’ã—ã¦ãã ã•ã„ï¼ˆå…¨4ãƒã‚¹å¿…é ˆï¼‰`;
            }
            // ç©ºã®ãƒã‚¹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.querySelector('.practice-section').scrollIntoView({ behavior: 'smooth' });
            return false;
        }

        // ç”»åƒçµåˆå‡¦ç†ï¼š4ã¤ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’1æšã®ç”»åƒã«ã™ã‚‹
        try {
            const w = canvases[0].canvas.width;
            const h = canvases[0].canvas.height;
            const combinedCanvas = document.createElement('canvas');
            combinedCanvas.width = w * 4;
            combinedCanvas.height = h;
            const ctx = combinedCanvas.getContext('2d');

            // èƒŒæ™¯ã‚’ç™½ã«ã™ã‚‹
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);

            canvases.forEach((cObj, i) => {
                // å„ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’æç”»
                ctx.drawImage(cObj.canvas, w * i, 0);

                // åŒºåˆ‡ã‚Šç·š
                if (i > 0) {
                    ctx.beginPath();
                    ctx.moveTo(w * i, 0);
                    ctx.lineTo(w * i, h);
                    ctx.strokeStyle = '#ddd';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            });

            // Base64ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
            const dataURL = combinedCanvas.toDataURL('image/png');
            document.getElementById('result-image-input').value = dataURL;
        } catch (e) {
            console.error('Canvas export error:', e);
            // ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¦ã‚‚æå‡ºã¯ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼ˆãŸã ã—ç”»åƒãªã—ã«ãªã‚‹ï¼‰
        }

        return true;
    }
</script>
{% endblock %}