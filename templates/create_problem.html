{% extends "base.html" %}

{% block title %}å•é¡Œä½œæˆ - ä¸ƒå¤¢å­¦ç¿’{% endblock %}

{% block head %}
<style>
    /* å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ */
    .fullscreen-mode {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        background: white;
        display: flex;
        flex-direction: column;
    }

    .fullscreen-mode .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--bg-card);
        border-bottom: 1px solid var(--border);
    }

    .fullscreen-mode .editor-body {
        flex: 1;
        overflow: auto;
        padding: 16px;
    }

    .fullscreen-mode .ql-editor {
        min-height: calc(100vh - 200px);
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
    .quick-tools {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
        align-items: center;
    }

    .quick-tool {
        padding: 8px 14px;
        border-radius: 20px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        color: var(--text-primary);
        font-size: 0.85rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .quick-tool:hover {
        background: var(--bg-hover);
    }

    .quick-tool.primary-action {
        border-color: var(--primary);
        color: var(--primary);
        font-weight: 600;
        background: rgba(233, 30, 140, 0.05);
    }

    /* éå»å•é¡Œã‚¢ã‚¤ãƒ†ãƒ  */
    .past-problem-item {
        padding: 12px;
        background: var(--bg-hover);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .past-problem-item:hover {
        border-color: var(--primary);
        background: rgba(233, 30, 140, 0.05);
    }

    .past-problem-item:active {
        transform: scale(0.98);
    }

    /* ã‚¨ãƒ‡ã‚£ã‚¿å†…ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ */
    .question-widget {
        border: 2px solid var(--primary);
        background: #f8f9fa;
        padding: 10px;
        margin: 10px 0;
        border-radius: 8px;
        user-select: none;
    }

    .question-widget .widget-header {
        font-weight: bold;
        color: var(--primary);
        margin-bottom: 5px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
    }

    .modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
    }

    .modal-content {
        background: white;
        padding: 24px;
        border-radius: 12px;
        width: 100%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .choice-row {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
        align-items: center;
    }

    .choice-row input[type="text"] {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .remove-choice-btn {
        background: #ff4444;
        color: white;
        border: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="page-header">
        <h1 class="page-title">âœï¸ å•é¡Œä½œæˆ (ãƒ–ãƒ­ãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿)</h1>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
    </div>

    <div class="card">
        <h2 class="card-title">ğŸ“ å•é¡Œè¨­å®š</h2>
        <form id="create-problem-form" method="POST" action="{{ url_for('create_problem') }}">
            <div class="form-group">
                <label class="form-label" for="title">ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input type="text" id="title" name="title" class="form-input" required placeholder="ä¾‹: æ•°å­¦I ç¬¬1ç«  å¾©ç¿’ãƒ†ã‚¹ãƒˆ">
            </div>

            <div class="form-group">
                <label class="form-label" for="deadline">æå‡ºæœŸé™ (ä»»æ„)</label>
                <input type="datetime-local" id="deadline" name="deadline" class="form-input">
            </div>

            <!-- é…ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚° -->
            <div class="form-group">
                <label class="form-label">é…ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="schedule_type" value="immediate" checked
                            style="width: 18px; height: 18px;">
                        <span>ğŸ“¤ ä»Šã™ãé…ä¿¡</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="schedule_type" value="scheduled" style="width: 18px; height: 18px;">
                        <span>â° äºˆç´„é…ä¿¡</span>
                    </label>
                </div>
                <div id="schedule-time-container" style="display: none; margin-top: 0.75rem;">
                    <input type="datetime-local" id="scheduled_at" name="scheduled_at" class="form-input"
                        style="max-width: 280px;">
                </div>
            </div>

            <input type="hidden" id="content" name="content">
            <input type="hidden" name="problem_type" value="mixed">

            <hr style="margin: 2rem 0; border: 0; border-top: 1px solid var(--border);">

            <h2 class="card-title">ğŸ§© å•é¡Œã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h2>
            <div id="form-blocks-container"
                style="display: flex; flex-direction: column; gap: 24px; min-height: 200px; margin-bottom: 2rem;">
                <!-- ã“ã“ã«ãƒ–ãƒ­ãƒƒã‚¯ãŒè¿½åŠ ã•ã‚Œã¾ã™ -->
                <div class="empty-placeholder"
                    style="text-align: center; padding: 40px; color: var(--text-muted); border: 2px dashed var(--border); border-radius: 12px; background: #fafafa;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ—ï¸</div>
                    <div>ä¸‹ã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‹ã‚‰è¦ç´ ã‚’è¿½åŠ ã—ã¦å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„</div>
                </div>
            </div>

            <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ (ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ) -->
            <div class="sticky-toolbar">
                <div class="toolbar-row toolbar-row-1">
                    <button type="button" class="toolbar-btn toolbar-btn-secondary" onclick="addTextBlock()">
                        <span class="btn-icon">ğŸ“</span>
                        <span class="btn-text">èª¬æ˜æ–‡</span>
                    </button>
                    <button type="button" class="toolbar-btn toolbar-btn-secondary" onclick="openPastProblemModal()">
                        <span class="btn-icon">ğŸ“š</span>
                        <span class="btn-text">å¼•ç”¨</span>
                    </button>
                </div>
                <div class="toolbar-row toolbar-row-2">
                    <button type="button" class="toolbar-btn toolbar-btn-primary" onclick="addWidgetBlock('choice')">
                        <span class="btn-icon">ğŸ”´</span>
                        <span class="btn-text">å˜ä¸€</span>
                    </button>
                    <button type="button" class="toolbar-btn toolbar-btn-primary" onclick="addWidgetBlock('checkbox')">
                        <span class="btn-icon">â˜‘ï¸</span>
                        <span class="btn-text">è¤‡æ•°</span>
                    </button>
                    <button type="button" class="toolbar-btn toolbar-btn-primary" onclick="addWidgetBlock('text')">
                        <span class="btn-icon">âœï¸</span>
                        <span class="btn-text">è¨˜è¿°</span>
                    </button>
                </div>
            </div>
            <style>
                .sticky-toolbar {
                    position: sticky;
                    bottom: 16px;
                    background: white;
                    padding: 12px;
                    border-radius: 16px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                    border: 1px solid var(--border);
                    z-index: 100;
                    margin: 0 auto;
                    max-width: 500px;
                }

                .toolbar-row {
                    display: flex;
                    gap: 8px;
                    justify-content: center;
                }

                .toolbar-row-1 {
                    margin-bottom: 8px;
                }

                .toolbar-btn {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 6px;
                    padding: 10px 14px;
                    border-radius: 12px;
                    border: none;
                    font-size: 0.85rem;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.2s;
                    flex: 1;
                    min-width: 0;
                }

                .toolbar-btn-secondary {
                    background: #f5f5f5;
                    color: #333;
                    border: 1px solid #ddd;
                }

                .toolbar-btn-secondary:hover {
                    background: #eee;
                }

                .toolbar-btn-primary {
                    background: linear-gradient(135deg, #e91e8c, #ff6b9d);
                    color: white;
                }

                .toolbar-btn-primary:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(233, 30, 140, 0.3);
                }

                .btn-icon {
                    font-size: 1.1rem;
                }

                /* PC: 1è¡Œã§è¡¨ç¤º */
                @media (min-width: 600px) {
                    .sticky-toolbar {
                        max-width: 700px;
                        padding: 16px 24px;
                    }

                    .toolbar-row {
                        margin-bottom: 0 !important;
                    }

                    .sticky-toolbar {
                        display: flex;
                        gap: 12px;
                        align-items: center;
                    }

                    .toolbar-row-1,
                    .toolbar-row-2 {
                        flex: 1;
                    }

                    .toolbar-btn {
                        padding: 12px 16px;
                    }
                }

                /* æ¥µå°ç”»é¢: ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ */
                @media (max-width: 360px) {
                    .btn-text {
                        display: none;
                    }

                    .toolbar-btn {
                        padding: 12px;
                        min-width: 48px;
                    }

                    .btn-icon {
                        font-size: 1.3rem;
                    }
                }
            </style>

            <!-- é…ä¿¡å…ˆ -->
            <div class="card" style="margin-top: 3rem; background: var(--bg-primary);">
                <h2 class="card-title">ğŸ‘¥ é…ä¿¡å…ˆ</h2>
                {% if students %}
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; cursor: pointer;">
                    <input type="checkbox" id="select-all" style="width: 20px; height: 20px;">
                    <span style="font-weight: 500;">å…¨å“¡ã‚’é¸æŠ</span>
                </label>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px;">
                    {% for student in students %}
                    <label
                        style="display: flex; align-items: center; gap: 8px; padding: 10px; background: white; border-radius: var(--radius-sm); border: 1px solid var(--border); cursor: pointer;">
                        <input type="checkbox" name="students" value="{{ student.id }}" class="student-check"
                            style="width: 18px; height: 18px;">
                        <span style="font-size: 0.9rem;">{{ student.display_name }}</span>
                    </label>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <p>ç”Ÿå¾’ãŒã¾ã ã„ã¾ã›ã‚“</p>
                </div>
                {% endif %}
            </div>

            <div style="text-align: right; margin-top: 2rem; padding-bottom: 4rem;">
                <button type="submit" class="btn btn-success"
                    style="padding: 12px 32px; font-size: 1.1rem; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                    ğŸš€ å•é¡Œã‚’ä½œæˆãƒ»é…ä¿¡ã™ã‚‹
                </button>
            </div>
        </form>
    </div>

    <!-- å•é¡Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="past-problem-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; border-bottom: 1px solid #eee; padding-bottom: 12px;">
                <h3 style="margin:0;">ğŸ“š å•é¡Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h3>
                <button type="button" class="btn btn-secondary btn-sm" onclick="closePastProblemModal()">Ã—</button>
            </div>

            {% if past_problems %}
            <div style="max-height:60vh; overflow-y:auto;">
                {% for p in past_problems %}
                <div class="db-problem-item" data-problem-id="{{ p.id }}">
                    <div class="db-problem-header">
                        <div class="db-problem-info">
                            <div class="db-problem-title">{{ p.title }}</div>
                            <div class="db-problem-meta">
                                ğŸ“… {{ p.created_at|jst('%Y/%m/%d %H:%M') }}
                                {% if p.assigned_students|length > 0 %}
                                ãƒ»ğŸ‘¥ {{ p.assigned_students|length }}äºº
                                {% endif %}
                            </div>
                        </div>
                        <div class="db-problem-actions">
                            <button type="button" class="db-action-btn db-action-insert"
                                onclick="insertPastProblem('{{ p.id }}')" title="å¼•ç”¨">
                                ğŸ“¥
                            </button>
                            <a href="{{ url_for('edit_problem', problem_id=p.id) }}"
                                class="db-action-btn db-action-edit" title="ç·¨é›†">
                                âœï¸
                            </a>
                            <button type="button" class="db-action-btn db-action-delete"
                                onclick="deleteProblemFromModal({{ p.id }}, '{{ p.title|e }}')" title="å‰Šé™¤">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éš ã—è¦ç´ ã¨ã—ã¦æŒã¤ -->
                    <div id="past-content-{{ p.id }}" style="display:none;">{{ p.content|safe }}</div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align:center; padding:2rem; color:#666;">
                éå»ã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚
            </div>
            {% endif %}

            <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #eee; text-align: center;">
                <a href="{{ url_for('manage_problems') }}" class="btn btn-secondary btn-sm">ğŸ“‹ å•é¡Œç®¡ç†ãƒšãƒ¼ã‚¸ã¸</a>
            </div>
        </div>
    </div>

    <style>
        .db-problem-item {
            padding: 12px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .db-problem-item:hover {
            background: #f0f0f0;
            border-color: #ccc;
        }

        .db-problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .db-problem-info {
            flex: 1;
            min-width: 0;
        }

        .db-problem-title {
            font-weight: 600;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .db-problem-meta {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
        }

        .db-problem-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .db-action-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            text-decoration: none;
        }

        .db-action-insert {
            background: #e3f2fd;
            color: #1976d2;
        }

        .db-action-insert:hover {
            background: #bbdefb;
        }

        .db-action-edit {
            background: #fff3e0;
            color: #f57c00;
        }

        .db-action-edit:hover {
            background: #ffe0b2;
        }

        .db-action-delete {
            background: #ffebee;
            color: #d32f2f;
        }

        .db-action-delete:hover {
            background: #ffcdd2;
        }
    </style>
</div>
{% endblock %}

{% block scripts %}
<style>
    .content-block {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        position: relative;
        transition: box-shadow 0.2s;
    }

    .content-block:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .block-controls {
        position: absolute;
        right: 10px;
        top: 10px;
        opacity: 0.3;
        transition: opacity 0.2s;
        display: flex;
        gap: 8px;
    }

    .content-block:hover .block-controls {
        opacity: 1;
    }

    .block-btn {
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 32px;
        height: 32px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .block-btn:hover {
        background: #e0e0e0;
        color: var(--danger);
    }

    .widget-preview {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 8px;
        border: 1px dashed #ccc;
        margin-top: 12px;
    }

    .choice-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 12px;
    }

    .choice-item {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .choice-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }

    .widget-header-input {
        width: 100%;
        padding: 8px;
        font-size: 1rem;
        font-weight: bold;
        color: var(--primary);
        border: 1px solid transparent;
        border-bottom: 1px solid #ddd;
        margin-bottom: 8px;
    }

    .widget-header-input:focus {
        border-color: var(--primary);
        outline: none;
    }
</style>

<script>
    const container = document.getElementById('form-blocks-container');
    let blockCount = 0;

    // åˆæœŸåŒ–ï¼šä½•ã‚‚ãªã„å ´åˆã¯æ¡ˆå†…ã‚’è¡¨ç¤ºã€è¿½åŠ ã•ã‚ŒãŸã‚‰æ¶ˆã™
    const updateEmptyState = () => {
        const placeholder = container.querySelector('.empty-placeholder');
        if (placeholder) {
            // ãƒ–ãƒ­ãƒƒã‚¯ãŒè¿½åŠ ã•ã‚ŒãŸã‚‰ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«
            const hasBlocks = container.querySelectorAll('.content-block').length > 0;
            placeholder.style.display = hasBlocks ? 'none' : 'block';
        }
    };

    function createBlockWrapper(typeIcon, title) {
        const div = document.createElement('div');
        div.className = 'content-block';
        div.innerHTML = `
            <div style="font-weight:bold; color:var(--text-secondary); margin-bottom:12px; display:flex; align-items:center; gap:8px;">
                <span>${typeIcon}</span> ${title}
            </div>
            <div class="block-content"></div>
            <div class="block-controls">
                <button type="button" class="block-btn" onclick="moveBlock(this, -1)" title="ä¸Šã¸">â¬†ï¸</button>
                <button type="button" class="block-btn" onclick="moveBlock(this, 1)" title="ä¸‹ã¸">â¬‡ï¸</button>
                <button type="button" class="block-btn" onclick="deleteBlock(this)" title="å‰Šé™¤">ğŸ—‘ï¸</button>
            </div>
        `;
        return div;
    }

    // ãƒ†ã‚­ã‚¹ãƒˆ(Wordé¢¨)ãƒ–ãƒ­ãƒƒã‚¯è¿½åŠ 
    window.addTextBlock = function () {
        const wrapper = createBlockWrapper('ğŸ“', 'èª¬æ˜æ–‡ãƒ»å•é¡Œæ–‡');
        wrapper.dataset.type = 'text-block';

        const editorId = `quill-${blockCount++}`;
        const editorDiv = document.createElement('div');
        editorDiv.id = editorId;
        editorDiv.style.height = '150px';
        editorDiv.style.background = 'white';
        // è‹¥å¹²ä¸‹ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’ç¢ºä¿
        editorDiv.style.marginBottom = '10px';

        wrapper.querySelector('.block-content').appendChild(editorDiv);
        container.appendChild(wrapper);
        updateEmptyState();

        // QuillåˆæœŸåŒ–
        new Quill(`#${editorId}`, {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['link', 'image', 'clean']
                ]
            },
            placeholder: 'ã“ã“ã«æ–‡ç« ã‚’å…¥åŠ›...'
        });

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    // ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ–ãƒ­ãƒƒã‚¯è¿½åŠ 
    window.addWidgetBlock = function (type) {
        let title = '';
        let icon = '';
        if (type === 'choice') { title = 'é¸æŠå•é¡Œ (å˜ä¸€é¸æŠ)'; icon = 'ğŸ”´'; }
        if (type === 'checkbox') { title = 'é¸æŠå•é¡Œ (è¤‡æ•°é¸æŠ)'; icon = 'â˜‘ï¸'; }
        if (type === 'text') { title = 'è¨˜è¿°å•é¡Œ'; icon = 'âœï¸'; }

        const wrapper = createBlockWrapper(icon, title);
        wrapper.dataset.type = 'widget';
        wrapper.dataset.widgetType = type;

        let contentHtml = '';
        if (type === 'text') {
            contentHtml = `
                <div style="background:#f8f9fa; padding:16px; border-radius:8px;">
                    <label style="font-weight:bold; display:block; margin-bottom:8px;">å•é¡Œæ–‡ãƒ»èª¬æ˜ (ä»»æ„)</label>
                    <textarea class="widget-description-input" placeholder="ã“ã®è§£ç­”æ¬„ã«é–¢ã™ã‚‹èª¬æ˜ã‚„å•é¡Œæ–‡ã‚’å…¥åŠ›..." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; margin-bottom:16px; min-height:60px;"></textarea>
                    
                    <div class="widget-preview">
                        <div style="color:#666; font-size:0.9rem; margin-bottom:8px;">å›ç­”å…¥åŠ›æ¬„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</div>
                        <div style="background:#fff; padding:12px; border:2px solid #ccc; border-radius:4px; height:80px; color:#999; display:flex; align-items:center;">
                            [ã“ã“ã«ç”Ÿå¾’ãŒå›ç­”ã‚’å…¥åŠ›ã™ã‚‹å¤§ããªæ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™]
                        </div>
                    </div>
                </div>
            `;
        } else {
            contentHtml = `
                <div style="background:#f8f9fa; padding:16px; border-radius:8px;">
                     <label style="font-weight:bold; display:block; margin-bottom:8px;">å•é¡Œæ–‡ãƒ»èª¬æ˜ (ä»»æ„)</label>
                    <textarea class="widget-description-input" placeholder="ã“ã®è§£ç­”æ¬„ã«é–¢ã™ã‚‹èª¬æ˜ã‚„å•é¡Œæ–‡ã‚’å…¥åŠ›..." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; margin-bottom:16px; min-height:60px;"></textarea>

                    <label style="font-weight:bold; display:block; margin-bottom:8px;">é¸æŠè‚¢ã‚’è¨­å®š</label>
                    <div class="choice-list">
                        <div class="choice-item">
                            <input type="text" class="choice-input" placeholder="é¸æŠè‚¢ã‚’å…¥åŠ›..." value="ã¯ã„" oninput="updateChoicesData(this)">
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeChoice(this)">Ã—</button>
                        </div>
                        <div class="choice-item">
                            <input type="text" class="choice-input" placeholder="é¸æŠè‚¢ã‚’å…¥åŠ›..." value="ã„ã„ãˆ" oninput="updateChoicesData(this)">
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeChoice(this)">Ã—</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm" style="margin-top:12px;" onclick="addChoice(this)">ï¼‹ é¸æŠè‚¢ã‚’è¿½åŠ </button>
                    
                    <div class="widget-preview" style="margin-top:16px;">
                        <div style="color:#666; font-size:0.9rem; margin-bottom:4px;">ç”Ÿå¾’å´ã®è¡¨ç¤ºãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</div>
                        <div class="preview-area" style="display:flex; flex-direction:column; gap:4px;"></div>
                    </div>
                </div>
            `;
        }

        wrapper.querySelector('.block-content').innerHTML = contentHtml;
        container.appendChild(wrapper);
        updateEmptyState();

        if (type !== 'text') updatePreview(wrapper);
        wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    // é¸æŠè‚¢æ“ä½œ
    window.addChoice = function (btn) {
        const list = btn.parentElement.querySelector('.choice-list');
        const count = list.children.length + 1;
        const div = document.createElement('div');
        div.className = 'choice-item';
        div.innerHTML = `
            <input type="text" class="choice-input" placeholder="é¸æŠè‚¢ã‚’å…¥åŠ›..." oninput="updateChoicesData(this)">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeChoice(this)">Ã—</button>
        `;
        list.appendChild(div);

        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        div.querySelector('input').focus();
        updatePreview(btn.closest('.content-block'));
    };

    window.removeChoice = function (btn) {
        const block = btn.closest('.content-block');
        const list = btn.closest('.choice-list');
        if (list.children.length > 1) {
            btn.closest('.choice-item').remove();
            updatePreview(block);
        } else {
            alert('é¸æŠè‚¢ã¯æœ€ä½1ã¤å¿…è¦ã§ã™ã€‚');
        }
    };

    window.updateChoicesData = function (input) {
        updatePreview(input.closest('.content-block'));
    };

    function updatePreview(block) {
        const type = block.dataset.widgetType;
        const inputs = Array.from(block.querySelectorAll('.choice-input'));
        const previewArea = block.querySelector('.preview-area');
        if (!previewArea) return;

        let html = '';
        inputs.forEach(input => {
            const val = input.value || '(ç©º)';
            // typeIcon
            const mark = type === 'choice' ? 'â­•' : 'â˜‘ï¸';
            html += `
                <div style="padding:10px 16px; background:white; border:1px solid #ddd; border-radius:8px; display:flex; align-items:center; gap:10px;">
                    <span style="font-size:1.2rem;">${mark}</span>
                    <span style="font-weight:500;">${val}</span>
                </div>
            `;
        });
        previewArea.innerHTML = html;

        // ãƒ‡ãƒ¼ã‚¿å±æ€§ã«ä¿å­˜
        const choices = inputs.map(i => i.value).filter(v => v.trim() !== "");
        block.dataset.choices = JSON.stringify(choices);
    }

    // ãƒ–ãƒ­ãƒƒã‚¯æ“ä½œ
    window.moveBlock = function (btn, dir) {
        const block = btn.closest('.content-block');
        if (dir === -1 && block.previousElementSibling && !block.previousElementSibling.classList.contains('empty-placeholder')) {
            block.parentNode.insertBefore(block, block.previousElementSibling);
            block.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else if (dir === 1 && block.nextElementSibling) {
            block.parentNode.insertBefore(block.nextElementSibling, block);
            block.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    };

    window.deleteBlock = function (btn) {
        if (confirm('ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
            const block = btn.closest('.content-block');
            block.classList.add('fade-out'); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°
            block.remove();
            updateEmptyState();
        }
    };

    // é€ä¿¡å‡¦ç†
    document.getElementById('create-problem-form').addEventListener('submit', function (e) {
        const blocks = container.querySelectorAll('.content-block');
        let finalHtml = '';
        let hasContent = false;

        blocks.forEach(block => {
            if (block.dataset.type === 'text-block') {
                const editor = Quill.find(block.querySelector('.ql-container'));
                const html = editor.root.innerHTML;
                if (editor.getText().trim().length > 0 || html.includes('<img')) {
                    finalHtml += `<div class="block-text" style="margin-bottom:1rem;">${html}</div>`;
                    hasContent = true;
                }

            } else if (block.dataset.type === 'widget') {
                const type = block.dataset.widgetType;
                let widgetHtml = '';

                if (type === 'text') {
                    const description = block.querySelector('.widget-description-input')?.value || '';
                    const safeDesc = description.replace(/"/g, '&quot;').replace(/\n/g, '<br>');

                    widgetHtml = `
                    <div class="question-widget" data-widget-type="text" contenteditable="false">
                        <div class="widget-header">âœï¸ è¨˜è¿°å›ç­”æ¬„</div>
                         ${description ? `<div class="widget-description" style="margin-bottom:8px; font-weight:bold;">${safeDesc}</div>` : ''}
                        <div class="widget-active-content">
                            <div style="background:#fff; padding:12px; border:2px solid #ccc; border-radius:4px; height:60px; color:#999; display:flex; align-items:center;">[ã“ã“ã«ç”Ÿå¾’ãŒå›ç­”ã‚’å…¥åŠ›ã™ã‚‹æ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™]</div>
                        </div>
                    </div>`;
                    hasContent = true;
                } else {
                    const choices = block.dataset.choices || '[]';
                    const safeChoices = choices.replace(/"/g, '&quot;');
                    const displayChoices = JSON.parse(choices);
                    const description = block.querySelector('.widget-description-input')?.value || '';
                    const safeDesc = description.replace(/"/g, '&quot;').replace(/\n/g, '<br>');

                    if (displayChoices.length === 0) return; // é¸æŠè‚¢ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

                    let previewList = '';
                    displayChoices.forEach(c => {
                        const mark = type === 'choice' ? 'ğŸ”´' : 'â˜‘ï¸';
                        previewList += `<div style="display:flex; gap:8px; margin-top:4px;"><span style="color:var(--primary)">${mark}</span> ${c}</div>`;
                    });

                    const label = type === 'choice' ? 'ğŸ”´ é¸æŠå›ç­”æ¬„ (å˜ä¸€)' : 'â˜‘ï¸ é¸æŠå›ç­”æ¬„ (è¤‡æ•°)';

                    widgetHtml = `
                    <div class="question-widget" data-widget-type="${type}" data-choices="${safeChoices}" contenteditable="false">
                        <div class="widget-header">${label}</div>
                        ${description ? `<div class="widget-description" style="margin-bottom:8px; font-weight:bold;">${safeDesc}</div>` : ''}
                        <div class="widget-active-content">
                            ${previewList}
                        </div>
                    </div>`;
                    hasContent = true;
                }
                finalHtml += `<div class="block-widget" style="margin: 1.5rem 0;">${widgetHtml}</div>`;
            }
        });

        if (!hasContent) {
            e.preventDefault();
            alert('å•é¡Œã®ä¸­èº«ãŒç©ºã§ã™ã€‚æ–‡ç« ã‚„å›ç­”æ¬„ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        // äºŒé‡é€ä¿¡é˜²æ­¢
        const submitBtn = document.querySelector('#create-problem-form button[type="submit"]');
        if (submitBtn.disabled) {
            e.preventDefault();
            return;
        }
        submitBtn.disabled = true;
        submitBtn.textContent = 'é€ä¿¡ä¸­...';

        document.getElementById('content').value = finalHtml;
    });

    // --- éå»å•å¼•ç”¨ãƒ­ã‚¸ãƒƒã‚¯ ---
    function openPastProblemModal() {
        document.getElementById('past-problem-modal').classList.add('active');
    }

    function closePastProblemModal() {
        document.getElementById('past-problem-modal').classList.remove('active');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰å•é¡Œã‚’å‰Šé™¤
    window.deleteProblemFromModal = async function (problemId, title) {
        if (!confirm(`ã€Œ${title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€» ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚é–¢é€£ã™ã‚‹ã™ã¹ã¦ã®å›ç­”ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
            return;
        }

        try {
            const formData = new FormData();
            const response = await fetch(`/problem/${problemId}/delete`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                // UIã‹ã‚‰å‰Šé™¤
                const item = document.querySelector(`.db-problem-item[data-problem-id="${problemId}"]`);
                if (item) {
                    item.style.transition = 'all 0.3s';
                    item.style.opacity = '0';
                    item.style.transform = 'translateX(-20px)';
                    setTimeout(() => item.remove(), 300);
                }
                alert('å•é¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            } else {
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        } catch (e) {
            console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e);
            alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
    };

    window.insertPastProblem = function (id) {
        const contentDiv = document.getElementById(`past-content-${id}`);
        if (!contentDiv) return;

        const htmlContent = contentDiv.innerHTML;
        parseAndInsert(htmlContent);
        closePastProblemModal();

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€ç•ªä¸‹ã¸
        setTimeout(() => {
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }, 100);
    };

    function parseAndInsert(htmlContent) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;

        // å­è¦ç´ ã‚’èµ°æŸ»ã—ã¦ãƒ–ãƒ­ãƒƒã‚¯åŒ–
        const childNodes = Array.from(tempDiv.childNodes);
        let buffer = document.createElement('div');

        const flushBuffer = () => {
            if (buffer.innerHTML.trim() !== '' && buffer.innerText.trim() !== '') {
                // ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã¨ã—ã¦è¿½åŠ 
                // initTextBlockã¯windowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãªã„ã®ã§ç›´æ¥å®Ÿè£…å‘¼ã³å‡ºã—ãŒå¿…è¦ã€
                // ã¾ãŸã¯addTextBlockã‚’å°‘ã—æ”¹é€ ã—ã¦contentã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
                addTextBlockWithContent(buffer.innerHTML);
            } else if (buffer.querySelector('img')) {
                addTextBlockWithContent(buffer.innerHTML);
            }
            buffer = document.createElement('div'); // Reset
        };

        childNodes.forEach(node => {
            if (node.nodeType === Node.ELEMENT_NODE && (node.classList.contains('question-widget') || (node.querySelector && node.querySelector('.question-widget')))) {
                flushBuffer();
                let widget = node.classList.contains('question-widget') ? node : node.querySelector('.question-widget');

                if (widget) {
                    const type = widget.dataset.widgetType;
                    const choices = JSON.parse(widget.dataset.choices || '[]');
                    // èª¬æ˜æ–‡ã®æŠ½å‡º
                    const descDiv = widget.querySelector('.widget-description');
                    let description = '';
                    if (descDiv) {
                        description = descDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n');
                        const txt = document.createElement('textarea');
                        txt.innerHTML = description;
                        description = txt.value;
                    }
                    // initWidgetBlockç›¸å½“ã®å‡¦ç†
                    addWidgetBlock(type, choices, description);
                }
            } else if (node.nodeType === Node.ELEMENT_NODE && node.classList.contains('block-widget')) {
                flushBuffer();
                let widget = node.querySelector('.question-widget');
                if (widget) {
                    const type = widget.dataset.widgetType;
                    const choices = JSON.parse(widget.dataset.choices || '[]');
                    const descDiv = widget.querySelector('.widget-description');
                    let description = '';
                    if (descDiv) {
                        description = descDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n');
                        const txt = document.createElement('textarea');
                        txt.innerHTML = description;
                        description = txt.value;
                    }
                    addWidgetBlock(type, choices, description);
                }
            } else if (node.nodeType === Node.ELEMENT_NODE && node.classList.contains('block-text')) {
                flushBuffer();
                addTextBlockWithContent(node.innerHTML);
            } else {
                buffer.appendChild(node.cloneNode(true));
            }
        });
        flushBuffer();
    }

    // ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯è¿½åŠ ï¼ˆå†…å®¹æŒ‡å®šç‰ˆï¼‰
    function addTextBlockWithContent(initialContent) {
        const wrapper = createBlockWrapper('ğŸ“', 'èª¬æ˜æ–‡ãƒ»å•é¡Œæ–‡');
        wrapper.dataset.type = 'text-block';

        const editorId = `quill-${blockCount++}`;
        const editorDiv = document.createElement('div');
        editorDiv.id = editorId;
        editorDiv.style.height = '150px';
        editorDiv.style.background = 'white';
        editorDiv.style.marginBottom = '10px';
        editorDiv.innerHTML = initialContent; // åˆæœŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„

        wrapper.querySelector('.block-content').appendChild(editorDiv);
        container.appendChild(wrapper);
        updateEmptyState();

        new Quill(`#${editorId}`, {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['link', 'image', 'clean']
                ]
            },
            placeholder: 'ã“ã“ã«æ–‡ç« ã‚’å…¥åŠ›...'
        });
    }

    // addWidgetBlockã®æ‹¡å¼µ (å¼•æ•°ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹)
    // æ—¢å­˜ã® window.addWidgetBlock ã‚’ä¸Šæ›¸ã
    const originalAddWidgetBlock = window.addWidgetBlock;
    window.addWidgetBlock = function (type, choices = null, description = null) {
        // nullãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ (æ–°è¦ä½œæˆæ™‚)
        if (!choices) {
            if (type === 'choice' || type === 'checkbox') choices = ['ã¯ã„', 'ã„ã„ãˆ'];
            else choices = [];
        }
        if (description === null) description = '';

        // ä»¥ä¸‹ã€å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†åˆ©ç”¨ã—ãŸã„ãŒã€initWidgetBlockã¨ã—ã¦åˆ†é›¢ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€å†å®Ÿè£…ã™ã‚‹å½¢ã«ãªã‚‹ã€‚
        // DRYã®ãŸã‚ã«æ—¢å­˜ã®é–¢æ•°ã®ä¸­èº«ã‚’ã“ã“ã«ç§»è¨­ã—ã¦çµ±åˆã™ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆã ãŒã€
        // ä»Šå›ã¯æ—¢å­˜é–¢æ•°ã‚’ç½®ãæ›ãˆã‚‹å½¢ã§å®Ÿè£…ã™ã‚‹ã€‚

        let title = '';
        let icon = '';
        if (type === 'choice') { title = 'é¸æŠå•é¡Œ (å˜ä¸€é¸æŠ)'; icon = 'ğŸ”´'; }
        if (type === 'checkbox') { title = 'é¸æŠå•é¡Œ (è¤‡æ•°é¸æŠ)'; icon = 'â˜‘ï¸'; }
        if (type === 'text') { title = 'è¨˜è¿°å•é¡Œ'; icon = 'âœï¸'; }

        const wrapper = createBlockWrapper(icon, title);
        wrapper.dataset.type = 'widget';
        wrapper.dataset.widgetType = type;

        let contentHtml = '';
        if (type === 'text') {
            contentHtml = `
                <div style="background:#f8f9fa; padding:16px; border-radius:8px;">
                    <label style="font-weight:bold; display:block; margin-bottom:8px;">å•é¡Œæ–‡ãƒ»èª¬æ˜ (ä»»æ„)</label>
                    <textarea class="widget-description-input" placeholder="ã“ã®è§£ç­”æ¬„ã«é–¢ã™ã‚‹èª¬æ˜ã‚„å•é¡Œæ–‡ã‚’å…¥åŠ›..." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; margin-bottom:16px; min-height:60px;">${description}</textarea>
                    
                    <div class="widget-preview">
                        <div style="color:#666; font-size:0.9rem; margin-bottom:8px;">å›ç­”å…¥åŠ›æ¬„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</div>
                        <div style="background:#fff; padding:12px; border:2px solid #ccc; border-radius:4px; height:80px; color:#999; display:flex; align-items:center;">
                            [ã“ã“ã«ç”Ÿå¾’ãŒå›ç­”ã‚’å…¥åŠ›ã™ã‚‹å¤§ããªæ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™]
                        </div>
                    </div>
                </div>
            `;
        } else {
            let choiceItems = '';
            choices.forEach((c) => {
                choiceItems += `
                <div class="choice-item">
                    <input type="text" class="choice-input" placeholder="é¸æŠè‚¢ã‚’å…¥åŠ›..." value="${c}" oninput="updateChoicesData(this)">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeChoice(this)">Ã—</button>
                </div>`;
            });

            contentHtml = `
                <div style="background:#f8f9fa; padding:16px; border-radius:8px;">
                     <label style="font-weight:bold; display:block; margin-bottom:8px;">å•é¡Œæ–‡ãƒ»èª¬æ˜ (ä»»æ„)</label>
                    <textarea class="widget-description-input" placeholder="ã“ã®è§£ç­”æ¬„ã«é–¢ã™ã‚‹èª¬æ˜ã‚„å•é¡Œæ–‡ã‚’å…¥åŠ›..." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; margin-bottom:16px; min-height:60px;">${description}</textarea>

                    <label style="font-weight:bold; display:block; margin-bottom:8px;">é¸æŠè‚¢ã‚’è¨­å®š</label>
                    <div class="choice-list">
                        ${choiceItems}
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm" style="margin-top:12px;" onclick="addChoice(this)">ï¼‹ é¸æŠè‚¢ã‚’è¿½åŠ </button>
                    
                    <div class="widget-preview" style="margin-top:16px;">
                        <div style="color:#666; font-size:0.9rem; margin-bottom:4px;">ç”Ÿå¾’å´ã®è¡¨ç¤ºãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</div>
                        <div class="preview-area" style="display:flex; flex-direction:column; gap:4px;"></div>
                    </div>
                </div>
            `;
        }

        wrapper.querySelector('.block-content').innerHTML = contentHtml;
        container.appendChild(wrapper);
        updateEmptyState();

        if (type !== 'text') updatePreview(wrapper);
        wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };



    // åˆæœŸçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
    document.addEventListener('DOMContentLoaded', () => {
        updateEmptyState();

        // --- é…ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ‡ã‚Šæ›¿ãˆ ---
        const scheduleRadios = document.querySelectorAll('input[name="schedule_type"]');
        const scheduleContainer = document.getElementById('schedule-time-container');

        scheduleRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.value === 'scheduled') {
                    scheduleContainer.style.display = 'block';
                } else {
                    scheduleContainer.style.display = 'none';
                }
            });
        });

        // --- å…¨å“¡é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ ---
        const selectAll = document.getElementById('select-all');
        const studentChecks = document.querySelectorAll('.student-check');

        if (selectAll) {
            selectAll.addEventListener('change', function () {
                studentChecks.forEach(cb => cb.checked = this.checked);
            });
        }
    });
</script>
{% endblock %}