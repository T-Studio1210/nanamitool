{% extends "base.html" %}

{% block title %}é€£çµ¡äº‹é …ç®¡ç† - çŸ³å·ä¸ƒå¤¢è¬›å¸«å°‚ç”¨å­¦ç¿’ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="page-header">
        <h1 class="page-title">ğŸ“¢ é€£çµ¡äº‹é …ç®¡ç†</h1>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">â† æˆ»ã‚‹</a>
    </div>

    <!-- æ–°è¦ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="card" style="margin-bottom: 1.5rem;">
        <h2 class="card-title">âœï¸ æ–°ã—ã„é€£çµ¡äº‹é …ã‚’æŠ•ç¨¿</h2>
        <form id="announcement-form" method="POST" action="{{ url_for('create_announcement') }}">
            <div class="form-group">
                <label class="form-label" for="title">ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input type="text" id="title" name="title" class="form-input" placeholder="ä¾‹: å†¬æœŸè¬›ç¿’ã«ã¤ã„ã¦" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="content">å†…å®¹</label>
                <div class="editor-container" style="min-height: 150px;">
                    <div id="announcement-editor"></div>
                </div>
                <input type="hidden" id="announcement-content" name="content">
            </div>

            <!-- é…ä¿¡å…ˆé¸æŠ -->
            <div class="form-group">
                <label class="form-label">é…ä¿¡å…ˆ</label>

                <div style="margin-bottom: 0.75rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="is_global" name="is_global" style="width: 18px; height: 18px;">
                        <span style="font-weight: 500;">ğŸ“£ å…¨å“¡ã«é…ä¿¡</span>
                    </label>
                </div>

                <div id="student-selection"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem;">
                    {% for student in students %}
                    <label class="student-checkbox"
                        style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer;">
                        <input type="checkbox" name="students" value="{{ student.id }}" class="student-check"
                            style="width: 16px; height: 16px;">
                        <span style="font-size: 0.875rem;">{{ student.display_name }}</span>
                    </label>
                    {% endfor %}
                </div>
                {% if not students %}
                <p style="color: var(--text-muted); font-size: 0.875rem;">ç”Ÿå¾’ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                {% endif %}
            </div>

            <!-- é…ä¿¡æ™‚é–“è¨­å®š -->
            <div class="form-group">
                <label class="form-label">é…ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="schedule_type" value="immediate" checked
                            style="width: 18px; height: 18px;">
                        <span>ğŸ“¤ ä»Šã™ãé…ä¿¡</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="schedule_type" value="scheduled" style="width: 18px; height: 18px;">
                        <span>â° äºˆç´„é…ä¿¡</span>
                    </label>
                </div>
                <div id="schedule-time-container" style="display: none; margin-top: 0.75rem;">
                    <input type="datetime-local" id="scheduled_at" name="scheduled_at" class="form-input"
                        style="max-width: 280px;">
                </div>
            </div>

            <button type="submit" class="btn btn-primary">ğŸ“¤ æŠ•ç¨¿</button>
        </form>
    </div>

    <!-- é€£çµ¡äº‹é …ä¸€è¦§ -->
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 class="card-title" style="margin:0;">ğŸ“‹ é€£çµ¡äº‹é …ä¸€è¦§</h2>
            <button type="button" class="btn btn-danger btn-sm" onclick="confirmBulkDelete()" id="bulk-delete-btn"
                style="display:none;">é¸æŠã—ãŸé€£çµ¡ã‚’å‰Šé™¤</button>
        </div>

        {% if announcements %}
        <form id="bulk-delete-form" action="{{ url_for('bulk_delete_announcements') }}" method="POST">
            <div class="problem-list" style="margin-top: 1rem;">
                {% for announcement in announcements %}
                <div class="problem-card" style="cursor: default; position: relative;">
                    <div style="position:absolute; top:12px; left:12px;">
                        <input type="checkbox" name="announcement_ids" value="{{ announcement.id }}" class="bulk-check"
                            style="width:18px; height:18px;" onchange="toggleBulkBtn()">
                    </div>
                    <div class="problem-header" style="padding-left: 2rem;">
                        <h3 class="problem-title">{{ announcement.title }}</h3>
                        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                            {% if announcement.is_global %}
                            <span class="status-badge" style="background: rgba(233, 30, 140, 0.2); color: #e91e8c;">ğŸ“£
                                å…¨å“¡</span>
                            {% else %}
                            <span class="status-badge status-submitted">ğŸ‘¥ {{ announcement.recipients|length }}äºº</span>
                            {% endif %}
                            {% if announcement.is_active %}
                            <span class="status-badge status-reviewed">âœ“ è¡¨ç¤ºä¸­</span>
                            {% else %}
                            <span class="status-badge status-pending">éè¡¨ç¤º</span>
                            {% endif %}
                            <span class="problem-date">{{ announcement.created_at|jst }}</span>
                        </div>
                    </div>
                    <div style="margin: 0.75rem 0; padding-left: 2rem;">
                        <div class="ql-editor" style="padding:0;">{{ announcement.content|safe }}</div>
                    </div>
                    <!-- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è©³ç´°è¡¨ç¤º -->
                    {% set reactions = announcement.reactions.all() %}
                    {% if reactions %}
                    <div style="padding-left: 2rem; margin-bottom: 0.75rem;">
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem;">ğŸ“Š ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è©³ç´°:
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            {% for r in reactions %}
                            <span
                                style="background: var(--bg-hover); padding: 4px 8px; border-radius: 12px; font-size: 0.75rem;">
                                {% if r.reaction_type == 'seen' %}ğŸ‘€{% elif r.reaction_type == 'like' %}ğŸ‘{% elif
                                r.reaction_type == 'thanks' %}ğŸ™{% else %}{{ r.reaction_type }}{% endif %}
                                {{ r.student.display_name }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div
                        style="padding-left: 2rem; margin-bottom: 0.75rem; font-size: 0.8rem; color: var(--text-muted);">
                        ğŸ“Š ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãªã—
                    </div>
                    {% endif %}
                    <div style="display: flex; gap: 0.5rem; padding-left: 2rem;">
                        <form method="POST"
                            action="{{ url_for('toggle_announcement', announcement_id=announcement.id) }}"
                            style="display: inline;">
                            <button type="submit" class="btn btn-secondary btn-sm">
                                {% if announcement.is_active %}ğŸ‘ï¸ éè¡¨ç¤º{% else %}ğŸ‘ï¸ è¡¨ç¤º{% endif %}
                            </button>
                        </form>
                        <div style="display:inline;">
                            <button type="button" class="btn btn-danger btn-sm"
                                onclick="if(confirmDelete('ã“ã®é€£çµ¡äº‹é …ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { document.getElementById('single-delete-form-{{ announcement.id }}').submit(); }">
                                ğŸ—‘ï¸ å‰Šé™¤
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </form>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <p>ã¾ã é€£çµ¡äº‹é …ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>
        {% endif %}
    </div>
</div>

{% for announcement in announcements %}
<form id="single-delete-form-{{ announcement.id }}" method="POST"
    action="{{ url_for('delete_announcement', announcement_id=announcement.id) }}" style="display: none;"></form>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Quillã‚¨ãƒ‡ã‚£ã‚¿åˆæœŸåŒ–
        const quill = new Quill('#announcement-editor', {
            theme: 'snow',
            placeholder: 'é€£çµ¡äº‹é …ã®å†…å®¹ã‚’å…¥åŠ›...',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['link'],
                    ['clean']
                ]
            }
        });

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«ã‚¨ãƒ‡ã‚£ã‚¿å†…å®¹ã‚’ã‚»ãƒƒãƒˆ
        const form = document.getElementById('announcement-form');
        if (form) {
            form.addEventListener('submit', function (e) {
                const content = quill.root.innerHTML;
                if (quill.getText().trim().length === 0) {
                    e.preventDefault();
                    alert('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return false;
                }
                document.getElementById('announcement-content').value = content;

                // äºŒé‡é€ä¿¡é˜²æ­¢
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn.disabled) {
                    e.preventDefault();
                    return false;
                }
                submitBtn.disabled = true;
                submitBtn.textContent = 'é€ä¿¡ä¸­...';
            });
        }

        const isGlobalCheckbox = document.getElementById('is_global');
        const studentSelection = document.getElementById('student-selection');
        const studentChecks = document.querySelectorAll('.student-check');

        isGlobalCheckbox.addEventListener('change', function () {
            if (this.checked) {
                studentSelection.style.opacity = '0.5';
                studentSelection.style.pointerEvents = 'none';
                studentChecks.forEach(check => check.checked = false);
            } else {
                studentSelection.style.opacity = '1';
                studentSelection.style.pointerEvents = 'auto';
            }
        });

        // äºˆç´„é…ä¿¡ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        const scheduleRadios = document.querySelectorAll('input[name="schedule_type"]');
        const scheduleTimeContainer = document.getElementById('schedule-time-container');

        scheduleRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.value === 'scheduled') {
                    scheduleTimeContainer.style.display = 'block';
                } else {
                    scheduleTimeContainer.style.display = 'none';
                }
            });
        });
    });


    function toggleBulkBtn() {
        const checks = document.querySelectorAll('.bulk-check:checked');
        const btn = document.getElementById('bulk-delete-btn');
        if (checks.length > 0) {
            btn.style.display = 'block';
            btn.textContent = `${checks.length}ä»¶ã‚’å‰Šé™¤`;
        } else {
            btn.style.display = 'none';
        }
    }

    function confirmBulkDelete() {
        if (confirm('é¸æŠã—ãŸé€£çµ¡äº‹é …ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            document.getElementById('bulk-delete-form').submit();
        }
    }
</script>
{% endblock %}