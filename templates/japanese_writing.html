{% extends "base.html" %}

{% block title %}æ¼¢å­—æ›¸ãå–ã‚Š - ä¸ƒå¤¢å­¦ç¿’ã‚¢ãƒ—ãƒª{% endblock %}

{% block head %}
<style>
    .kanji-display {
        font-size: 8rem;
        text-align: center;
        color: #e0e0e0;
        font-family: 'Noto Sans JP', sans-serif;
        line-height: 1;
        margin: 20px 0;
        user-select: none;
    }

    .canvas-container {
        position: relative;
        width: 300px;
        height: 300px;
        margin: 0 auto;
        border: 3px solid var(--primary);
        border-radius: 16px;
        background: white;
        touch-action: none;
    }

    .canvas-container canvas {
        position: absolute;
        top: 0;
        left: 0;
        border-radius: 13px;
    }

    #guide-canvas {
        z-index: 1;
        pointer-events: none;
    }

    #draw-canvas {
        z-index: 2;
    }

    .controls {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .reading-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        background: linear-gradient(135deg, #e91e8c 0%, #c4177a 100%);
        color: white;
        border-radius: 24px;
        font-size: 1.3rem;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .reading-badge:hover {
        transform: scale(1.05);
    }

    .meaning-box {
        text-align: center;
        padding: 12px;
        background: var(--bg-hover);
        border-radius: 12px;
        margin: 16px 0;
    }

    .stroke-hint {
        text-align: center;
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-top: 12px;
    }

    .nav-arrows {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">âœï¸ æ¼¢å­—æ›¸ãå–ã‚Š</h1>
    <a href="{{ url_for('japanese_dashboard') }}" class="btn btn-secondary btn-sm">â† æˆ»ã‚‹</a>
</div>

<div class="card">
    <p style="text-align: center;">æ¼¢å­—ã‚’ãªãã£ã¦æ›¸ãæ–¹ã‚’ç·´ç¿’ã—ã‚ˆã†ï¼èª­ã¿æ–¹ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨éŸ³å£°ã§èã‘ã‚‹ã‚ˆ ğŸ”Š</p>

    <!-- èª­ã¿æ–¹ã¨éŸ³å£° -->
    <div style="text-align: center; margin: 20px 0;">
        <div class="reading-badge" onclick="speakReading('{{ kanji.reading }}')">
            ğŸ”Š {{ kanji.reading }}
        </div>
    </div>

    <!-- æ¼¢å­—ã‚¬ã‚¤ãƒ‰ã¨ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
    <div class="canvas-container" id="canvas-container">
        <canvas id="guide-canvas" width="300" height="300"></canvas>
        <canvas id="draw-canvas" width="300" height="300"></canvas>
    </div>

    <p class="stroke-hint">ğŸ‘† ä¸Šã®æ¼¢å­—ã‚’ãªãã£ã¦ã­</p>

    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="controls">
        <button class="btn btn-secondary" onclick="clearCanvas()">ğŸ—‘ï¸ æ¶ˆã™</button>
        <button class="btn btn-primary" onclick="speakReading('{{ kanji.reading }}')">ğŸ”Š èª­ã¿æ–¹</button>
    </div>

    <!-- æ„å‘³ -->
    <div class="meaning-box">
        <div style="font-size: 1.1rem; font-weight: 600;">ğŸ‡¨ğŸ‡³ {{ kanji.meaning }}</div>
        <div style="margin-top: 8px; color: var(--text-secondary);">ğŸ“ {{ kanji.example }}</div>
    </div>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="nav-arrows">
        <a href="{{ url_for('japanese_writing', index=prev_index) }}" class="btn btn-secondary">â¬…ï¸ å‰</a>
        <span style="color: var(--text-muted);">{{ current_index + 1 }} / {{ total }}</span>
        <a href="{{ url_for('japanese_writing', index=next_index) }}" class="btn btn-primary">æ¬¡ â¡ï¸</a>
    </div>
</div>

<script>
    const canvas = document.getElementById('draw-canvas');
    const ctx = canvas.getContext('2d');
    const guideCanvas = document.getElementById('guide-canvas');
    const guideCtx = guideCanvas.getContext('2d');

    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;

    // ã‚¬ã‚¤ãƒ‰æ¼¢å­—ã‚’æç”»
    function drawGuide() {
        guideCtx.clearRect(0, 0, 300, 300);
        guideCtx.font = '200px "Noto Sans JP", sans-serif';
        guideCtx.fillStyle = '#e0e0e0';
        guideCtx.textAlign = 'center';
        guideCtx.textBaseline = 'middle';
        guideCtx.fillText('{{ kanji.word }}', 150, 160);

        // åå­—ç·šã‚¬ã‚¤ãƒ‰
        guideCtx.strokeStyle = '#f0f0f0';
        guideCtx.lineWidth = 1;
        guideCtx.setLineDash([5, 5]);
        guideCtx.beginPath();
        guideCtx.moveTo(150, 0);
        guideCtx.lineTo(150, 300);
        guideCtx.moveTo(0, 150);
        guideCtx.lineTo(300, 150);
        guideCtx.stroke();
        guideCtx.setLineDash([]);
    }

    // æç”»è¨­å®š
    ctx.strokeStyle = '#e91e8c';
    ctx.lineWidth = 8;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    // ã‚¿ãƒƒãƒ/ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;

        if (e.touches) {
            return {
                x: (e.touches[0].clientX - rect.left) * scaleX,
                y: (e.touches[0].clientY - rect.top) * scaleY
            };
        }
        return {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY
        };
    }

    function startDraw(e) {
        e.preventDefault();
        isDrawing = true;
        const pos = getPos(e);
        lastX = pos.x;
        lastY = pos.y;
    }

    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();

        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        lastX = pos.x;
        lastY = pos.y;
    }

    function endDraw() {
        isDrawing = false;
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseleave', endDraw);

    canvas.addEventListener('touchstart', startDraw, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', endDraw);

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªã‚¢
    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // éŸ³å£°èª­ã¿ä¸Šã’
    function speakReading(text) {
        if ('speechSynthesis' in window) {
            // æ—¢å­˜ã®éŸ³å£°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.8;
            utterance.pitch = 1;

            // æ—¥æœ¬èªéŸ³å£°ã‚’æ¢ã™
            const voices = speechSynthesis.getVoices();
            const japaneseVoice = voices.find(v => v.lang.includes('ja'));
            if (japaneseVoice) {
                utterance.voice = japaneseVoice;
            }

            speechSynthesis.speak(utterance);
        } else {
            alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èª­ã¿ä¸Šã’ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
        }
    }

    // éŸ³å£°ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
    if ('speechSynthesis' in window) {
        speechSynthesis.getVoices();
        speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
    }

    // åˆæœŸåŒ–
    drawGuide();
</script>
{% endblock %}