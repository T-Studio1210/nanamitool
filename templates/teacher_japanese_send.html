{% extends "base.html" %}

{% block title %}å•é¡Œé…ä¿¡ - ä¸ƒå¤¢å­¦ç¿’ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ“¤ æ—¥æœ¬èªå•é¡Œã‚’é…ä¿¡</h1>
    <a href="{{ url_for('teacher_japanese_problems') }}" class="btn btn-secondary btn-sm">â† æˆ»ã‚‹</a>
</div>

<div class="card">
    <h2 class="card-title">ğŸ“¦ é…ä¿¡ã™ã‚‹å•é¡Œã‚’é¸æŠï¼ˆè¤‡æ•°ã‚¿ã‚¤ãƒ—å¯ï¼‰</h2>

    <form method="POST" action="{{ url_for('send_japanese_quiz') }}">
        <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
        <div style="margin-bottom: 20px; border-bottom: 2px solid #eee; display: flex; gap: 0;">
            <button type="button" class="content-tab active" onclick="switchContentTab('quizzes')"
                style="background: none; border: none; padding: 12px 20px; font-size: 1rem; font-weight: bold; cursor: pointer; border-bottom: 3px solid #e91e8c; color: #e91e8c;">
                ğŸ¯ ã‚¯ã‚¤ã‚º ({{ quizzes|length }})
            </button>
            <button type="button" class="content-tab" onclick="switchContentTab('flashcards')"
                style="background: none; border: none; padding: 12px 20px; font-size: 1rem; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; color: #888;">
                ğŸ“– ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ ({{ flashcards|length }})
            </button>
            <button type="button" class="content-tab" onclick="switchContentTab('writings')"
                style="background: none; border: none; padding: 12px 20px; font-size: 1rem; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; color: #888;">
                âœï¸ æ›¸ãå–ã‚Š ({{ writings|length }})
            </button>
        </div>

        <!-- ã‚¯ã‚¤ã‚ºä¸€è¦§ -->
        <div id="tab-quizzes" class="content-panel">
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label class="form-label" style="margin: 0;">ğŸ¯ ç†Ÿèªã‚¯ã‚¤ã‚º</label>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="selectAll('quiz_ids')">å…¨é¸æŠ</button>
                </div>
                <div
                    style="max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                    {% for quiz in quizzes %}
                    <label
                        style="display: flex; align-items: center; gap: 10px; padding: 8px; cursor: pointer; border-bottom: 1px solid var(--border);">
                        <input type="checkbox" name="quiz_ids" value="{{ quiz.id }}" style="width: 20px; height: 20px;">
                        <strong style="font-size: 1.2rem;">{{ quiz.word }}</strong>
                        <span style="color: var(--text-muted);">ï¼ˆ{{ quiz.correct_reading }}ï¼‰</span>
                        <span style="color: var(--text-secondary); font-size: 0.9rem;">ğŸ‡¨ğŸ‡³ {{ quiz.meaning_chinese
                            }}</span>
                    </label>
                    {% endfor %}
                    {% if not quizzes %}
                    <p style="text-align: center; color: var(--text-muted); padding: 20px;">
                        ã‚¯ã‚¤ã‚ºãŒã‚ã‚Šã¾ã›ã‚“ã€‚<a href="{{ url_for('teacher_japanese_generate') }}">AIã§å•é¡Œã‚’ç”Ÿæˆ</a>ã—ã¦ãã ã•ã„ã€‚
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
        <div id="tab-flashcards" class="content-panel" style="display: none;">
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label class="form-label" style="margin: 0;">ğŸ“– ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</label>
                    <button type="button" class="btn btn-secondary btn-sm"
                        onclick="selectAll('flashcard_ids')">å…¨é¸æŠ</button>
                </div>
                <div
                    style="max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                    {% for card in flashcards %}
                    <label
                        style="display: flex; align-items: center; gap: 10px; padding: 8px; cursor: pointer; border-bottom: 1px solid var(--border);">
                        <input type="checkbox" name="flashcard_ids" value="{{ card.id }}"
                            style="width: 20px; height: 20px;">
                        <strong style="font-size: 1.2rem;">{{ card.word }}</strong>
                        <span style="color: var(--text-muted);">ï¼ˆ{{ card.reading }}ï¼‰</span>
                        <span style="color: var(--text-secondary); font-size: 0.9rem;">{{ card.meaning }}</span>
                    </label>
                    {% endfor %}
                    {% if not flashcards %}
                    <p style="text-align: center; color: var(--text-muted); padding: 20px;">
                        ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<a href="{{ url_for('teacher_flashcard_manage') }}">ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ç®¡ç†</a>ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- æ›¸ãå–ã‚Šä¸€è¦§ -->
        <div id="tab-writings" class="content-panel" style="display: none;">
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label class="form-label" style="margin: 0;">âœï¸ æ›¸ãå–ã‚Šç·´ç¿’</label>
                    <button type="button" class="btn btn-secondary btn-sm"
                        onclick="selectAll('writing_ids')">å…¨é¸æŠ</button>
                </div>
                <div
                    style="max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                    {% for writing in writings %}
                    <label
                        style="display: flex; align-items: center; gap: 10px; padding: 8px; cursor: pointer; border-bottom: 1px solid var(--border);">
                        <input type="checkbox" name="writing_ids" value="{{ writing.id }}"
                            style="width: 20px; height: 20px;">
                        <strong style="font-size: 1.2rem;">{{ writing.word }}</strong>
                        <span style="color: var(--text-muted);">ï¼ˆ{{ writing.reading }}ï¼‰</span>
                        <span style="color: var(--text-secondary); font-size: 0.9rem;">{{ writing.meaning }}</span>
                    </label>
                    {% endfor %}
                    {% if not writings %}
                    <p style="text-align: center; color: var(--text-muted); padding: 20px;">
                        æ›¸ãå–ã‚Šç·´ç¿’ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<a href="{{ url_for('teacher_writing_manage') }}">æ›¸ãå–ã‚Šç®¡ç†</a>ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- é¸æŠæ•°è¡¨ç¤º -->
        <div id="selection-summary"
            style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 12px; border-radius: 8px; margin: 16px 0; display: none;">
            <strong>é¸æŠä¸­:</strong> <span id="selected-quizzes">0</span>å•ã®ã‚¯ã‚¤ã‚º + <span
                id="selected-flashcards">0</span>æšã®ã‚«ãƒ¼ãƒ‰ + <span id="selected-writings">0</span>å•ã®æ›¸ãå–ã‚Š
        </div>

        <!-- ç”Ÿå¾’é¸æŠ -->
        <div class="form-group" style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label class="form-label" style="margin: 0;">é…ä¿¡å…ˆã®ç”Ÿå¾’</label>
                <button type="button" class="btn btn-secondary btn-sm"
                    onclick="selectAll('student_ids')">å…¨ç”Ÿå¾’ã‚’é¸æŠ</button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                {% for student in chinese_students %}
                <label
                    style="display: flex; align-items: center; gap: 8px; padding: 10px; background: var(--bg-hover); border-radius: 8px; cursor: pointer;">
                    <input type="checkbox" name="student_ids" value="{{ student.id }}"
                        style="width: 18px; height: 18px;">
                    <span>ğŸ‡¨ğŸ‡³ {{ student.display_name }}</span>
                </label>
                {% endfor %}

                {% if not chinese_students %}
                <p style="grid-column: span 2; text-align: center; color: var(--text-muted); padding: 20px;">
                    ä¸­å›½äººç”Ÿå¾’ãŒã„ã¾ã›ã‚“ã€‚<a href="{{ url_for('manage_students') }}">ç”Ÿå¾’ç®¡ç†</a>ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
                </p>
                {% endif %}
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-block" style="margin-top: 20px;" {% if not chinese_students
            %}disabled{% endif %}>
            ğŸ“¤ é¸æŠã—ãŸå•é¡Œã‚’é…ä¿¡
        </button>
    </form>
</div>

<!-- æœ€è¿‘ã®é…ä¿¡å±¥æ­´ -->
{% if recent_assignments %}
<div class="card">
    <h2 class="card-title">ğŸ“‹ æœ€è¿‘ã®é…ä¿¡ï¼ˆã‚¯ã‚¤ã‚ºï¼‰</h2>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 2px solid var(--border);">
                <th style="text-align: left; padding: 10px;">å•é¡Œ</th>
                <th style="text-align: left; padding: 10px;">ç”Ÿå¾’</th>
                <th style="text-align: left; padding: 10px;">çŠ¶æ…‹</th>
                <th style="text-align: left; padding: 10px;">é…ä¿¡æ—¥</th>
            </tr>
        </thead>
        <tbody>
            {% for assignment in recent_assignments %}
            <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 10px;"><strong>{{ assignment.quiz.word }}</strong></td>
                <td style="padding: 10px;">{{ assignment.student.display_name }}</td>
                <td style="padding: 10px;">
                    {% if assignment.completed %}
                    {% if assignment.is_correct %}
                    <span class="status-badge" style="background: #e8f5e9; color: #1b5e20;">âœ… æ­£è§£</span>
                    {% else %}
                    <span class="status-badge" style="background: #ffebee; color: #b71c1c;">âŒ ä¸æ­£è§£</span>
                    {% endif %}
                    {% else %}
                    <span class="status-badge status-pending">â³ æœªå›ç­”</span>
                    {% endif %}
                </td>
                <td style="padding: 10px; color: var(--text-muted);">{{ assignment.assigned_at|jst('%m/%d %H:%M') }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
    function switchContentTab(tabName) {
        // ãƒ‘ãƒãƒ«åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.content-panel').forEach(el => el.style.display = 'none');
        document.getElementById('tab-' + tabName).style.display = 'block';

        // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«
        document.querySelectorAll('.content-tab').forEach(btn => {
            btn.style.color = '#888';
            btn.style.borderBottomColor = 'transparent';
        });

        // ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
        event.target.style.color = '#e91e8c';
        event.target.style.borderBottomColor = '#e91e8c';
    }

    function selectAll(name) {
        document.querySelectorAll('input[name="' + name + '"]').forEach(cb => cb.checked = true);
        updateSelectionSummary();
    }

    function updateSelectionSummary() {
        const quizCount = document.querySelectorAll('input[name="quiz_ids"]:checked').length;
        const flashcardCount = document.querySelectorAll('input[name="flashcard_ids"]:checked').length;
        const writingCount = document.querySelectorAll('input[name="writing_ids"]:checked').length;

        document.getElementById('selected-quizzes').textContent = quizCount;
        document.getElementById('selected-flashcards').textContent = flashcardCount;
        document.getElementById('selected-writings').textContent = writingCount;

        const summary = document.getElementById('selection-summary');
        if (quizCount + flashcardCount + writingCount > 0) {
            summary.style.display = 'block';
        } else {
            summary.style.display = 'none';
        }
    }

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’ç›£è¦–
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', updateSelectionSummary);
        });
    });
</script>
{% endblock %}