{% extends "base.html" %}

{% block title %}æ—¥æœ¬èªå•é¡Œç®¡ç† - ä¸ƒå¤¢å­¦ç¿’ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èªå­¦ç¿’ç®¡ç†</h1>
</div>


<!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
<div style="margin-bottom: 20px; border-bottom: 2px solid #eee; display: flex; gap: 20px;">
    <button class="tab-btn active" onclick="switchTab('problems')"
        style="background: none; border: none; padding: 10px 0; font-size: 1.1rem; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent;">
        ğŸ¯ ç†Ÿèªã‚¯ã‚¤ã‚ºç®¡ç†
    </button>
    <button class="tab-btn" onclick="switchTab('feedback')"
        style="background: none; border: none; padding: 10px 0; font-size: 1.1rem; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; color: #888;">
        ğŸ’¬ ç”Ÿå¾’ã®è©•ä¾¡ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    </button>
</div>

<!-- ã‚¿ãƒ–1: å•é¡Œç®¡ç† -->
<div id="tab-problems" class="tab-content">
    <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
    <div class="card" style="margin-bottom: 16px; padding: 12px;">
        <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
            <a href="{{ url_for('teacher_kanji_list') }}" class="btn btn-secondary btn-sm">ğŸ“š æ¼¢å­—ä¸€è¦§</a>
            <a href="{{ url_for('teacher_japanese_problems') }}" class="btn btn-primary btn-sm">ğŸ¯ ç†Ÿèªã‚¯ã‚¤ã‚º</a>
            <a href="{{ url_for('teacher_flashcard_manage') }}" class="btn btn-secondary btn-sm">ğŸ“– ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</a>
            <a href="{{ url_for('teacher_writing_manage') }}" class="btn btn-secondary btn-sm">âœï¸ æ›¸ãå–ã‚Š</a>
            <a href="{{ url_for('teacher_japanese_send') }}" class="btn btn-secondary btn-sm">ğŸ“¤ ç”Ÿå¾’ã«é…ä¿¡</a>
        </div>
    </div>

    <!-- ç†Ÿèªã‚¯ã‚¤ã‚ºç®¡ç† -->
    <div class="card" style="margin-bottom: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
            <h2 class="card-title" style="margin: 0;">ğŸ¯ ç†Ÿèªã‚¯ã‚¤ã‚º ({{ problems|length }}å•)</h2>
            <div style="display: flex; gap: 8px;">
                <a href="{{ url_for('teacher_kanji_list') }}" class="btn btn-primary btn-sm">ğŸ“š æ¼¢å­—ã‹ã‚‰ä½œæˆ</a>
                <a href="{{ url_for('teacher_japanese_generate') }}" class="btn btn-secondary btn-sm">âœ¨ AIã§ç”Ÿæˆ</a>
            </div>
        </div>
    </div>

    <!-- é¸æŠã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã®ä¸€æ‹¬æ“ä½œãƒãƒ¼ -->
    <div id="bulk-actions" class="card"
        style="display: none; margin-bottom: 16px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-color: #2196f3;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
            <div>
                <strong id="selected-count">0</strong>å•ã‚’é¸æŠä¸­
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button type="button" class="btn btn-primary btn-sm" onclick="showSendModal()">
                    ğŸ“¤ é¸æŠã—ãŸå•é¡Œã‚’é…ä¿¡
                </button>
                <button type="button" class="btn btn-danger btn-sm" onclick="bulkDelete()">
                    ğŸ—‘ï¸ é¸æŠã—ãŸå•é¡Œã‚’å‰Šé™¤
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="clearSelection()">
                    âœ– é¸æŠè§£é™¤
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        {% if problems %}
        <div style="margin-bottom: 12px; display: flex; gap: 12px;">
            <button type="button" class="btn btn-secondary btn-sm" onclick="execSelectAll()">å…¨é¸æŠ</button>
            <button type="button" class="btn btn-secondary btn-sm" onclick="execClearSelection()">å…¨è§£é™¤</button>
        </div>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid var(--border);">
                    <th style="text-align: center; padding: 12px; width: 40px;">
                        <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this)"
                            style="width: 18px; height: 18px;">
                    </th>
                    <th style="text-align: left; padding: 12px;">ç†Ÿèª</th>
                    <th style="text-align: left; padding: 12px;">èª­ã¿æ–¹</th>
                    <th style="text-align: left; padding: 12px;">ä¸­å›½èª</th>
                    <th style="text-align: left; padding: 12px;">ã‚«ãƒ†ã‚´ãƒª</th>
                    <th style="text-align: right; padding: 12px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for prob in problems %}
                <tr style="border-bottom: 1px solid var(--border);" data-problem-id="{{ prob.id }}">
                    <td style="text-align: center; padding: 12px;">
                        <input type="checkbox" class="problem-checkbox" value="{{ prob.id }}"
                            onchange="updateBulkActions()" style="width: 18px; height: 18px;">
                    </td>
                    <td style="padding: 12px;">
                        <strong style="font-size: 1.2rem;">{{ prob.word }}</strong>
                    </td>
                    <td style="padding: 12px;">{{ prob.correct_reading }}</td>
                    <td style="padding: 12px; color: var(--text-secondary);">{{ prob.meaning_chinese }}</td>
                    <td style="padding: 12px;">
                        <span class="status-badge">{{ prob.category }}</span>
                    </td>
                    <td style="padding: 12px; text-align: right;">
                        <button type="button" class="btn btn-secondary btn-sm"
                            onclick="showEditModal({{ prob.id }}, '{{ prob.word }}', '{{ prob.correct_reading }}', '{{ prob.meaning_chinese|e }}', '{{ prob.example|e }}')">
                            âœï¸ ç·¨é›†
                        </button>
                        <form method="POST" action="{{ url_for('delete_japanese_problem', problem_id=prob.id) }}"
                            style="display: inline;">
                            <button type="submit" class="btn btn-danger btn-sm"
                                onclick="return confirm('ã€Œ{{ prob.word }}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">
                                ğŸ—‘ï¸
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <p>ã¾ã å•é¡ŒãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
            <a href="{{ url_for('teacher_kanji_list') }}" class="btn btn-primary" style="margin-top: 1rem;">
                ğŸ“š æ¼¢å­—ã‹ã‚‰å•é¡Œã‚’ä½œæˆ
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- ã‚¿ãƒ–2: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç®¡ç† -->
<div id="tab-feedback" class="tab-content" style="display: none;">
    <div class="feedback-container">
        {% for group in grouped_tasks %}
        <div class="feedback-group" style="margin-bottom: 24px;">
            <!-- ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="feedback-group-header"
                style="background: #f8f9fa; padding: 12px 16px; border-radius: 8px 8px 0 0; border: 1px solid #e0e0e0; border-bottom: none; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 1.1rem; color: #2c3e50; font-weight: bold;">
                    ğŸ‘¤ {{ group.student_name }}
                </h3>
                <span
                    style="font-size: 0.9rem; color: #666; background: #fff; padding: 4px 8px; border-radius: 12px; border: 1px solid #ddd;">
                    ğŸ“… {{ group.date|jst('%Y/%m/%d %H:%M') }} é…ä¿¡ã®èª²é¡Œç¾¤
                </span>
            </div>

            <div class="feedback-group-content"
                style="border: 1px solid #e0e0e0; border-radius: 0 0 8px 8px; padding: 16px; background: #fff;">
                {% for task in group.tasks %}
                <div class="feedback-card" data-type="{{ task.type }}"
                    style="border-left: 5px solid #ccc; background: #fafafa; padding: 1rem; margin-bottom: 12px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">

                    <div class="task-info"
                        style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.8rem; flex-wrap: wrap;">
                        <span class="task-type-badge"
                            style="font-size: 0.8rem; padding: 3px 6px; border-radius: 4px; font-weight: bold; 
                            {% if task.type == 'quiz' %}background: #e1bee7; color: #4a148c;{% elif task.type == 'flashcard' %}background: #c5cae9; color: #1a237e;{% elif task.type == 'writing' %}background: #b2dfdb; color: #004d40;{% endif %}">
                            {% if task.type == 'quiz' %}ğŸ¯ ã‚¯ã‚¤ã‚º
                            {% elif task.type == 'flashcard' %}ğŸ“– ã‚«ãƒ¼ãƒ‰
                            {% elif task.type == 'writing' %}âœï¸ æ›¸ãå–ã‚Š{% endif %}
                        </span>
                        <span class="task-title" style="font-weight: bold; font-size: 1rem;">{{ task.title }}</span>

                        <span style="margin-left: auto; font-size: 0.85rem; color: #888;">
                            å®Œäº†: {{ task.completed_at|jst('%H:%M') }}
                        </span>

                        <span class="task-status"
                            style="font-size: 0.9rem; color: #4caf50; font-weight: bold; margin-left: 8px;">
                            {% if task.status == 'correct' %}âœ… æ­£è§£
                            {% elif task.status == 'incorrect' %}âŒ ä¸æ­£è§£
                            {% elif task.status == 'learned' %}âœ… è¦šãˆãŸ
                            {% else %}âœ… å®Œäº†{% endif %}
                        </span>
                    </div>

                    <!-- æ›¸ãå–ã‚Šç”»åƒè¡¨ç¤º -->
                    {% if task.type == 'writing' and task.result_image %}
                    <div
                        style="margin: 10px 0; text-align: center; background: #fff; padding: 10px; border: 1px solid #eee; border-radius: 4px;">
                        <img src="{{ task.result_image }}" alt="æ›¸ãå–ã‚Šçµæœ"
                            style="max-width: 100%; max-height: 150px; border: 1px solid #ddd; border-radius: 4px; cursor: zoom-in; transition: transform 0.2s;"
                            onclick="showImageModal(this.src)" onmouseover="this.style.transform='scale(1.02)'"
                            onmouseout="this.style.transform='scale(1)'">
                        <p style="font-size: 0.75rem; color: #aaa; margin: 4px 0 0 0;">ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ‹¡å¤§ç¢ºèª</p>
                    </div>
                    {% endif %}

                    <form action="{{ url_for('save_feedback') }}" method="POST" class="feedback-form">
                        <input type="hidden" name="type" value="{{ task.type }}">
                        <input type="hidden" name="id" value="{{ task.id }}">
                        <div class="feedback-input-group" style="display: flex; gap: 0.5rem; align-items: flex-start;">
                            <textarea name="feedback" placeholder="å…ˆç”Ÿã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..." rows="1"
                                style="flex: 1; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; resize: vertical; min-height: 40px; font-family: inherit;">{{ task.feedback or '' }}</textarea>
                            <button type="submit" class="save-btn"
                                style="background: #2196f3; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9rem;">ä¿å­˜</button>
                        </div>
                    </form>
                </div>
                {% endfor %}
            </div>

            <!-- ä¸€æ‹¬ä¿å­˜ã‚¨ãƒªã‚¢ -->
            <!-- ä¸€æ‹¬ä¿å­˜ã‚¨ãƒªã‚¢ -->
            <div class="feedback-group-footer"
                style="padding: 12px 16px; background: #f8f9fa; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px; display: flex; justify-content: flex-end; align-items: center; gap: 12px;">
                <span style="font-size: 0.85rem; color: #666;">ï¼ˆå€‹åˆ¥ã®ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã•ãªãã¦ã‚‚ã€ã“ã‚Œã§ã™ã¹ã¦ä¿å­˜ã§ãã¾ã™ï¼‰</span>
                <button type="button" class="btn btn-secondary" onclick="fillGroupFeedback(this)">
                    ğŸ“ ä¸€æ‹¬å…¥åŠ›
                </button>
                <button type="button" class="btn btn-primary" onclick="saveGroupFeedback(this)">
                    ğŸ’¾ ä¸€æ‹¬ä¿å­˜
                </button>
            </div>
        </div>
        <script>
            // ã‚«ãƒ¼ãƒ‰ã®å·¦æ ç·šè‰²ã‚’è¨­å®š
            (function () {
                const groups = document.querySelectorAll('.feedback-card');
                groups.forEach(card => {
                    const type = card.dataset.type;
                    if (type === 'quiz') card.style.borderLeftColor = '#9c27b0';
                    else if (type === 'flashcard') card.style.borderLeftColor = '#3f51b5';
                    else if (type === 'writing') card.style.borderLeftColor = '#009688';
                });
            })();
        </script>
        {% else %}
        <p class="no-data"
            style="text-align: center; color: #666; padding: 2rem; background: #f5f5f5; border-radius: 8px;">
            å®Œäº†æ¸ˆã¿ã®èª²é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        {% endfor %}
    </div>
</div>

<!-- ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="image-modal"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; cursor: pointer;"
    onclick="this.style.display='none'">
    <img id="modal-image" src=""
        style="max-width: 90%; max-height: 90vh; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); background: white;">
</div>

<script>
    function showImageModal(src) {
        document.getElementById('modal-image').src = src;
        document.getElementById('image-modal').style.display = 'flex';
    }

    function fillGroupFeedback(btn) {
        const text = prompt('ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®å…¨ã¦ã®èª²é¡Œã«å…¥åŠ›ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:\nï¼ˆæ—¢å­˜ã®å…¥åŠ›ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰');
        if (text === null) return;

        const groupDiv = btn.closest('.feedback-group');
        const textareas = groupDiv.querySelectorAll('textarea[name="feedback"]');
        textareas.forEach(ta => ta.value = text);
    }

    function saveGroupFeedback(btn) {
        const groupDiv = btn.closest('.feedback-group');
        const forms = groupDiv.querySelectorAll('.feedback-form');
        const data = [];

        forms.forEach(form => {
            const formData = new FormData(form);
            data.push({
                type: formData.get('type'),
                id: formData.get('id'),
                feedback: formData.get('feedback')
            });
        });

        if (data.length === 0) return;

        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = 'â³ ä¿å­˜ä¸­...';

        fetch('/teacher/feedback/save_bulk', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ feedbacks: data })
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    btn.textContent = 'âœ… ä¿å­˜å®Œäº†ï¼';
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 2000);
                } else {
                    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                btn.disabled = false;
                btn.textContent = originalText;
            });
    }
</script>

<script>
    function switchTab(tabName) {
        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.getElementById('tab-' + tabName).style.display = 'block';

        // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            btn.style.color = '#888';
            btn.style.borderBottomColor = 'transparent';
        });

        // ã‚¯ãƒªãƒƒã‚¯ã—ãŸãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ï¼ˆevent.targetã ã¨ã†ã¾ãã„ã‹ãªã„å ´åˆãŒã‚ã‚‹ã®ã§ã€é †åºä¾å­˜ã¾ãŸã¯ã‚¯ãƒ©ã‚¹ã§åˆ¶å¾¡æ¨å¥¨ã ãŒã€ã“ã“ã§ã¯ç°¡æ˜“å®Ÿè£…ï¼‰
        // ç°¡æ˜“çš„ã«DOMã‹ã‚‰æ¢ã™
        const btns = document.querySelectorAll('.tab-btn');
        if (tabName === 'problems') {
            btns[0].style.color = 'var(--primary, #e91e8c)';
            btns[0].style.borderBottomColor = 'var(--primary, #e91e8c)';
        } else {
            btns[1].style.color = 'var(--primary, #e91e8c)';
            btns[1].style.borderBottomColor = 'var(--primary, #e91e8c)';
        }
    }

    // åˆæœŸã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
    const activeBtn = document.querySelector('.tab-btn.active');
    if (activeBtn) {
        activeBtn.style.color = 'var(--primary, #e91e8c)';
        activeBtn.style.borderBottomColor = 'var(--primary, #e91e8c)';
    }

    // ... æ—¢å­˜ã®scripté–¢æ•° ...
</script>

<!-- ä¸€æ‹¬é…ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="send-modal"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h2 class="card-title">ğŸ“¤ é¸æŠã—ãŸå•é¡Œã‚’é…ä¿¡</h2>
        <form id="send-form" method="POST" action="{{ url_for('bulk_send_japanese_quiz') }}">
            <input type="hidden" name="quiz_ids" id="send-quiz-ids">

            <div class="form-group">
                <label class="form-label">é¸æŠã—ãŸå•é¡Œï¼ˆ<span id="send-count">0</span>å•ï¼‰</label>
                <div id="send-problem-list"
                    style="background: var(--bg-hover); padding: 12px; border-radius: 8px; max-height: 150px; overflow-y: auto;">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">é…ä¿¡å…ˆã®ç”Ÿå¾’</label>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                    {% for student in chinese_students %}
                    <label
                        style="display: flex; align-items: center; gap: 8px; padding: 10px; background: var(--bg-hover); border-radius: 8px; cursor: pointer;">
                        <input type="checkbox" name="student_ids" value="{{ student.id }}"
                            style="width: 18px; height: 18px;" checked>
                        <span>ğŸ‡¨ğŸ‡³ {{ student.display_name }}</span>
                    </label>
                    {% endfor %}
                    {% if not chinese_students %}
                    <p style="grid-column: span 2; text-align: center; color: var(--text-muted); padding: 20px;">
                        ä¸­å›½äººç”Ÿå¾’ãŒã„ã¾ã›ã‚“ã€‚<a href="{{ url_for('manage_students') }}">ç”Ÿå¾’ç®¡ç†</a>ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
                    </p>
                    {% endif %}
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" {% if not chinese_students %}disabled{% endif %}>
                    ğŸ“¤ é…ä¿¡ã™ã‚‹
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeSendModal()">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </form>
    </div>
</div>

<!--ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="edit-modal"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h2 class="card-title">âœï¸ å•é¡Œã‚’ç·¨é›†</h2>
        <form id="edit-form" method="POST" action="{{ url_for('edit_japanese_problem') }}">
            <input type="hidden" name="problem_id" id="edit-problem-id">

            <div class="form-group">
                <label class="form-label">ç†Ÿèª</label>
                <input type="text" name="word" id="edit-word" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">èª­ã¿æ–¹</label>
                <input type="text" name="correct_reading" id="edit-reading" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">ä¸­å›½èªã®æ„å‘³</label>
                <input type="text" name="meaning_chinese" id="edit-meaning" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">ä¾‹æ–‡</label>
                <input type="text" name="example" id="edit-example" class="form-input">
            </div>

            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary">
                    ğŸ’¾ ä¿å­˜
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </form>
    </div>
</div>

<!--ä¸€æ‹¬å‰Šé™¤ãƒ•ã‚©ãƒ¼ãƒ (hidden) -->


<!-- æ‰‹å‹•è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="card">
    <h2 class="card-title">â• æ‰‹å‹•ã§å•é¡Œã‚’è¿½åŠ </h2>

    <form method="POST" action="{{ url_for('add_japanese_problem') }}">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">ç†Ÿèªï¼ˆæ¼¢å­—ï¼‰</label>
                <input type="text" name="word" class="form-input" placeholder="ä¾‹: å‹‰å¼·" required>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">æ­£ã—ã„èª­ã¿æ–¹</label>
                <input type="text" name="correct_reading" class="form-input" placeholder="ä¾‹: ã¹ã‚“ãã‚‡ã†" required>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">é–“é•ã„é¸æŠè‚¢1</label>
                <input type="text" name="wrong1" class="form-input" placeholder="ä¾‹: ã¹ã‚“ãã‚ˆã†" required>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">é–“é•ã„é¸æŠè‚¢2</label>
                <input type="text" name="wrong2" class="form-input" placeholder="ä¾‹: ã¹ã‚“ãã‚…ã†" required>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">é–“é•ã„é¸æŠè‚¢3</label>
                <input type="text" name="wrong3" class="form-input" placeholder="ä¾‹: ã¹ã‚“ã“ã†" required>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">ä¸­å›½èªã®æ„å‘³</label>
                <input type="text" name="meaning_chinese" class="form-input" placeholder="ä¾‹: å­¦ä¹  xuÃ©xÃ­">
            </div>
        </div>
        <div class="form-group" style="margin-top: 12px;">
            <label class="form-label">ä¾‹æ–‡</label>
            <input type="text" name="example" class="form-input" placeholder="ä¾‹: æ¯æ—¥æ—¥æœ¬èªã‚’å‹‰å¼·ã—ã¾ã™ã€‚">
        </div>
        <button type="submit" class="btn btn-primary btn-block">
            â• å•é¡Œã‚’è¿½åŠ 
        </button>
    </form>
</div>

<!-- ä¸€æ‹¬å‰Šé™¤ãƒ•ã‚©ãƒ¼ãƒ (hidden) - JSã‹ã‚‰æ“ä½œ -->
<form id="bulk-delete-form-secure" method="POST" action="{{ url_for('bulk_delete_japanese_problems') }}"
    style="display: none;">
    <input type="hidden" name="problem_ids" id="delete-problem-ids-secure">
</form>
{% endblock %}

{% block scripts %}
<script>
    // é¸æŠã•ã‚ŒãŸå•é¡ŒID
    let selectedProblems = new Set();

    function updateBulkActions() {
        const checkboxes = document.querySelectorAll('.problem-checkbox:checked');
        selectedProblems.clear();
        checkboxes.forEach(cb => selectedProblems.add(cb.value));

        const bulkActions = document.getElementById('bulk-actions');
        const countSpan = document.getElementById('selected-count');

        if (selectedProblems && bulkActions && countSpan) {
            if (selectedProblems.size > 0) {
                bulkActions.style.display = 'block';
                countSpan.textContent = selectedProblems.size;
            } else {
                bulkActions.style.display = 'none';
            }
        }

        // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹æ›´æ–°
        const allCheckboxes = document.querySelectorAll('.problem-checkbox');
        const selectAllCb = document.getElementById('select-all-checkbox');
        if (selectAllCb) {
            selectAllCb.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
            selectAllCb.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
        }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«æ˜ç¤ºçš„ã«å‰²ã‚Šå½“ã¦
    window.toggleSelectAll = function (checkbox) {
        const allCheckboxes = document.querySelectorAll('.problem-checkbox');
        allCheckboxes.forEach(cb => cb.checked = checkbox.checked);
        updateBulkActions();
    };

    window.execSelectAll = function () {
        console.log('execSelectAll called');
        const allCheckboxes = document.querySelectorAll('.problem-checkbox');
        allCheckboxes.forEach(cb => cb.checked = true);
        updateBulkActions();
    };

    window.execClearSelection = function () {
        console.log('execClearSelection called');
        const allCheckboxes = document.querySelectorAll('.problem-checkbox');
        allCheckboxes.forEach(cb => cb.checked = false);
        const selectAllCb = document.getElementById('select-all-checkbox');
        if (selectAllCb) {
            selectAllCb.checked = false;
            selectAllCb.indeterminate = false;
        }
        updateBulkActions();
    };

    window.showSendModal = function () {
        if (selectedProblems.size === 0) {
            alert('å•é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }

        document.getElementById('send-quiz-ids').value = Array.from(selectedProblems).join(',');
        document.getElementById('send-count').textContent = selectedProblems.size;

        // é¸æŠã—ãŸå•é¡Œãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        const list = document.getElementById('send-problem-list');
        const rows = document.querySelectorAll('tr[data-problem-id]');
        let html = '';
        rows.forEach(row => {
            if (selectedProblems.has(row.dataset.problemId)) {
                const wordElement = row.querySelector('strong');
                const word = wordElement ? wordElement.textContent : 'ä¸æ˜';
                html += `<div style="padding: 4px 0;">${word}</div>`;
            }
        });
        list.innerHTML = html;

        document.getElementById('send-modal').style.display = 'flex';
    };

    window.closeSendModal = function () {
        document.getElementById('send-modal').style.display = 'none';
    };

    window.showEditModal = function (id, word, reading, meaning, example) {
        document.getElementById('edit-problem-id').value = id;
        document.getElementById('edit-word').value = word;
        document.getElementById('edit-reading').value = reading;
        document.getElementById('edit-meaning').value = meaning || '';
        document.getElementById('edit-example').value = example || '';
        document.getElementById('edit-modal').style.display = 'flex';
    };

    window.closeEditModal = function () {
        document.getElementById('edit-modal').style.display = 'none';
    };

    window.bulkDelete = function () {
        console.log('bulkDelete called');
        if (selectedProblems.size === 0) {
            alert('å•é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }

        if (!confirm(`${selectedProblems.size}å•ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
            return;
        }

        const input = document.getElementById('delete-problem-ids-secure');
        const form = document.getElementById('bulk-delete-form-secure');

        if (!input || !form) {
            console.error('Form or input element not found!', { input, form });
            alert('å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        input.value = Array.from(selectedProblems).join(',');
        console.log('Submitting bulk delete form via JS');
        form.submit();
    };

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.addEventListener('DOMContentLoaded', function () {
        ['send-modal', 'edit-modal'].forEach(id => {
            const modal = document.getElementById(id);
            if (modal) {
                modal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            }
        });
    });
</script>
{% endblock %}