{% extends "base.html" %}

{% block title %}{{ problem.title }} - çŸ³å·ä¸ƒå¤¢è¬›å¸«å°‚ç”¨å­¦ç¿’ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="page-header">
        <h1 class="page-title">{{ problem.title }}</h1>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">â† æˆ»ã‚‹</a>
    </div>

    <!-- å•é¡Œå†…å®¹ -->
    <div class="card" style="margin-bottom: 1.5rem;">
        <h2 class="card-title">ğŸ“‹ å•é¡Œ</h2>
        <div class="editor-container" style="min-height: auto;">
            {% if current_user.is_teacher() or problem.problem_type != 'mixed' %}
            <div id="problem-content" class="ql-container ql-snow" style="border: none;">
                <div class="ql-editor">{{ problem.content|safe }}</div>
            </div>
            {% else %}
            <div class="alert alert-info" style="margin:0;">
                <span class="icon">â¬‡ï¸</span> ä¸‹ã®å›ç­”ãƒ•ã‚©ãƒ¼ãƒ ã«å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
            </div>
            {% endif %}
        </div>
        <div
            style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
            <span style="color: var(--text-muted); font-size: 0.875rem;">
                ä½œæˆæ—¥: {{ problem.created_at|jst('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}
            </span>
            {% if problem.deadline %}
            {% if problem.is_overdue() %}
            <span
                style="background: rgba(244, 67, 54, 0.2); color: #f44336; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.875rem;">
                âš ï¸ æœŸé™åˆ‡ã‚Œï¼ˆ{{ problem.deadline|jst('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}ï¼‰
            </span>
            {% else %}
            <span
                style="background: rgba(76, 175, 80, 0.2); color: #4caf50; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.875rem;">
                ğŸ“… æœŸé™: {{ problem.deadline|jst('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}
            </span>
            {% endif %}
            {% endif %}
        </div>
    </div>

    {% if current_user.is_teacher() %}
    <!-- å…ˆç”Ÿ: å›ç­”ä¸€è¦§ -->
    <div class="card">
        <h2 class="card-title">ğŸ“¬ ç”Ÿå¾’ã®å›ç­” ({{ answers|length }}ä»¶)</h2>

        {% if answers %}
        <div class="problem-list">
            {% for answer in answers %}
            <a href="{{ url_for('view_answer', answer_id=answer.id) }}" class="problem-card">
                <div class="problem-header">
                    <h3 class="problem-title">{{ answer.student.display_name }}</h3>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        {% if answer.feedback %}
                        <span class="status-badge status-reviewed">âœ“ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ¸ˆã¿</span>
                        {% else %}
                        <span class="status-badge status-pending">â³ è¦ç¢ºèª</span>
                        {% endif %}
                        <span class="problem-date">{{ answer.submitted_at|jst }}</span>
                    </div>
                </div>
                <div class="problem-preview">{{ answer.content|format_mixed_answer(problem.problem_type) }}</div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <p>ã¾ã å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>
        {% endif %}

        <!-- æœªå›ç­”ã®ç”Ÿå¾’ãƒªã‚¹ãƒˆ -->
        {% if unanswered_students %}
        <div
            style="margin-top: 1.5rem; padding: 1rem; background: rgba(255, 152, 0, 0.1); border-radius: var(--radius); border: 1px solid rgba(255, 152, 0, 0.3);">
            <h3 style="font-size: 1rem; color: #ff9800; margin-bottom: 0.75rem;">â³ æœªå›ç­”ã®ç”Ÿå¾’ ({{ unanswered_students|length
                }}å)</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                {% for student in unanswered_students %}
                <span
                    style="background: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; border: 1px solid rgba(255, 152, 0, 0.3);">
                    {{ student.display_name }}
                </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ -->
    <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
        <a href="{{ url_for('edit_problem', problem_id=problem.id) }}" class="btn btn-secondary">
            âœï¸ å•é¡Œã‚’ç·¨é›†
        </a>
        <form method="POST" action="{{ url_for('delete_problem', problem_id=problem.id) }}" style="display: inline;">
            <button type="submit" class="btn btn-danger" onclick="return confirmDelete('ã“ã®å•é¡Œã¨é–¢é€£ã™ã‚‹ã™ã¹ã¦ã®å›ç­”ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">
                ğŸ—‘ï¸ å•é¡Œã‚’å‰Šé™¤
            </button>
        </form>
    </div>

    {% else %}
    <!-- ç”Ÿå¾’: å›ç­”ãƒ•ã‚©ãƒ¼ãƒ  -->
    {% if existing_answer %}
    <!-- æ—¢å­˜ã®å›ç­” -->
    <div class="card" style="margin-bottom: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 class="card-title" style="margin-bottom: 0;">ğŸ“ ã‚ãªãŸã®å›ç­”</h2>
            {% if not existing_answer.feedback %}
            <a href="{{ url_for('edit_answer', answer_id=existing_answer.id) }}" class="btn btn-secondary btn-sm">
                âœï¸ ç·¨é›†
            </a>
            {% endif %}
        </div>
        <div class="editor-container" style="min-height: auto; margin-top: 1rem;">
            <div class="ql-container ql-snow" style="border: none;">
                <div class="ql-editor">
                    {% if problem.problem_type == 'mixed' %}
                    <!-- è¤‡åˆå•é¡Œï¼ˆå›ç­”æ¸ˆã¿è¡¨ç¤ºï¼‰: ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’åŸ‹ã‚è¾¼ã‚“ã§è¡¨ç¤º -->
                    <div id="mixed-answer-view-container">
                        {{ problem.content|safe }}
                    </div>
                    {% else %}
                    {{ existing_answer.content|safe }}
                    {% endif %}
                </div>
            </div>
        </div>
        <div style="margin-top: 1rem; color: var(--text-muted); font-size: 0.875rem;">
            æå‡ºæ—¥: {{ existing_answer.submitted_at|jst('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}
        </div>
    </div>

    {% if existing_answer.feedback %}
    <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º -->
    <div class="feedback-box" data-feedback-id="{{ existing_answer.feedback.id }}">
        <div class="feedback-header">
            <span>ğŸ’¬ å…ˆç”Ÿã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</span>
            {% if existing_answer.feedback.score is not none %}
            <span class="score-display">{{ existing_answer.feedback.score }}ç‚¹</span>
            {% endif %}
        </div>
        <div class="feedback-content">{{ existing_answer.feedback.content|safe }}</div>
        <div style="margin-top: 0.75rem; color: var(--text-muted); font-size: 0.75rem;">
            {{ existing_answer.feedback.created_at|jst('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}
        </div>
    </div>
    <script>
        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç¢ºèªã—ãŸã‚‰localStorageã«è¨˜éŒ²ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è§£é™¤ç”¨ï¼‰
        localStorage.setItem('feedback-seen-{{ existing_answer.feedback.id }}', 'true');
    </script>
    {% else %}
    <div class="alert alert-info">
        â³ å…ˆç”Ÿã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚
    </div>
    {% endif %}

    {% else %}
    <!-- å›ç­”å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    {% if problem.is_overdue() %}
    <div class="alert alert-error">
        âš ï¸ ã“ã®å•é¡Œã¯æå‡ºæœŸé™ãŒéãã¦ã„ã‚‹ãŸã‚ã€å›ç­”ã§ãã¾ã›ã‚“ã€‚
    </div>
    {% else %}
    <div class="card">
        <h2 class="card-title">âœï¸ å›ç­”ã‚’å…¥åŠ›</h2>
        <form id="answer-form" method="POST" action="{{ url_for('submit_answer', problem_id=problem.id) }}">

            {% if problem.problem_type == 'choice' %}
            <!-- å¾“æ¥ã®é¸æŠå•é¡Œï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰ -->
            <div class="choices-answer">
                {% set choices = problem.get_choices() %}
                {% for choice in choices %}
                <label class="choice-option">
                    <input type="radio" name="selected_choice" value="{{ loop.index0 }}" required>
                    <span class="choice-text">{{ choice }}</span>
                </label>
                {% endfor %}
            </div>
            <input type="hidden" name="content" value="">

            {% elif problem.problem_type == 'mixed' %}
            <!-- è¤‡åˆå•é¡Œï¼ˆã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã¯JSã§ç½®æ›ï¼‰ -->
            <div id="mixed-problem-description" style="margin-bottom: 1rem; color: var(--text-secondary);">
                â€» å•é¡Œæ–‡ã®ä¸­ã«ã‚ã‚‹å…¥åŠ›æ¬„ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚
            </div>

            <!-- ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
            <div id="mixed-widgets-container" class="ql-editor"
                style="border: 1px solid var(--border); border-radius: 8px; padding: 16px; background: white;">
                {{ problem.content|safe }}
            </div>
            <input type="hidden" name="mixed_answers_json" id="mixed-answers-json">

            {% else %}
            <!-- è¨˜è¿°å•é¡Œ -->
            <div class="editor-container">
                <div id="answer-editor"></div>
            </div>
            <input type="hidden" id="answer-content" name="content">
            {% endif %}

            <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="submit" class="btn btn-success">ğŸ“¤ å›ç­”ã‚’æå‡º</button>
            </div>
        </form>
    </div>
    {% endif %}
    {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<style>
    .choices-answer {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .choice-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background: var(--bg-hover);
        border: 2px solid var(--border);
        border-radius: var(--radius);
        cursor: pointer;
        transition: all 0.2s;
    }

    .choice-option:hover {
        border-color: var(--primary);
        background: rgba(233, 30, 140, 0.05);
    }

    .choice-option input[type="radio"] {
        width: 24px;
        height: 24px;
        accent-color: var(--primary);
    }

    .choice-option input[type="radio"]:checked+.choice-text {
        color: var(--primary);
        font-weight: 600;
    }

    .choice-text {
        font-size: 1rem;
    }

    /* è¤‡åˆå•é¡Œç”¨ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
    .widget-replacement {
        margin: 16px 0;
        padding: 16px;
        background: #fff;
        border: 2px solid var(--primary);
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ */
        position: relative;
        /* ç¢ºå®Ÿã«å‰é¢ã«å‡ºã™ */
        z-index: 10;
    }

    .widget-replacement:hover {
        background: #fffafa;
        box-shadow: 0 6px 12px rgba(233, 30, 140, 0.15);
        transform: translateY(-2px);
    }

    .widget-replacement .widget-label {
        font-weight: 700;
        margin-bottom: 12px;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1.1em;
    }

    /* ã‚¯ãƒªãƒƒã‚¯ã‚’ä¿ƒã™ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¤ã‚³ãƒ³ */
    .widget-replacement::after {
        content: "ğŸ‘† ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›";
        position: absolute;
        top: -10px;
        right: 10px;
        background: var(--primary);
        color: white;
        font-size: 0.75rem;
        padding: 4px 8px;
        border-radius: 12px;
        opacity: 0;
        transition: opacity 0.2s;
        pointer-events: none;
    }

    .widget-replacement:hover::after {
        opacity: 1;
    }

    /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ‹¡å¤§å…¥åŠ›ï¼‰ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .focus-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        display: none;
        flex-direction: column;
        justify-content: flex-end;
        /* ä¸‹ã‹ã‚‰è¡¨ç¤º */
    }

    .focus-modal.active {
        display: flex;
        animation: fadeIn 0.2s ease-out;
    }

    .focus-modal-content {
        background: #f8f9fa;
        border-radius: 20px 20px 0 0;
        padding: 24px;
        height: 85vh;
        /* ç”»é¢ä¸‹éƒ¨ã‹ã‚‰85% */
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .focus-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        border-bottom: 2px solid #eee;
        padding-bottom: 12px;
    }

    .focus-problem-preview {
        background: white;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 24px;
        border: 1px solid #eee;
        font-size: 0.95rem;
        color: var(--text-primary);
        line-height: 1.6;
        max-height: 150px;
        overflow-y: auto;
    }

    .focus-input-area {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .focus-textarea {
        width: 100%;
        flex: 1;
        padding: 16px;
        font-size: 1.2rem;
        /* æ–‡å­—ã‚’å¤§ãã */
        border: 2px solid var(--primary);
        border-radius: 12px;
        resize: none;
        outline: none;
        line-height: 1.6;
    }

    .focus-options {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .focus-option-label {
        padding: 16px 20px;
        background: white;
        border: 2px solid #ddd;
        border-radius: 12px;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .focus-option-label:active {
        transform: scale(0.98);
    }

    .focus-option-label.selected {
        border-color: var(--primary);
        background: #fff0f5;
        color: var(--primary);
        font-weight: bold;
    }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© */
    @keyframes slideUp {
        from {
            transform: translateY(100%);
        }

        to {
            transform: translateY(0);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }
</style>

<!-- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="focus-modal" class="focus-modal">
    <div class="focus-modal-content">
        <div class="focus-modal-header">
            <h3 style="margin:0; font-size:1.2rem;">âœï¸ å…¥åŠ›ä¸­...</h3>
            <button type="button" class="btn btn-primary btn-sm" onclick="closeFocusModal()">å®Œäº†</button>
        </div>
        <div class="focus-problem-preview" id="focus-problem-preview">
            <!-- å•é¡Œæ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
        <div id="focus-input-container" class="focus-input-area">
            <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>
    </div>
</div>

<script>
    let currentWidgetIndex = -1;
    let answers = {};
    const problemContentHtml = `{{ problem.content|safe }}`;
    const PROBLEM_ID = {{ problem.id }};
    const DRAFT_KEY = `nanami_draft_${PROBLEM_ID}`;

    // --- ä¸‹æ›¸ãä¿å­˜ãƒ»å¾©å…ƒé–¢æ•° ---
    function saveDraft(data) {
        try {
            const draftData = {
                timestamp: Date.now(),
                data: data
            };
            localStorage.setItem(DRAFT_KEY, JSON.stringify(draftData));
            showDraftSavedIndicator();
        } catch (e) {
            console.warn('ä¸‹æ›¸ãä¿å­˜ã«å¤±æ•—:', e);
        }
    }

    function loadDraft() {
        try {
            const saved = localStorage.getItem(DRAFT_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                // 24æ™‚é–“ä»¥ä¸Šå‰ã®ãƒ‰ãƒ©ãƒ•ãƒˆã¯ç„¡è¦–
                if (Date.now() - parsed.timestamp < 24 * 60 * 60 * 1000) {
                    return parsed.data;
                }
            }
        } catch (e) {
            console.warn('ä¸‹æ›¸ãèª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
        }
        return null;
    }

    function clearDraft() {
        localStorage.removeItem(DRAFT_KEY);
    }

    function showDraftSavedIndicator() {
        let indicator = document.getElementById('draft-saved-indicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'draft-saved-indicator';
            indicator.innerHTML = 'ğŸ’¾ ä¸‹æ›¸ãä¿å­˜æ¸ˆã¿';
            indicator.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#4caf50;color:white;padding:8px 16px;border-radius:20px;font-size:0.85rem;opacity:0;transition:opacity 0.3s;z-index:9999;';
            document.body.appendChild(indicator);
        }
        indicator.style.opacity = '1';
        setTimeout(() => { indicator.style.opacity = '0'; }, 2000);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // --- ç”Ÿå¾’ãŒå•é¡Œã‚’è¡¨ç¤ºã—ãŸã‚‰å…ˆç”Ÿã«é€šçŸ¥ ---
        {% if not current_user.is_teacher() and not existing_answer %}
        // æœªå›ç­”ã®å ´åˆã®ã¿é€šçŸ¥ï¼ˆä¸€åº¦ã ã‘ï¼‰
        const viewedKey = `problem-viewed-${PROBLEM_ID}`;
        if (!sessionStorage.getItem(viewedKey)) {
            sessionStorage.setItem(viewedKey, 'true');
            fetch(`/api/problem/${PROBLEM_ID}/viewed`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            }).catch(e => console.log('viewé€šçŸ¥ã‚¨ãƒ©ãƒ¼:', e));
        }
        {% endif %}

        // --- è¨˜è¿°å¼ãƒ»å¾“æ¥ã®é¸æŠå¼ ---
        {% if not current_user.is_teacher() and not existing_answer and not problem.is_overdue() and problem.problem_type != 'choice' and problem.problem_type != 'mixed' %}
        const quill = initEditor('answer-editor');
        setupEditorForm('answer-form', quill, 'answer-content');
        {% endif %}

        // --- è¤‡åˆå•é¡Œ (Mixed) ---
        {% if problem.problem_type == 'mixed' and not existing_answer and not current_user.is_teacher() %}
        const container = document.getElementById('mixed-widgets-container');
        const widgets = container.querySelectorAll('.question-widget');
        const hiddenInput = document.getElementById('mixed-answers-json');

        // Form submission handler
        document.getElementById('answer-form').addEventListener('submit', function (e) {
            hiddenInput.value = JSON.stringify(answers);
            clearDraft(); // æå‡ºæ™‚ã«ä¸‹æ›¸ãå‰Šé™¤
        });

        // ä¸‹æ›¸ãå¾©å…ƒ (mixed)
        const savedDraft = loadDraft();
        if (savedDraft && savedDraft.type === 'mixed') {
            answers = savedDraft.answers || {};
            console.log('ä¸‹æ›¸ãã‚’å¾©å…ƒã—ã¾ã—ãŸ:', answers);
        }

        widgets.forEach((widget, index) => {
            const type = widget.dataset.widgetType;
            const widgetId = `widget_${index}`;

            // èª¬æ˜æ–‡ã®å–å¾—
            const descDiv = widget.querySelector('.widget-description');
            const descriptionHtml = descDiv ? descDiv.outerHTML : '';

            // Widgetç½®æ›ç”¨HTML
            const replacement = document.createElement('div');
            replacement.className = 'widget-replacement';
            replacement.dataset.idx = index;
            // èª¬æ˜æ–‡ã‚’dataå±æ€§ã«ä¿å­˜
            replacement.dataset.description = descriptionHtml;
            // ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ¢ãƒ¼ãƒ‰èµ·å‹•
            replacement.addEventListener('click', function (e) {
                // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚„ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è‡ªä½“ã®ã‚¯ãƒªãƒƒã‚¯ãªã‚‰ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’è¨±å®¹ï¼ˆãŸã ã—ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‚‚é–‹ãï¼‰
                openFocusModal(index, type, widget.dataset.choices, descriptionHtml);
            });

            if (type === 'choice') {
                const choices = JSON.parse(widget.dataset.choices || '[]');
                let html = `${descriptionHtml}<div class="widget-label">ğŸ”´ é¸æŠã—ã¦ãã ã•ã„</div>`;
                choices.forEach((choice, choiceIdx) => {
                    html += `
                        <div class="mixed-option-label" style="pointer-events:none;">
                            <span class="mixed-radio-icon">âšª</span>
                            <span>${choice}</span>
                        </div>`;
                });
                replacement.innerHTML = html;

            } else if (type === 'checkbox') {
                const choices = JSON.parse(widget.dataset.choices || '[]');
                let html = `${descriptionHtml}<div class="widget-label">â˜‘ï¸ å…¨ã¦é¸æŠã—ã¦ãã ã•ã„</div>`;
                choices.forEach((choice, choiceIdx) => {
                    html += `
                        <div class="mixed-option-label" style="pointer-events:none;">
                            <span class="mixed-checkbox-icon">â¬œ</span>
                            <span>${choice}</span>
                        </div>`;
                });
                replacement.innerHTML = html;

            } else if (type === 'text') {
                replacement.innerHTML = `
                        ${descriptionHtml}
                        <div class="widget-label">âœï¸ ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›</div>
                        <div class="mixed-textarea" style="background:#f5f5f5; color:#666; pointer-events:none;">(ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›ç”»é¢ã‚’é–‹ã)</div>
                    `;
            }

            widget.replaceWith(replacement);

            // ä¸‹æ›¸ããŒã‚ã‚Œã°UIã‚’æ›´æ–°
            if (answers[index]) {
                setTimeout(() => updateWidgetVisual(index), 50);
            }
        });
        {% endif %}

        // --- è¤‡åˆå•é¡Œ (Mixed: å›ç­”æ¸ˆã¿é–²è¦§ãƒ¢ãƒ¼ãƒ‰) ---
        {% if problem.problem_type == 'mixed' and existing_answer %}
        const viewContainer = document.getElementById('mixed-answer-view-container');
        const viewWidgets = viewContainer.querySelectorAll('.question-widget');
        let savedAnswers = {};
        try {
            savedAnswers = JSON.parse({{ existing_answer.content | tojson }});
        } catch (e) {
        console.error('å›ç­”ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', e);
    }

    viewWidgets.forEach((widget, index) => {
        const type = widget.dataset.widgetType;
        const answerData = savedAnswers[index];
        const descDiv = widget.querySelector('.widget-description');
        const descriptionHtml = descDiv ? descDiv.outerHTML : '';

        const replacement = document.createElement('div');
        replacement.className = 'widget-replacement';
        replacement.style.border = '2px solid #ccc';
        replacement.style.background = '#f9f9f9';
        replacement.style.cursor = 'default';

        if (!answerData) {
            replacement.innerHTML = '<div style="color:red">å›ç­”ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
            widget.replaceWith(replacement);
            return;
        }

        if (type === 'choice') {
            replacement.innerHTML = `
                        ${descriptionHtml}
                        <div class="mixed-option-label selected" style="pointer-events:none;">
                            <span style="margin-right:8px;">âœ…</span> ${answerData.choice_text}
                        </div>`;
        } else if (type === 'checkbox') {
            let html = `${descriptionHtml}<div style="display:flex; flex-direction:column; gap:4px;">`;
            answerData.choice_text.forEach(txt => {
                html += `
                         <div class="mixed-option-label selected" style="pointer-events:none;">
                            <span style="margin-right:8px;">âœ…</span> ${txt}
                        </div>`;
            });
            html += '</div>';
            replacement.innerHTML = html;
        } else if (type === 'text') {
            const val = answerData.value ? answerData.value.replace(/\n/g, '<br>') : '(ç©ºæ¬„)';
            replacement.innerHTML = `
                        ${descriptionHtml}
                        <div style="background:white; padding:12px; border-radius:4px; border:1px solid #ddd;">
                            ${val}
                        </div>`;
        }
        widget.replaceWith(replacement);
    });
    {% endif %}
    });

    // --- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ¢ãƒ¼ãƒ‰é–¢æ•° ---
    function openFocusModal(index, type, choicesJson, descriptionHtml) {
        currentWidgetIndex = index;
        const modal = document.getElementById('focus-modal');
        const preview = document.getElementById('focus-problem-preview');
        const container = document.getElementById('focus-input-container');

        // è§£ç­”æ¬„ã®èª¬æ˜ï¼ˆå•é¡Œæ–‡ï¼‰ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«è¡¨ç¤º
        if (descriptionHtml && descriptionHtml.trim()) {
            preview.innerHTML = descriptionHtml;
            preview.style.display = 'block';
        } else {
            // èª¬æ˜ãŒãªã‘ã‚Œã°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éè¡¨ç¤º
            preview.style.display = 'none';
        }

        // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ç”Ÿæˆ
        container.innerHTML = '';
        if (type === 'choice') {
            const choices = JSON.parse(choicesJson || '[]');
            let html = '<div class="focus-options">';
            choices.forEach((choice, i) => {
                const isSelected = answers[index] && answers[index].value === i;
                html += `
                    <label class="focus-option-label ${isSelected ? 'selected' : ''}">
                        <input type="radio" name="focus-radio" value="${i}" ${isSelected ? 'checked' : ''} onchange="updateChoice(${index}, ${i}, '${choice.replace(/'/g, "\\'")}', this)">
                        ${choice}
                    </label>`;
            });
            html += '</div>';
            container.innerHTML = html;

        } else if (type === 'checkbox') {
            const choices = JSON.parse(choicesJson || '[]');
            let html = '<div class="focus-options">';
            const currentVals = (answers[index] && answers[index].value) || [];
            choices.forEach((choice, i) => {
                const isSelected = currentVals.includes(i);
                html += `
                    <label class="focus-option-label ${isSelected ? 'selected' : ''}">
                        <input type="checkbox" name="focus-check" value="${i}" ${isSelected ? 'checked' : ''} onchange="updateCheckbox(${index}, '${JSON.stringify(choices).replace(/'/g, "\\'")}', this)">
                        ${choice}
                    </label>`;
            });
            html += '</div>';
            container.innerHTML = html;

        } else if (type === 'text') {
            const currentVal = (answers[index] && answers[index].value) || '';
            container.innerHTML = `
                <textarea class="focus-textarea" placeholder="ã“ã“ã«å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." oninput="updateText(${index}, this)">${currentVal}</textarea>
            `;
            // ã‚ªãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            setTimeout(() => container.querySelector('textarea').focus(), 100);
        }

        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å›ºå®š
    }

    function closeFocusModal() {
        document.getElementById('focus-modal').classList.remove('active');
        document.body.style.overflow = '';
        updateWidgetVisual(currentWidgetIndex); // ãƒ¡ã‚¤ãƒ³ç”»é¢ã®è¡¨ç¤ºã‚’æ›´æ–°
    }

    // ãƒ‡ãƒ¼ã‚¿æ›´æ–°é–¢æ•°
    function updateChoice(index, val, text, input) {
        answers[index] = { type: 'choice', value: val, choice_text: text };
        saveDraft({ type: 'mixed', answers: answers }); // ä¸‹æ›¸ãä¿å­˜
        // UIæ›´æ–°
        const labels = input.closest('.focus-options').querySelectorAll('.focus-option-label');
        labels.forEach(l => l.classList.remove('selected'));
        input.closest('label').classList.add('selected');
        // è‡ªå‹•ã§é–‰ã˜ã‚‹ï¼ˆUXå‘ä¸Šï¼‰
        setTimeout(closeFocusModal, 300);
    }

    function updateCheckbox(index, choicesJsonStr, input) {
        const choices = JSON.parse(choicesJsonStr);
        const container = input.closest('.focus-options');
        const checkedInputs = Array.from(container.querySelectorAll('input:checked'));
        const values = checkedInputs.map(el => parseInt(el.value));
        const texts = values.map(v => choices[v]);

        answers[index] = { type: 'checkbox', value: values, choice_text: texts };
        saveDraft({ type: 'mixed', answers: answers }); // ä¸‹æ›¸ãä¿å­˜

        // UIæ›´æ–°
        input.closest('label').classList.toggle('selected', input.checked);
    }

    function updateText(index, textarea) {
        answers[index] = { type: 'text', value: textarea.value };
        saveDraft({ type: 'mixed', answers: answers }); // ä¸‹æ›¸ãä¿å­˜
    }

    // ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆè¡¨ç¤ºã‚’æ›´æ–°ï¼ˆSyncï¼‰
    function updateWidgetVisual(index) {
        const container = document.getElementById('mixed-widgets-container');
        // replacementè¦ç´ ã‚’æ¢ã™ï¼ˆdata-idxã‚’æŒã£ã¦ã„ã‚‹ï¼‰
        const replacement = container.querySelector(`.widget-replacement[data-idx="${index}"]`);
        if (!replacement) return;

        const data = answers[index];
        if (!data) return; // ãƒ‡ãƒ¼ã‚¿ãªã‘ã‚Œã°ãã®ã¾ã¾

        if (data.type === 'choice') {
            const labels = replacement.querySelectorAll('.mixed-option-label');
            labels.forEach((l, i) => {
                if (i === data.value) {
                    l.classList.add('selected');
                    l.querySelector('.mixed-radio-icon').textContent = 'ğŸ”˜';
                    l.style.fontWeight = 'bold';
                    l.style.color = 'var(--primary)';
                } else {
                    l.classList.remove('selected');
                    l.querySelector('.mixed-radio-icon').textContent = 'âšª';
                    l.style.fontWeight = 'normal';
                    l.style.color = '';
                }
            });
        } else if (data.type === 'checkbox') {
            const labels = replacement.querySelectorAll('.mixed-option-label');
            labels.forEach((l, i) => {
                if (data.value.includes(i)) {
                    l.classList.add('selected');
                    l.querySelector('.mixed-checkbox-icon').textContent = 'â˜‘ï¸';
                    l.style.fontWeight = 'bold';
                    l.style.color = 'var(--primary)';
                } else {
                    l.classList.remove('selected');
                    l.querySelector('.mixed-checkbox-icon').textContent = 'â¬œ';
                    l.style.fontWeight = 'normal';
                    l.style.color = '';
                }
            });
        } else if (data.type === 'text') {
            const div = replacement.querySelector('.mixed-textarea');
            if (div) {
                div.textContent = data.value || '(å…¥åŠ›æ¸ˆã¿)';
                div.style.color = data.value ? 'black' : '#666';
                div.style.background = data.value ? '#fff' : '#f5f5f5';
            }
        }
    }
</script>
{% endblock %}