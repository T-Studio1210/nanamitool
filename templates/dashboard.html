{% extends "base.html" %}

{% block title %}ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - çŸ³å·ä¸ƒå¤¢è¬›å¸«å°‚ç”¨å­¦ç¿’ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<div class="fade-in">
    <style>
        .status-badge.status-read {
            background: #f5f5f5 !important;
            color: #888 !important;
            border: 1px solid #ddd !important;
            font-weight: 500;
            animation: none !important;
        }
    </style>
    <div class="page-header">
        <h1 class="page-title">
            {% if current_user.is_teacher() %}
            ğŸ‘¨â€ğŸ« å…ˆç”Ÿãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
            {% else %}
            ğŸ‘¨â€ğŸ“ {{ current_user.display_name }}ã•ã‚“ã®å­¦ç¿’ãƒšãƒ¼ã‚¸
            {% endif %}
        </h1>
        {% if current_user.is_teacher() %}
        <a href="{{ url_for('create_problem') }}" class="btn btn-primary">
            âœï¸ æ–°ã—ã„å•é¡Œã‚’ä½œæˆ
        </a>
        {% endif %}
    </div>

    <!-- é€£çµ¡äº‹é … -->
    {% if announcements %}
    <div class="card"
        style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #fff9c4 0%, #ffecb3 100%); border-color: #ffc107;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <h2 style="font-size: 1.1rem; font-weight: 600; color: #e65100; margin: 0;">ğŸ“¢ é€£çµ¡äº‹é …</h2>
            {% if current_user.is_teacher() %}
            <a href="{{ url_for('manage_announcements') }}" class="btn btn-secondary btn-sm">ç®¡ç†</a>
            {% endif %}
        </div>
        {% for announcement in announcements %}
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.7); border-radius: 8px; margin-bottom: 0.5rem;">
            <div style="font-weight: 600; color: #4a2040;">{{ announcement.title }}</div>
            <div style="font-size: 0.875rem; margin-top: 0.25rem;" class="ql-editor" style="padding:0;">{{
                announcement.content|safe }}</div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                <div style="font-size: 0.75rem; color: #999;">{{ announcement.created_at|jst }}
                </div>
                {% if not current_user.is_teacher() %}
                <div class="reaction-buttons" data-announcement-id="{{ announcement.id }}">
                    <button
                        class="reaction-btn {% if announcement.reactions.filter_by(student_id=current_user.id, reaction_type='seen').first() %}active{% endif %}"
                        data-reaction="seen" onclick="toggleReaction({{ announcement.id }}, 'seen', this)">
                        ğŸ‘€ <span class="count">{{ announcement.reactions.filter_by(reaction_type='seen').count() or ''
                            }}</span>
                    </button>
                    <button
                        class="reaction-btn {% if announcement.reactions.filter_by(student_id=current_user.id, reaction_type='like').first() %}active{% endif %}"
                        data-reaction="like" onclick="toggleReaction({{ announcement.id }}, 'like', this)">
                        ğŸ‘ <span class="count">{{ announcement.reactions.filter_by(reaction_type='like').count() or ''
                            }}</span>
                    </button>
                    <button
                        class="reaction-btn {% if announcement.reactions.filter_by(student_id=current_user.id, reaction_type='thanks').first() %}active{% endif %}"
                        data-reaction="thanks" onclick="toggleReaction({{ announcement.id }}, 'thanks', this)">
                        ğŸ™ <span class="count">{{ announcement.reactions.filter_by(reaction_type='thanks').count() or ''
                            }}</span>
                    </button>
                </div>
                {% else %}
                <div style="font-size: 0.75rem; color: #666;">
                    ğŸ‘€ {{ announcement.reactions.filter_by(reaction_type='seen').count() }}
                    ğŸ‘ {{ announcement.reactions.filter_by(reaction_type='like').count() }}
                    ğŸ™ {{ announcement.reactions.filter_by(reaction_type='thanks').count() }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if current_user.is_teacher() %}
    <!-- å…ˆç”Ÿç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <div class="dashboard-grid">
        <div class="stat-card">
            <div class="stat-icon">ğŸ“</div>
            <div>
                <div class="stat-value">{{ stats.problems }}</div>
                <div class="stat-label">å•é¡Œæ•°</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: var(--secondary);">ğŸ‘¥</div>
            <div>
                <div class="stat-value">{{ stats.students }}</div>
                <div class="stat-label">ç”Ÿå¾’æ•°</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: var(--warning);">ğŸ“¬</div>
            <div>
                <div class="stat-value">{{ stats.pending_answers }}</div>
                <div class="stat-label">æœªç¢ºèªã®å›ç­”</div>
            </div>
        </div>
        <!-- å®¹é‡è¡¨ç¤º -->
        <div class="stat-card">
            <div class="stat-icon" style="background: #607d8b;">ğŸ’¾</div>
            <div style="width: 100%;">
                <div style="display: flex; justify-content: space-between;">
                    <div class="stat-label">ã‚µãƒ¼ãƒãƒ¼å®¹é‡</div>
                    <div class="stat-label">{{ stats.disk_used_percent }}% ä½¿ç”¨</div>
                </div>
                <div
                    style="width: 100%; height: 8px; background: #eee; border-radius: 4px; margin-top: 5px; overflow: hidden;">
                    <div
                        style="width: {{ stats.disk_used_percent }}%; height: 100%; background: {% if stats.disk_used_percent > 90 %}#f44336{% elif stats.disk_used_percent > 70 %}#ff9800{% else %}#4caf50{% endif %};">
                    </div>
                </div>
                <div style="font-size: 0.75rem; color: #999; margin-top: 3px;">ç©ºã: {{ stats.disk_free_gb }} GB</div>
            </div>
        </div>
    </div>

    <!-- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="reaction-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header"
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="margin:0;">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è©³ç´°</h3>
                <button type="button" class="btn btn-secondary btn-sm" onclick="closeReactionModal()">Ã—</button>
            </div>
            <div id="reaction-details-content">
                Loading...
            </div>
        </div>
    </div>

    <h2 style="margin-top: 2rem; margin-bottom: 1rem;">ğŸ“‹ æœ€æ–°ã®å•é¡Œ</h2>
    {% else %}
    <!-- ç”Ÿå¾’ç”¨ å­¦ç¿’çŠ¶æ³ -->
    {% if student_stats %}
    <div class="stats-grid" style="margin-bottom: 1.5rem;">
        <!-- å®Œäº†ç‡ -->
        <div class="stat-card" style="grid-column: span 2;">
            <div class="stat-icon" style="background: linear-gradient(135deg, #e91e8c, #ff6b9d);">ğŸ“Š</div>
            <div style="width: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div class="stat-label">å­¦ç¿’é€²æ—</div>
                    <div class="stat-value" style="font-size: 1.5rem;">{{ student_stats.completion_rate }}%</div>
                </div>
                <div
                    style="width: 100%; height: 12px; background: #eee; border-radius: 6px; margin-top: 8px; overflow: hidden;">
                    <div
                        style="width: {{ student_stats.completion_rate }}%; height: 100%; background: linear-gradient(90deg, #e91e8c, #ff6b9d); transition: width 0.5s;">
                    </div>
                </div>
                <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                    {{ student_stats.answered }} / {{ student_stats.total_assigned }} å• å®Œäº†
                </div>
            </div>
        </div>

        <!-- å›ç­”æ¸ˆã¿ -->
        <div class="stat-card">
            <div class="stat-icon" style="background: #4caf50;">âœ…</div>
            <div>
                <div class="stat-label">å›ç­”æ¸ˆã¿</div>
                <div class="stat-value">{{ student_stats.answered }}</div>
            </div>
        </div>

        <!-- æœªå›ç­” -->
        <div class="stat-card">
            <div class="stat-icon" style="background: #ff9800;">â³</div>
            <div>
                <div class="stat-label">æœªå›ç­”</div>
                <div class="stat-value">{{ student_stats.unanswered }}</div>
            </div>
        </div>

        <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å—ä¿¡ -->
        <div class="stat-card">
            <div class="stat-icon" style="background: #2196f3;">ğŸ’¬</div>
            <div>
                <div class="stat-label">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div>
                <div class="stat-value">{{ student_stats.feedback_received }}</div>
            </div>
        </div>

        <!-- ç¢ºèªå¾…ã¡ -->
        <div class="stat-card">
            <div class="stat-icon" style="background: #9c27b0;">ğŸ“¤</div>
            <div>
                <div class="stat-label">ç¢ºèªå¾…ã¡</div>
                <div class="stat-value">{{ student_stats.pending_feedback }}</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- æ—¥æœ¬èªå­¦ç¿’ãƒªãƒ³ã‚¯ï¼ˆä¸­å›½äººç”Ÿå¾’å‘ã‘ï¼‰ -->
    {% if current_user.is_chinese_student %}
    <div class="card"
        style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-color: #2196f3;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2 style="font-size: 1.1rem; font-weight: 600; color: #1565c0; margin: 0 0 0.25rem 0;">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èªå­¦ç¿’</h2>
                <p style="margin: 0; font-size: 0.875rem; color: #1976d2;">ä¸­å›½ã®å°å­¦ç”Ÿã®ãŸã‚ã®æ—¥æœ¬èªç·´ç¿’</p>
            </div>
            <a href="{{ url_for('japanese_dashboard') }}" class="btn btn-primary"
                style="background: linear-gradient(135deg, #1976d2, #1565c0);">
                å­¦ç¿’ã‚’å§‹ã‚ã‚‹ â†’
            </a>
        </div>
    </div>
    {% endif %}

    <h2 style="margin-bottom: 1rem;">ğŸ“‹ å–ã‚Šçµ„ã‚€å•é¡Œ</h2>
    {% endif %}

    {% if problems or japanese_tasks %}
    <div class="problem-list">
        {% for problem in problems %}
        <a href="{{ url_for('view_problem', problem_id=problem.id) }}" class="problem-card"
            data-problem-id="{{ problem.id }}">
            <div class="problem-header">
                <h3 class="problem-title">{{ problem.title }}</h3>
                <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                    <!-- NEWãƒãƒƒã‚¸ï¼ˆ24æ™‚é–“ä»¥å†…ã‹ã¤æœªå›ç­”ã®å ´åˆã®ã¿ï¼‰ -->
                    {% set hours_ago = (now - problem.created_at).total_seconds() / 3600 %}
                    {% set answer = problem.answers.filter_by(student_id=current_user.id).first() if not
                    current_user.is_teacher() else None %}
                    {% if not current_user.is_teacher() and not answer and hours_ago < 24 %} <span
                        class="status-badge new-badge">ğŸ†• NEW</span>
                        {% endif %}

                        <!-- ä¸‹æ›¸ããƒãƒƒã‚¸ï¼ˆJSã§è¿½åŠ ï¼‰ -->
                        <span class="draft-badge" style="display: none;">ğŸ“ ä¸‹æ›¸ãã‚ã‚Š</span>

                        <!-- ãƒãƒƒã‚¸ç¾¤ -->
                        {% if problem.deadline %}
                        {% if problem.is_overdue() %}
                        <span class="status-badge" style="background: rgba(244, 67, 54, 0.2); color: #f44336;">âš ï¸
                            æœŸé™åˆ‡ã‚Œ</span>
                        {% else %}
                        <span class="status-badge" style="background: rgba(76, 175, 80, 0.2); color: #4caf50;">ğŸ“… {{
                            problem.deadline|jst('%m/%d %H:%M') }}</span>
                        {% endif %}
                        {% endif %}

                        {% set completed_count = problem.answers.count() if current_user.is_teacher() else 0 %}
                        {% set student_count = stats.students if current_user.is_teacher() else 0 %}

                        {% if current_user.is_teacher() %}
                        {% set all_answers = problem.answers.all() %}
                        {% set pending_feedback_count = all_answers|rejectattr('feedback')|list|length %}
                        <span class="status-badge" style="background: #e3f2fd; color: #1976d2;">
                            ğŸ“¬ å›ç­”: {{ completed_count }} / {{ student_count }}
                        </span>
                        {% if pending_feedback_count > 0 %}
                        <span class="status-badge pending-feedback-badge">âš ï¸ è¦ç¢ºèª: {{ pending_feedback_count }}ä»¶</span>
                        {% endif %}
                        {% else %}
                        {% if answer %}
                        {% if answer.feedback %}
                        <span class="status-badge feedback-badge" data-feedback-id="{{ answer.feedback.id }}">ğŸ’¬
                            ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ã‚Š!</span>
                        {% else %}
                        <span class="status-badge status-submitted">ğŸ“¤ æå‡ºæ¸ˆã¿</span>
                        {% endif %}
                        {% else %}
                        <span class="status-badge status-pending">â³ æœªå›ç­”</span>
                        {% endif %}
                        {% endif %}

                        <span class="problem-date">{{ problem.created_at|jst('%Y/%m/%d') }}</span>
                        {% if problem.problem_type == 'choice' %}
                        <span class="status-badge">âœ… é¸æŠ</span>
                        {% elif problem.problem_type == 'text' %}
                        <span class="status-badge">ğŸ“ è¨˜è¿°</span>
                        {% else %}
                        <span class="status-badge">âœ¨ è¤‡åˆ</span>
                        {% endif %}
                </div>
            </div>
            <div class="problem-preview">{{ problem.content|striptags|truncate(100) }}</div>
        </a>
        {% endfor %}

        <!-- æ—¥æœ¬èªèª²é¡Œãƒ«ãƒ¼ãƒ— -->
        {% for task in japanese_tasks %}
        <a href="{% if task.type == 'quiz' or task.type == 'quiz_group' %}{{ url_for('student_quiz_assignment', assignment_id=task.assignment_id) }}{% elif task.type == 'flashcard' or task.type == 'flashcard_group' %}{{ url_for('student_flashcard', assignment_id=task.assignment_id) }}{% elif task.type == 'writing' or task.type == 'writing_group' %}{{ url_for('student_writing', assignment_id=task.assignment_id) }}{% else %}#{% endif %}"
            class="problem-card" style="display: block; text-decoration: none; color: inherit;">
            <div class="problem-card-inner">
                <div class="problem-header">
                    <h3 class="problem-name">{{ task.title }}</h3>
                </div>
                <div class="problem-meta">
                    <!-- NEWãƒãƒƒã‚¸ -->
                    {% set hours_ago = (now - task.created_at).total_seconds() / 3600 %}
                    {% if not task.completed and hours_ago < 24 %} <span class="status-badge new-badge">ğŸ†• NEW</span>
                        {% endif %}

                        <!-- å®Œäº†/æœªå®Œäº†ãƒãƒƒã‚¸ -->
                        {% if task.unseen_feedback %}
                        <span class="status-badge feedback-badge">ğŸ’¬ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ã‚Š!</span>
                        {% elif task.feedback %}
                        <span class="status-badge feedback-badge status-read">ğŸ’¬ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯(æ—¢èª­)</span>
                        {% endif %}

                        {% if task.completed %}
                        {% if not task.feedback %}
                        <span class="status-badge status-submitted">âœ… å®Œäº†</span>
                        {% endif %}
                        {% else %}
                        <span class="status-badge status-pending">â³ æœªå®Œäº†</span>
                        {% endif %}



                        <span class="problem-date">{{ task.created_at|jst('%Y/%m/%d') }}</span>

                        {% if task.type == 'quiz' or task.type == 'quiz_group' %}
                        <span class="status-badge" style="background: #e1bee7; color: #4a148c;">ğŸ¯ ã‚¯ã‚¤ã‚º</span>
                        {% elif task.type == 'flashcard' or task.type == 'flashcard_group' %}
                        <span class="status-badge" style="background: #c5cae9; color: #1a237e;">ğŸ“– ã‚«ãƒ¼ãƒ‰</span>
                        {% elif task.type == 'writing' or task.type == 'writing_group' %}
                        <span class="status-badge" style="background: #b2dfdb; color: #004d40;">âœï¸ æ›¸ãå–ã‚Š</span>
                        {% endif %}
                </div>
            </div>
            <div class="problem-preview">
                {% if task.type == 'quiz' or task.type == 'quiz_group' %}
                ç†Ÿèªã®æ„å‘³ã€èª­ã¿æ–¹ã‚’é¸æŠã™ã‚‹ã‚¯ã‚¤ã‚ºã§ã™ã€‚
                {% elif task.type == 'flashcard' or task.type == 'flashcard_group' %}
                å˜èªã®æ„å‘³ã¨èª­ã¿ã‚’è¦šãˆã‚‹ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã§ã™ã€‚
                {% elif task.type == 'writing' or task.type == 'writing_group' %}
                æ­£ã—ã„æ›¸ãé †ã¨å½¢ã‚’ç·´ç¿’ã™ã‚‹æ›¸ãå–ã‚Šèª²é¡Œã§ã™ã€‚
                {% endif %}
            </div>
        </a>
        {% endfor %}
    </div>
    <div style="text-align: center; margin-top: 1rem;">
        {% if current_user.is_teacher() %}
        <a href="{{ url_for('manage_problems') }}" class="btn btn-secondary">ã™ã¹ã¦è¦‹ã‚‹</a>
        {% endif %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">ğŸ“­</div>
        {% if current_user.is_teacher() %}
        <p>ã¾ã å•é¡ŒãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
        <a href="{{ url_for('create_problem') }}" class="btn btn-primary" style="margin-top: 1rem;">
            âœï¸ æœ€åˆã®å•é¡Œã‚’ä½œæˆ
        </a>
        {% else %}
        <p>å–ã‚Šçµ„ã‚€å•é¡ŒãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        <p style="margin-top: 0.5rem; font-size: 0.875rem;">å…ˆç”ŸãŒå•é¡Œã‚’è¿½åŠ ã™ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚</p>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<style>
    .reaction-buttons {
        display: flex;
        gap: 6px;
    }

    .reaction-btn {
        padding: 4px 8px;
        font-size: 0.85rem;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid #ddd;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 2px;
    }

    .reaction-btn:hover {
        background: #fff;
        transform: scale(1.05);
    }

    .reaction-btn.active {
        background: linear-gradient(135deg, #e91e8c, #c4177a);
        color: white;
        border-color: #e91e8c;
    }

    .reaction-btn .count {
        font-size: 0.75rem;
        min-width: 12px;
        text-align: center;
    }

    /* NEWãƒãƒƒã‚¸ */
    .new-badge {
        background: linear-gradient(135deg, #ff6b6b, #ff8e53) !important;
        color: white !important;
        font-weight: 600;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
        }
    }

    /* ä¸‹æ›¸ããƒãƒƒã‚¸ */
    .draft-badge {
        background: linear-gradient(135deg, #ffd93d, #ff9f1c) !important;
        color: #333 !important;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
    }

    /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒãƒƒã‚¸ï¼ˆæœªèª­ï¼‰ */
    .feedback-badge {
        background: linear-gradient(135deg, #4caf50, #8bc34a) !important;
        color: white !important;
        font-weight: 600;
        animation: pulse 1.5s infinite;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
    }

    /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç¢ºèªæ¸ˆã¿ï¼ˆæ—¢èª­ï¼‰ */
    .feedback-badge.seen {
        background: linear-gradient(135deg, #9e9e9e, #bdbdbd) !important;
        color: white !important;
        animation: none;
        box-shadow: none;
        opacity: 0.8;
    }

    /* è¦ç¢ºèªãƒãƒƒã‚¸ï¼ˆå…ˆç”Ÿç”¨ï¼‰ */
    .pending-feedback-badge {
        background: linear-gradient(135deg, #ff9800, #ff5722) !important;
        color: white !important;
        font-weight: 600;
        animation: pulse 1.5s infinite;
    }
</style>

<script>
    async function toggleReaction(announcementId, reactionType, button) {
        try {
            const response = await fetch(`/api/announcement/${announcementId}/react`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reaction: reactionType })
            });

            if (response.ok) {
                const data = await response.json();
                const countEl = button.querySelector('.count');
                let count = parseInt(countEl.textContent) || 0;

                if (data.action === 'added') {
                    button.classList.add('active');
                    countEl.textContent = count + 1;
                } else {
                    button.classList.remove('active');
                    countEl.textContent = count > 1 ? count - 1 : '';
                }
            }
        } catch (e) {
            console.error('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', e);
        }
    }

    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è©³ç´°è¡¨ç¤º (å…ˆç”Ÿç”¨)
    {% if current_user.is_teacher() %}
    document.querySelectorAll('.reaction-buttons').forEach(div => {
        div.style.cursor = 'pointer';
        div.title = 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ã‚’è¡¨ç¤º';
        div.addEventListener('click', async (e) => {
            // ãƒœã‚¿ãƒ³è‡ªä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ç™ºç«ã•ã›ãªã„(ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡ã¨ç«¶åˆã—ãªã„ã‚ˆã†ã«)
            if (e.target.closest('.reaction-btn')) return;

            const announcementId = div.dataset.announcementId;
            openReactionModal(announcementId);
        });
    });

    async function openReactionModal(announcementId) {
        const modal = document.getElementById('reaction-modal');
        const content = document.getElementById('reaction-details-content');
        modal.style.display = 'flex';
        content.innerHTML = '<div style="text-align:center; padding:20px;">èª­ã¿è¾¼ã¿ä¸­...</div>';

        try {
            const res = await fetch(`/api/announcement/${announcementId}/reactions`);
            if (!res.ok) throw new Error('API Error');
            const data = await res.json();

            if (data.length === 0) {
                content.innerHTML = '<p style="text-align:center; color:#666;">ã¾ã ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            let html = '<div style="display:flex; flex-direction:column; gap:8px;">';
            data.forEach(r => {
                let icon = '';
                if (r.type === 'seen') icon = 'ğŸ‘€';
                else if (r.type === 'like') icon = 'ğŸ‘';
                else if (r.type === 'thanks') icon = 'ğŸ™';

                html += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:#f9f9f9; border-radius:4px;">
                    <div style="font-weight:600;">${r.user_name}</div>
                    <div>${icon} <span style="font-size:0.8rem; color:#999;">${r.created_at}</span></div>
                </div>`;
            });
            html += '</div>';
            content.innerHTML = html;
        } catch (e) {
            content.innerHTML = '<p style="color:red; text-align:center;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
        }
    }

    function closeReactionModal() {
        document.getElementById('reaction-modal').style.display = 'none';
    }
    {% endif %}

    // ä¸‹æ›¸ãæ¤œå‡ºï¼ˆç”Ÿå¾’ç”¨ï¼‰
    document.addEventListener('DOMContentLoaded', function () {
        const problemCards = document.querySelectorAll('.problem-card[data-problem-id]');
        problemCards.forEach(card => {
            const problemId = card.dataset.problemId;
            const draftKey = `answer-draft-${problemId}`;
            const draft = localStorage.getItem(draftKey);

            if (draft) {
                try {
                    const draftData = JSON.parse(draft);
                    // 24æ™‚é–“ä»¥å†…ã®ä¸‹æ›¸ãã®ã¿è¡¨ç¤º
                    if (draftData.timestamp && Date.now() - draftData.timestamp < 24 * 60 * 60 * 1000) {
                        const draftBadge = card.querySelector('.draft-badge');
                        if (draftBadge) {
                            draftBadge.style.display = 'inline-block';
                        }
                    }
                } catch (e) {
                    // ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                }
            }

            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ—¢èª­ãƒã‚§ãƒƒã‚¯
            const feedbackBadge = card.querySelector('.feedback-badge[data-feedback-id]');
            if (feedbackBadge) {
                const feedbackId = feedbackBadge.dataset.feedbackId;
                const seenKey = `feedback-seen-${feedbackId}`;
                if (localStorage.getItem(seenKey)) {
                    feedbackBadge.classList.add('seen');
                }
            }
        });
    });
</script>
{% endblock %}