{% extends "base.html" %}

{% block title %}è¨­å®š - çŸ³å·ä¸ƒå¤¢è¬›å¸«å°‚ç”¨å­¦ç¿’ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="page-header">
        <h1 class="page-title">âš™ï¸ è¨­å®š</h1>
    </div>

    <div style="display: grid; gap: 1.5rem; max-width: 600px;">
        <!-- è¡¨ç¤ºåå¤‰æ›´ -->
        <div class="card">
            <h2 class="card-title">ğŸ‘¤ è¡¨ç¤ºåã®å¤‰æ›´</h2>
            <form method="POST" action="{{ url_for('settings') }}">
                <input type="hidden" name="action" value="change_display_name">
                <div class="form-group">
                    <label class="form-label" for="display_name">è¡¨ç¤ºå</label>
                    <input type="text" id="display_name" name="display_name" class="form-input"
                        value="{{ current_user.display_name }}" required>
                </div>
                <button type="submit" class="btn btn-primary">å¤‰æ›´ã‚’ä¿å­˜</button>
            </form>
        </div>

        <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ -->
        <div class="card">
            <h2 class="card-title">ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´</h2>
            <form method="POST" action="{{ url_for('settings') }}">
                <input type="hidden" name="action" value="change_password">
                <div class="form-group">
                    <label class="form-label" for="current_password">ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="current_password" name="current_password" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="new_password">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="new_password" name="new_password" class="form-input" required
                        minlength="4">
                </div>
                <div class="form-group">
                    <label class="form-label" for="confirm_password">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
                    <input type="password" id="confirm_password" name="confirm_password" class="form-input" required
                        minlength="4">
                </div>
                <button type="submit" class="btn btn-primary">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
            </form>
        </div>

        <!-- é€šçŸ¥è¨­å®š -->
        <div class="card">
            <h2 class="card-title">ğŸ”” é€šçŸ¥è¨­å®š</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€é€£çµ¡äº‹é …ã‚„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã§å—ã‘å–ã‚Œã¾ã™ã€‚
            </p>
            <div id="notification-status"
                style="margin-bottom: 1rem; padding: 10px; border-radius: 8px; background: var(--bg-hover);">
                é€šçŸ¥çŠ¶æ…‹: ç¢ºèªä¸­...
            </div>
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                <button id="enable-push-btn" class="btn btn-primary" onclick="enablePushNotifications()">
                    ğŸ”” é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                </button>
                <button id="test-notification-btn" class="btn btn-secondary" onclick="testNotification()">
                    ğŸ§ª ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡
                </button>
            </div>
        </div>

        <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ± -->
        <div class="card">
            <h2 class="card-title">ğŸ“‹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±</h2>
            <div style="display: grid; gap: 0.75rem;">
                <div>
                    <span style="color: var(--text-secondary);">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</span>
                    <span style="margin-left: 0.5rem;">{{ current_user.username }}</span>
                </div>
                <div>
                    <span style="color: var(--text-secondary);">å½¹å‰²:</span>
                    <span style="margin-left: 0.5rem;">
                        {% if current_user.is_teacher() %}ğŸ‘¨â€ğŸ« å…ˆç”Ÿ{% else %}ğŸ‘¨â€ğŸ“ ç”Ÿå¾’{% endif %}
                    </span>
                </div>
                <div>
                    <span style="color: var(--text-secondary);">ç™»éŒ²æ—¥:</span>
                    <span style="margin-left: 0.5rem;">{{ current_user.created_at.strftime('%Yå¹´%mæœˆ%dæ—¥') }}</span>
                </div>
            </div>
        </div>

        <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ -->
        <div class="card" style="background: rgba(244, 67, 54, 0.05); border: 1px solid rgba(244, 67, 54, 0.3);">
            <a href="{{ url_for('logout') }}" class="btn btn-danger btn-block" style="font-size: 1rem;">
                ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // é€šçŸ¥çŠ¶æ…‹ã‚’ç¢ºèª
    function updateNotificationStatus() {
        const statusEl = document.getElementById('notification-status');
        const btn = document.getElementById('enable-push-btn');

        if (!('Notification' in window)) {
            statusEl.innerHTML = 'âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“';
            btn.style.display = 'none';
            return;
        }

        if (Notification.permission === 'granted') {
            statusEl.innerHTML = 'âœ… é€šçŸ¥ã¯æœ‰åŠ¹ã§ã™';
            statusEl.style.background = 'rgba(76, 175, 80, 0.2)';
            btn.textContent = 'âœ… é€šçŸ¥ã¯æœ‰åŠ¹ã§ã™';
            btn.disabled = true;
            btn.style.opacity = '0.7';
        } else if (Notification.permission === 'denied') {
            statusEl.innerHTML = 'âŒ é€šçŸ¥ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
            statusEl.style.background = 'rgba(244, 67, 54, 0.2)';
            btn.style.display = 'none';
        } else {
            statusEl.innerHTML = 'â³ é€šçŸ¥ã¯ã¾ã æœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã›ã‚“';
            btn.textContent = 'ğŸ”” é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹';
        }
    }

    // é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹
    async function enablePushNotifications() {
        localStorage.removeItem('notification-dismissed');

        if (typeof requestPushPermission === 'function') {
            const token = await requestPushPermission();
            if (token) {
                alert('é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼');
            }
        } else {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                alert('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å®Œäº†ã—ã¾ã™ã€‚');
                location.reload();
            }
        }
        updateNotificationStatus();
    }

    document.addEventListener('DOMContentLoaded', updateNotificationStatus);
</script>
{% endblock %}