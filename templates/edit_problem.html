{% extends "base.html" %}

{% block title %}å•é¡Œã‚’ç·¨é›† - çŸ³å·ä¸ƒå¤¢è¬›å¸«å°‚ç”¨å­¦ç¿’ã‚¢ãƒ—ãƒª{% endblock %}

{% block head %}
<style>
    /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
    .quick-tools {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
        align-items: center;
    }

    .quick-tool {
        padding: 8px 14px;
        border-radius: 20px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        color: var(--text-primary);
        font-size: 0.85rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .quick-tool:hover {
        background: var(--bg-hover);
    }

    .quick-tool.primary-action {
        border-color: var(--primary);
        color: var(--primary);
        font-weight: 600;
        background: rgba(233, 30, 140, 0.05);
    }

    /* ã‚¨ãƒ‡ã‚£ã‚¿å†…ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ */
    .question-widget {
        border: 2px solid var(--primary);
        background: #f8f9fa;
        padding: 10px;
        margin: 10px 0;
        border-radius: 8px;
        user-select: none;
    }

    .question-widget .widget-header {
        font-weight: bold;
        color: var(--primary);
        margin-bottom: 5px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
    }

    .modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
    }

    .modal-content {
        background: white;
        padding: 24px;
        border-radius: 12px;
        width: 100%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .choice-row {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
        align-items: center;
    }

    .choice-row input[type="text"] {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .remove-choice-btn {
        background: #ff4444;
        color: white;
        border: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="page-header">
        <h1 class="page-title">âœï¸ å•é¡Œã‚’ç·¨é›† (ãƒ–ãƒ­ãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿)</h1>
        <a href="{{ url_for('view_problem', problem_id=problem.id) }}" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
    </div>

    <div class="card">
        <h2 class="card-title">ğŸ“ å•é¡Œè¨­å®š</h2>
        <form id="edit-problem-form" method="POST" action="{{ url_for('edit_problem', problem_id=problem.id) }}">
            <div class="form-group">
                <label class="form-label" for="title">ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input type="text" id="title" name="title" class="form-input" required value="{{ problem.title }}">
            </div>

            <div class="form-group">
                <label class="form-label" for="deadline">æå‡ºæœŸé™ (ä»»æ„)</label>
                <input type="datetime-local" id="deadline" name="deadline" class="form-input"
                    value="{{ problem.deadline.strftime('%Y-%m-%dT%H:%M') if problem.deadline else '' }}">
            </div>

            <input type="hidden" id="content" name="content">
            <input type="hidden" name="problem_type" value="mixed">

            <hr style="margin: 2rem 0; border: 0; border-top: 1px solid var(--border);">

            <h2 class="card-title">ğŸ§© å•é¡Œã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h2>
            <div id="form-blocks-container"
                style="display: flex; flex-direction: column; gap: 24px; min-height: 200px; margin-bottom: 2rem;">
                <!-- ã“ã“ã«ãƒ–ãƒ­ãƒƒã‚¯ãŒå±•é–‹ã•ã‚Œã¾ã™ -->
            </div>

            <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
            <div class="sticky-toolbar"
                style="position: sticky; bottom: 20px; background: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border: 1px solid var(--border); display: flex; gap: 16px; justify-content: center; z-index: 100; max-width: Fit-content; margin: 0 auto;">
                <button type="button" class="btn btn-secondary" onclick="addTextBlock()" style="border-radius: 20px;">
                    ï¿½ èª¬æ˜æ–‡
                </button>
                <div style="width: 1px; background: #ddd; margin: 0 4px;"></div>
                <button type="button" class="btn btn-primary" onclick="addWidgetBlock('choice')"
                    style="border-radius: 20px;">
                    ğŸ”´ é¸æŠ(å˜ä¸€)
                </button>
                <button type="button" class="btn btn-primary" onclick="addWidgetBlock('checkbox')"
                    style="border-radius: 20px;">
                    â˜‘ï¸ é¸æŠ(è¤‡æ•°)
                </button>
                <button type="button" class="btn btn-primary" onclick="addWidgetBlock('text')"
                    style="border-radius: 20px;">
                    âœï¸ è¨˜è¿°
                </button>
            </div>

            <div style="text-align: right; margin-top: 2rem; padding-bottom: 4rem;">
                <button type="submit" class="btn btn-success"
                    style="padding: 12px 32px; font-size: 1.1rem; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                    ğŸ’¾ å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹
                </button>
            </div>
        </form>
    </div>
</div>

<!-- æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆãƒ‘ãƒ¼ã‚¹ç”¨éè¡¨ç¤ºï¼‰ -->
<div id="raw-content" style="display: none;">{{ problem.content|safe }}</div>
{% endblock %}

{% block scripts %}
<style>
    .content-block {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        position: relative;
        transition: box-shadow 0.2s;
    }

    .content-block:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .block-controls {
        position: absolute;
        right: 10px;
        top: 10px;
        opacity: 0.3;
        transition: opacity 0.2s;
        display: flex;
        gap: 8px;
    }

    .content-block:hover .block-controls {
        opacity: 1;
    }

    .block-btn {
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 32px;
        height: 32px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .block-btn:hover {
        background: #e0e0e0;
        color: var(--danger);
    }

    .widget-preview {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 8px;
        border: 1px dashed #ccc;
        margin-top: 12px;
    }

    .choice-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 12px;
    }

    .choice-item {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .choice-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }

    .widget-header-input {
        width: 100%;
        padding: 8px;
        font-size: 1rem;
        font-weight: bold;
        color: var(--primary);
        border: 1px solid transparent;
        border-bottom: 1px solid #ddd;
        margin-bottom: 8px;
    }
</style>

<script>
    const container = document.getElementById('form-blocks-container');
    let blockCount = 0;

    function createBlockWrapper(typeIcon, title) {
        const div = document.createElement('div');
        div.className = 'content-block';
        div.innerHTML = `
            <div style="font-weight:bold; color:var(--text-secondary); margin-bottom:12px; display:flex; align-items:center; gap:8px;">
                <span>${typeIcon}</span> ${title}
            </div>
            <div class="block-content"></div>
            <div class="block-controls">
                <button type="button" class="block-btn" onclick="moveBlock(this, -1)" title="ä¸Šã¸">â¬†ï¸</button>
                <button type="button" class="block-btn" onclick="moveBlock(this, 1)" title="ä¸‹ã¸">â¬‡ï¸</button>
                <button type="button" class="block-btn" onclick="deleteBlock(this)" title="å‰Šé™¤">ğŸ—‘ï¸</button>
            </div>
        `;
        return div;
    }

    // ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯åˆæœŸåŒ–
    function initTextBlock(initialContent = '') {
        const wrapper = createBlockWrapper('ğŸ“', 'èª¬æ˜æ–‡ãƒ»å•é¡Œæ–‡');
        wrapper.dataset.type = 'text-block';

        const editorId = `quill-${blockCount++}`;
        const editorDiv = document.createElement('div');
        editorDiv.id = editorId;
        editorDiv.style.height = '150px';
        editorDiv.style.background = 'white';
        editorDiv.style.marginBottom = '10px';
        editorDiv.innerHTML = initialContent;

        wrapper.querySelector('.block-content').appendChild(editorDiv);
        container.appendChild(wrapper);

        new Quill(`#${editorId}`, {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['link', 'image', 'clean']
                ]
            },
            placeholder: 'ã“ã“ã«æ–‡ç« ã‚’å…¥åŠ›...'
        });
    }

    // ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ–ãƒ­ãƒƒã‚¯åˆæœŸåŒ–
    function initWidgetBlock(type, choices = [], description = '') {
        let title = '';
        let icon = '';
        if (type === 'choice') { title = 'é¸æŠå•é¡Œ (å˜ä¸€é¸æŠ)'; icon = 'ğŸ”´'; }
        if (type === 'checkbox') { title = 'é¸æŠå•é¡Œ (è¤‡æ•°é¸æŠ)'; icon = 'â˜‘ï¸'; }
        if (type === 'text') { title = 'è¨˜è¿°å•é¡Œ'; icon = 'âœï¸'; }

        const wrapper = createBlockWrapper(icon, title);
        wrapper.dataset.type = 'widget';
        wrapper.dataset.widgetType = type;

        // descriptionã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºè§£é™¤ (input valueç”¨)
        // ã“ã“ã§ã¯å˜ç´”ã«æ¸¡ã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’valueã«å…¥ã‚Œã‚‹

        let contentHtml = '';
        if (type === 'text') {
            contentHtml = `
                <div class="widget-preview">
                    <label style="font-weight:bold; display:block; margin-bottom:8px;">å•é¡Œæ–‡ãƒ»èª¬æ˜ (ä»»æ„)</label>
                    <textarea class="widget-description-input" placeholder="ã“ã®è§£ç­”æ¬„ã«é–¢ã™ã‚‹èª¬æ˜ã‚„å•é¡Œæ–‡ã‚’å…¥åŠ›..." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; margin-bottom:16px; min-height:60px;">${description}</textarea>

                    <div style="color:#666; font-size:0.9rem; margin-bottom:8px;">å›ç­”å…¥åŠ›æ¬„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</div>
                    <div style="background:#fff; padding:12px; border:2px solid #ccc; border-radius:4px; height:80px; color:#999; display:flex; align-items:center;">
                        [ã“ã“ã«ç”Ÿå¾’ãŒå›ç­”ã‚’å…¥åŠ›ã™ã‚‹æ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™]
                    </div>
                </div>
            `;
        } else {
            let choiceItems = '';
            choices.forEach((c) => {
                choiceItems += `
                <div class="choice-item">
                    <input type="text" class="choice-input" placeholder="é¸æŠè‚¢ã‚’å…¥åŠ›..." value="${c}" oninput="updateChoicesData(this)">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeChoice(this)">Ã—</button>
                </div>`;
            });

            contentHtml = `
                <div style="background:#f8f9fa; padding:16px; border-radius:8px;">
                    <label style="font-weight:bold; display:block; margin-bottom:8px;">å•é¡Œæ–‡ãƒ»èª¬æ˜ (ä»»æ„)</label>
                    <textarea class="widget-description-input" placeholder="ã“ã®è§£ç­”æ¬„ã«é–¢ã™ã‚‹èª¬æ˜ã‚„å•é¡Œæ–‡ã‚’å…¥åŠ›..." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; margin-bottom:16px; min-height:60px;">${description}</textarea>

                    <label style="font-weight:bold; display:block; margin-bottom:8px;">é¸æŠè‚¢ã‚’è¨­å®š</label>
                    <div class="choice-list">
                        ${choiceItems}
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm" style="margin-top:12px;" onclick="addChoice(this)">ï¼‹ é¸æŠè‚¢ã‚’è¿½åŠ </button>
                    
                    <div class="widget-preview" style="margin-top:16px;">
                        <div style="color:#666; font-size:0.9rem; margin-bottom:4px;">ç”Ÿå¾’å´ã®è¡¨ç¤ºãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</div>
                        <div class="preview-area" style="display:flex; flex-direction:column; gap:4px;"></div>
                    </div>
                </div>
            `;
        }

        wrapper.querySelector('.block-content').innerHTML = contentHtml;
        container.appendChild(wrapper);

        if (type !== 'text') updatePreview(wrapper);
    }

    // ãƒ‘ãƒ–ãƒªãƒƒã‚¯é–¢æ•° (ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ç”¨)
    window.addTextBlock = () => { initTextBlock(); };
    window.addWidgetBlock = (type) => { initWidgetBlock(type, ['ã¯ã„', 'ã„ã„ãˆ']); };

    // --- æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ ---
    window.addChoice = function (btn) {
        const list = btn.parentElement.querySelector('.choice-list');
        const div = document.createElement('div');
        div.className = 'choice-item';
        div.innerHTML = `
            <input type="text" class="choice-input" placeholder="é¸æŠè‚¢ã‚’å…¥åŠ›..." oninput="updateChoicesData(this)">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeChoice(this)">Ã—</button>
        `;
        list.appendChild(div);
        div.querySelector('input').focus();
        updatePreview(btn.closest('.content-block'));
    };

    window.removeChoice = function (btn) {
        const block = btn.closest('.content-block');
        const list = btn.closest('.choice-list');
        if (list.children.length > 1) {
            btn.closest('.choice-item').remove();
            updatePreview(block);
        } else {
            alert('é¸æŠè‚¢ã¯æœ€ä½1ã¤å¿…è¦ã§ã™ã€‚');
        }
    };

    window.updateChoicesData = function (input) { updatePreview(input.closest('.content-block')); };

    function updatePreview(block) {
        const type = block.dataset.widgetType;
        const inputs = Array.from(block.querySelectorAll('.choice-input'));
        const previewArea = block.querySelector('.preview-area');
        if (!previewArea) return;

        let html = '';
        inputs.forEach(input => {
            const val = input.value || '(ç©º)';
            const mark = type === 'choice' ? 'â­•' : 'â˜‘ï¸';
            html += `
                <div style="padding:10px 16px; background:white; border:1px solid #ddd; border-radius:8px; display:flex; align-items:center; gap:10px;">
                    <span style="font-size:1.2rem;">${mark}</span>
                    <span style="font-weight:500;">${val}</span>
                </div>
            `;
        });
        previewArea.innerHTML = html;
        const choices = inputs.map(i => i.value).filter(v => v.trim() !== "");
        block.dataset.choices = JSON.stringify(choices);
    }

    window.moveBlock = function (btn, dir) {
        const block = btn.closest('.content-block');
        if (dir === -1 && block.previousElementSibling) {
            block.parentNode.insertBefore(block, block.previousElementSibling);
        } else if (dir === 1 && block.nextElementSibling) {
            block.parentNode.insertBefore(block.nextElementSibling, block);
        }
    };

    window.deleteBlock = function (btn) {
        if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) btn.closest('.content-block').remove();
    };

    // --- ãƒ‘ãƒ¼ã‚¹å‡¦ç† ---
    document.addEventListener('DOMContentLoaded', function () {
        const rawContent = document.getElementById('raw-content');
        if (!rawContent) return;

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = rawContent.innerHTML;

        // å­è¦ç´ ã‚’èµ°æŸ»ã—ã¦ãƒ–ãƒ­ãƒƒã‚¯åŒ–
        const childNodes = Array.from(tempDiv.childNodes);
        let buffer = document.createElement('div');

        const flushBuffer = () => {
            // ãƒãƒƒãƒ•ã‚¡ã«æ„å‘³ã®ã‚ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚‹ã‹ï¼Ÿ
            if (buffer.innerHTML.trim() !== '' && buffer.innerText.trim() !== '') {
                initTextBlock(buffer.innerHTML);
            } else if (buffer.querySelector('img')) {
                initTextBlock(buffer.innerHTML);
            }
            buffer = document.createElement('div'); // Reset
        };

        childNodes.forEach(node => {
            if (node.nodeType === Node.ELEMENT_NODE && (node.classList.contains('question-widget') || (node.querySelector && node.querySelector('.question-widget')))) {
                // ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆç™ºè¦‹
                flushBuffer();

                // nodeè‡ªä½“ãŒwidgetã‹ã€ä¸­ã«widgetã‚’æŒã£ã¦ã„ã‚‹ã‹
                let widget = node.classList.contains('question-widget') ? node : node.querySelector('.question-widget');

                if (widget) {
                    const type = widget.dataset.widgetType;
                    const choices = JSON.parse(widget.dataset.choices || '[]');
                    // èª¬æ˜æ–‡ã®æŠ½å‡º
                    const descDiv = widget.querySelector('.widget-description');
                    // innerTextã ã¨æ”¹è¡ŒãŒæ¶ˆãˆã‚‹å ´åˆãŒã‚ã‚‹ã®ã§ã€innerHTMLã‹ã‚‰<br>ã‚’æˆ»ã™
                    let description = '';
                    if (descDiv) {
                        description = descDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n');
                        // HTMLã‚¢ãƒ³ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— (ç°¡æ˜“)
                        const txt = document.createElement('textarea');
                        txt.innerHTML = description;
                        description = txt.value;
                    }
                    initWidgetBlock(type, choices, description);
                }
            } else if (node.nodeType === Node.ELEMENT_NODE && node.classList.contains('block-widget')) {
                // æ–°å½¢å¼ã®ãƒ©ãƒƒãƒ‘ãƒ¼
                flushBuffer();
                let widget = node.querySelector('.question-widget');
                if (widget) {
                    const type = widget.dataset.widgetType;
                    const choices = JSON.parse(widget.dataset.choices || '[]');
                    // èª¬æ˜æ–‡ã®æŠ½å‡º
                    const descDiv = widget.querySelector('.widget-description');
                    let description = '';
                    if (descDiv) {
                        description = descDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n');
                        const txt = document.createElement('textarea');
                        txt.innerHTML = description;
                        description = txt.value;
                    }
                    initWidgetBlock(type, choices, description);
                }
            } else if (node.nodeType === Node.ELEMENT_NODE && node.classList.contains('block-text')) {
                // æ–°å½¢å¼ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯
                flushBuffer(); // å‰ã®ãƒãƒƒãƒ•ã‚¡ãŒã‚ã‚Œã°åãå‡ºã™
                initTextBlock(node.innerHTML);
            } else {
                // é€šå¸¸ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -> ãƒãƒƒãƒ•ã‚¡ã¸
                buffer.appendChild(node.cloneNode(true));
            }
        });

        // æœ€å¾Œã«æ®‹ã£ãŸãƒãƒƒãƒ•ã‚¡ã‚’åãå‡ºã™
        flushBuffer();
    });

    // é€ä¿¡å‡¦ç†
    document.getElementById('edit-problem-form').addEventListener('submit', function (e) {
        const blocks = container.querySelectorAll('.content-block');
        let finalHtml = '';
        let hasContent = false;

        blocks.forEach(block => {
            if (block.dataset.type === 'text-block') {
                const editor = Quill.find(block.querySelector('.ql-container'));
                const html = editor.root.innerHTML;
                if (editor.getText().trim().length > 0 || html.includes('<img')) {
                    finalHtml += `<div class="block-text" style="margin-bottom:1rem;">${html}</div>`;
                    hasContent = true;
                }
            } else if (block.dataset.type === 'widget') {
                const type = block.dataset.widgetType;
                let widgetHtml = '';

                if (type === 'text') {
                    const description = block.querySelector('.widget-description-input')?.value || '';
                    const safeDesc = description.replace(/"/g, '&quot;').replace(/\n/g, '<br>');

                    widgetHtml = `
                    <div class="question-widget" data-widget-type="text" contenteditable="false">
                        <div class="widget-header">âœï¸ è¨˜è¿°å›ç­”æ¬„</div>
                        ${description ? `<div class="widget-description" style="margin-bottom:8px; font-weight:bold;">${safeDesc}</div>` : ''}
                        <div class="widget-active-content">
                            <div style="background:#fff; padding:12px; border:2px solid #ccc; border-radius:4px; height:60px; color:#999; display:flex; align-items:center;">[ã“ã“ã«ç”Ÿå¾’ãŒå›ç­”ã‚’å…¥åŠ›ã™ã‚‹æ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™]</div>
                        </div>
                    </div>`;
                    hasContent = true;
                } else {
                    const choices = block.dataset.choices || '[]';
                    const safeChoices = choices.replace(/"/g, '&quot;');
                    const displayChoices = JSON.parse(choices);
                    const description = block.querySelector('.widget-description-input')?.value || '';
                    const safeDesc = description.replace(/"/g, '&quot;').replace(/\n/g, '<br>');

                    let previewList = '';
                    displayChoices.forEach(c => {
                        const mark = type === 'choice' ? 'ğŸ”´' : 'â˜‘ï¸';
                        previewList += `<div style="display:flex; gap:8px; margin-top:4px;"><span style="color:var(--primary)">${mark}</span> ${c}</div>`;
                    });
                    const label = type === 'choice' ? 'ğŸ”´ é¸æŠå›ç­”æ¬„ (å˜ä¸€)' : 'â˜‘ï¸ é¸æŠå›ç­”æ¬„ (è¤‡æ•°)';
                    widgetHtml = `
                    <div class="question-widget" data-widget-type="${type}" data-choices="${safeChoices}" contenteditable="false">
                        <div class="widget-header">${label}</div>
                        ${description ? `<div class="widget-description" style="margin-bottom:8px; font-weight:bold;">${safeDesc}</div>` : ''}
                        <div class="widget-active-content">
                            ${previewList}
                        </div>
                    </div>`;
                    hasContent = true;
                }
                finalHtml += `<div class="block-widget" style="margin: 1.5rem 0;">${widgetHtml}</div>`;
            }
        });

        if (!hasContent) {
            e.preventDefault();
            alert('ä¸­èº«ãŒç©ºã§ã™');
            return;
        }

        document.getElementById('content').value = finalHtml;
    });
</script>
{% endblock %}