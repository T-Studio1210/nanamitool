{% extends "base.html" %}

{% block title %}æ¼¢å­—ä¸€è¦§ - ä¸ƒå¤¢å­¦ç¿’ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ“š å­¦å¹´åˆ¥æ¼¢å­—ä¸€è¦§</h1>
    <a href="{{ url_for('teacher_japanese_problems') }}" class="btn btn-secondary btn-sm">â† æˆ»ã‚‹</a>
</div>

<!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
<div class="card" style="margin-bottom: 16px; padding: 12px;">
    <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
        <a href="{{ url_for('teacher_kanji_list') }}" class="btn btn-primary btn-sm">ğŸ“š æ¼¢å­—ä¸€è¦§</a>
        <a href="{{ url_for('teacher_japanese_problems') }}" class="btn btn-secondary btn-sm">ğŸ¯ ç†Ÿèªã‚¯ã‚¤ã‚º</a>
        <a href="{{ url_for('teacher_flashcard_manage') }}" class="btn btn-secondary btn-sm">ğŸ“– ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</a>
        <a href="{{ url_for('teacher_writing_manage') }}" class="btn btn-secondary btn-sm">âœï¸ æ›¸ãå–ã‚Š</a>
        <a href="{{ url_for('teacher_japanese_send') }}" class="btn btn-secondary btn-sm">ğŸ“¤ ç”Ÿå¾’ã«é…ä¿¡</a>
    </div>
</div>

<!-- é¸æŠã—ãŸæ¼¢å­—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div class="card" id="selected-kanji-card" style="display: none;">
    <h2 class="card-title">âœï¸ é¸æŠã—ãŸæ¼¢å­— <span id="selected-count">(0å­—)</span></h2>
    <div id="selected-kanji-list"
        style="font-size: 1.5rem; line-height: 2; letter-spacing: 0.3em; margin-bottom: 16px;"></div>
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button type="button" class="btn btn-primary" onclick="generateProblems()">
            âœ¨ AIã§å•é¡Œã‚’ç”Ÿæˆ
        </button>
        <button type="button" class="btn btn-secondary" onclick="clearSelection()">
            ğŸ—‘ï¸ é¸æŠã‚’ã‚¯ãƒªã‚¢
        </button>
    </div>
</div>

<!-- å­¦å¹´ã‚¿ãƒ– -->
<div class="card">
    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
        {% for grade_code, grade_name in grades %}
        <button type="button"
            class="btn {% if grade_code == current_grade %}btn-primary{% else %}btn-secondary{% endif %} btn-sm grade-tab"
            data-grade="{{ grade_code }}" onclick="switchGrade('{{ grade_code }}')">
            {{ grade_name }} ({{ kanji_counts[grade_code] }}å­—)
        </button>
        {% endfor %}
    </div>

    <!-- æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ -->
    <div style="margin-bottom: 16px;">
        <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
            <input type="text" id="kanji-search" class="form-input" placeholder="ğŸ” æ¼¢å­—ãƒ»èª­ã¿æ–¹ãƒ»æ„å‘³ã§æ¤œç´¢... (Enterã§æ¤œç´¢)"
                style="flex: 1; min-width: 200px; max-width: 400px;" onkeydown="handleSearchKey(event)"
                value="{{ search_query or '' }}">
            <button type="button" class="btn btn-primary btn-sm" onclick="performSearch()">æ¤œç´¢</button>
            <button type="button" class="btn btn-secondary btn-sm" onclick="clearSearch()">ã‚¯ãƒªã‚¢</button>
            <span id="search-result-count" style="color: var(--text-muted); font-size: 0.85rem;"></span>
        </div>
    </div>

    <h2 class="card-title" id="grade-title">{{ current_grade_name }} ã®æ¼¢å­—</h2>

    <!-- æ¼¢å­—ã‚°ãƒªãƒƒãƒ‰ -->
    <div id="kanji-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px;">
        {% for kanji in kanji_list %}
        <button type="button" class="kanji-btn" data-kanji="{{ kanji.kanji }}" data-reading="{{ kanji.reading or '' }}"
            data-meaning="{{ kanji.meaning or '' }}" onclick="toggleKanji(this, '{{ kanji.kanji }}')">
            {{ kanji.kanji }}
        </button>
        {% endfor %}
    </div>

    {% if not kanji_list %}
    <p style="color: var(--text-muted); text-align: center; padding: 40px;">
        ã“ã®å­¦å¹´ã®æ¼¢å­—ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
        ã‚·ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¦ãã ã•ã„ã€‚
    </p>
    {% endif %}
</div>

<!-- AIå•é¡Œç”Ÿæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="generate-modal"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h2 class="card-title">âœ¨ AIå•é¡Œç”Ÿæˆ</h2>
        <form id="generate-form" method="POST" action="{{ url_for('teacher_kanji_generate') }}">
            <input type="hidden" name="selected_kanji" id="selected-kanji-input">

            <div class="form-group">
                <label class="form-label">é¸æŠã—ãŸæ¼¢å­—</label>
                <div id="modal-selected-kanji"
                    style="font-size: 1.3rem; letter-spacing: 0.2em; background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">å•é¡Œã‚¿ã‚¤ãƒ—</label>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="problem_type" value="quiz" checked> ğŸ“ èª­ã¿æ–¹ã‚¯ã‚¤ã‚º
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="problem_type" value="flashcard"> ğŸƒ ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="problem_type" value="writing"> âœï¸ æ›¸ãå–ã‚Šç·´ç¿’
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">ç”Ÿæˆæ•°</label>
                <select name="count" class="form-input">
                    <option value="3">3å•</option>
                    <option value="5" selected>5å•</option>
                    <option value="10">10å•</option>
                    <option value="all">é¸æŠã—ãŸå…¨ã¦ã®æ¼¢å­—</option>
                </select>
            </div>

            <div class="form-group">
                <label
                    style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: var(--bg-hover); border-radius: 8px;">
                    <input type="checkbox" name="send_immediately" value="1" style="width: 20px; height: 20px;">
                    <span>ğŸ“¤ ç”Ÿæˆå¾Œã™ãã«å…¨ç”Ÿå¾’ã«é…ä¿¡ã™ã‚‹</span>
                </label>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary">
                    âœ¨ ç”Ÿæˆã™ã‚‹
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .kanji-btn {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
        border: 2px solid var(--border);
        background: var(--bg-card);
        color: var(--text-primary);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .kanji-btn:hover {
        background: var(--bg-hover);
        transform: scale(1.1);
    }

    .kanji-btn.selected {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .grade-tab {
        font-size: 0.85rem;
    }
</style>

<script>
    // é¸æŠã•ã‚ŒãŸæ¼¢å­—ã‚’ç®¡ç†
    let selectedKanji = new Set();

    function toggleKanji(btn, kanji) {
        if (selectedKanji.has(kanji)) {
            selectedKanji.delete(kanji);
            btn.classList.remove('selected');
        } else {
            selectedKanji.add(kanji);
            btn.classList.add('selected');
        }
        updateSelectedDisplay();
    }

    function updateSelectedDisplay() {
        const card = document.getElementById('selected-kanji-card');
        const list = document.getElementById('selected-kanji-list');
        const countSpan = document.getElementById('selected-count');

        if (selectedKanji.size > 0) {
            card.style.display = 'block';
            list.textContent = Array.from(selectedKanji).join('');
            countSpan.textContent = `(${selectedKanji.size}å­—)`;
        } else {
            card.style.display = 'none';
        }
    }

    function clearSelection() {
        selectedKanji.clear();
        document.querySelectorAll('.kanji-btn.selected').forEach(btn => {
            btn.classList.remove('selected');
        });
        updateSelectedDisplay();
    }

    // æ¤œç´¢æ©Ÿèƒ½
    function performSearch() {
        const query = document.getElementById('kanji-search').value.trim();
        if (query) {
            window.location.href = `/teacher/kanji?q=${encodeURIComponent(query)}`;
        } else {
            window.location.href = `/teacher/kanji`;
        }
    }

    function handleSearchKey(event) {
        if (event.key === 'Enter') {
            performSearch();
        }
    }

    function clearSearch() {
        document.getElementById('kanji-search').value = '';
        window.location.href = `/teacher/kanji`;
    }

    function switchGrade(gradeCode) {
        // é¸æŠã‚’ä¿æŒã—ãŸã¾ã¾åˆ¥å­¦å¹´ã«åˆ‡ã‚Šæ›¿ãˆ
        window.location.href = `/teacher/kanji?grade=${gradeCode}`;
    }

    function generateProblems() {
        if (selectedKanji.size === 0) {
            alert('æ¼¢å­—ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }

        document.getElementById('selected-kanji-input').value = Array.from(selectedKanji).join('');
        document.getElementById('modal-selected-kanji').textContent = Array.from(selectedKanji).join(' ');
        document.getElementById('generate-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('generate-modal').style.display = 'none';
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.getElementById('generate-modal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰é¸æŠã‚’å¾©å…ƒ
    document.addEventListener('DOMContentLoaded', function () {
        const saved = sessionStorage.getItem('selectedKanji');
        if (saved) {
            const savedSet = new Set(JSON.parse(saved));
            document.querySelectorAll('.kanji-btn').forEach(btn => {
                const kanji = btn.dataset.kanji;
                if (savedSet.has(kanji)) {
                    selectedKanji.add(kanji);
                    btn.classList.add('selected');
                }
            });
            updateSelectedDisplay();
        }
    });

    // é¸æŠã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    window.addEventListener('beforeunload', function () {
        sessionStorage.setItem('selectedKanji', JSON.stringify(Array.from(selectedKanji)));
    });

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚
    document.getElementById('generate-form').addEventListener('submit', function () {
        const btn = this.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.innerHTML = 'â³ ç”Ÿæˆä¸­...';
    });
</script>
{% endblock %}