{% extends "base.html" %}

{% block title %}å•é¡Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ - ä¸ƒå¤¢å­¦ç¿’{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="page-header">
        <h1 class="page-title">ğŸ“š å•é¡Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h1>
        <a href="{{ url_for('create_problem') }}" class="btn btn-primary">ï¼‹ æ–°è¦å•é¡Œä½œæˆï¼ˆãƒ†ã‚¹ãƒˆé…ä¿¡ï¼‰</a>
    </div>

    <!-- æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå°†æ¥çš„ã«å®Ÿè£…ï¼‰
    <div class="card" style="margin-bottom: 1.5rem; padding: 1rem;">
        <input type="text" class="form-input" placeholder="å•é¡Œã‚¿ã‚¤ãƒˆãƒ«ã‚„å†…å®¹ã§æ¤œç´¢...">
    </div>
    -->

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 class="card-title" style="margin:0;">ç™»éŒ²æ¸ˆã¿å•é¡Œä¸€è¦§ ({{ problems|length }})</h2>
            <button type="button" class="btn btn-danger btn-sm" onclick="confirmBulkDelete()" id="bulk-delete-btn"
                style="display:none;">é¸æŠã—ãŸå•é¡Œã‚’å‰Šé™¤</button>
        </div>

        {% if problems %}
        <form id="bulk-delete-form" action="{{ url_for('bulk_delete_problems') }}" method="POST">
            <div class="problem-list" style="margin-top: 1rem;">
                {% for problem in problems %}
                <div class="problem-card" style="display: block; position: relative;">
                    <div style="position:absolute; top:12px; left:12px;">
                        <input type="checkbox" name="problem_ids" value="{{ problem.id }}" class="bulk-check"
                            style="width:18px; height:18px;" onchange="toggleBulkBtn()">
                    </div>
                    <div class="problem-header"
                        style="justify-content: space-between; align-items: start; padding-left: 2rem;">
                        <div>
                            <h3 class="problem-title">{{ problem.title }}</h3>
                            <div class="problem-meta">
                                ä½œæˆæ—¥: {{ problem.created_at|jst('%Y/%m/%d') }}
                                {% if problem.problem_type == 'choice' %}
                                <span class="status-badge" style="background:var(--bg-hover);">âœ… é¸æŠå¼(æ—§)</span>
                                {% elif problem.problem_type == 'text' %}
                                <span class="status-badge" style="background:var(--bg-hover);">ğŸ“ è¨˜è¿°å¼(æ—§)</span>
                                {% else %}
                                <span class="status-badge" style="background:var(--primary); color:white;">âœ¨ è¤‡åˆ</span>
                                {% endif %}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <a href="{{ url_for('edit_problem', problem_id=problem.id) }}"
                                class="btn btn-secondary btn-sm">âœï¸ ç·¨é›†</a>
                            <div style="display:inline;">
                                <input type="hidden" name="redirect_to" value="manage_problems">
                                <button type="button" class="btn btn-danger btn-sm"
                                    onclick="if(confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã‚Œã«é–¢é€£ã™ã‚‹ç”Ÿå¾’ã®å›ç­”ã‚‚å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) { document.getElementById('single-delete-form-{{ problem.id }}').submit(); }">ğŸ—‘ï¸
                                    å‰Šé™¤</button>
                            </div>
                        </div>
                    </div>
                    <div class="problem-preview" style="margin-top: 8px; padding-left: 2rem;">
                        {{ problem.content|striptags|truncate(80) }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </form>

        <!-- å€‹åˆ¥å‰Šé™¤ç”¨ãƒ•ã‚©ãƒ¼ãƒ  (ãƒ«ãƒ¼ãƒ—å¤–ã«ã¯å‡ºã›ãªã„ãŸã‚ã€JSã§é€ä¿¡ãƒˆãƒªã‚¬ãƒ¼ã‚’å¼•ãã‹ã€form nestingã‚’é¿ã‘ã‚‹å·¥å¤«ãŒå¿…è¦) -->
        <!-- Form nesting is invalid HTML. Better approach: Use a separate form for each delete button OUTSIDE the main form, or use JS to submit to different endpoints. -->
        <!-- But wait, I wrapped the whole list in a form. The single delete buttons were forms. Nested forms are bad. -->
        <!-- FIX: Change single delete buttons to simple buttons that submit a specific hidden form elsewhere, OR change the main bulk delete to not be a surrounding form but JS submission. -->
        <!-- I will use JS submission for bulk delete to avoid nesting issues with existing single delete forms if I keep them as forms. -->
        <!-- ACTUALLY, I'll remove the surrounding form and use JS to gather IDs and submit. -->

        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ“‚</div>
            <p>ç™»éŒ²ã•ã‚ŒãŸå•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>
        {% endif %}
    </div>
</div>

{% for problem in problems %}
<!-- å€‹åˆ¥å‰Šé™¤ç”¨ãƒ•ã‚©ãƒ¼ãƒ  -->
<form id="single-delete-form-{{ problem.id }}" method="POST"
    action="{{ url_for('delete_problem', problem_id=problem.id) }}" style="display:none;">
    <input type="hidden" name="redirect_to" value="manage_problems">
</form>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
    function toggleBulkBtn() {
        const checks = document.querySelectorAll('.bulk-check:checked');
        const btn = document.getElementById('bulk-delete-btn');
        if (checks.length > 0) {
            btn.style.display = 'block';
            btn.textContent = `${checks.length}ä»¶ã‚’å‰Šé™¤`;
        } else {
            btn.style.display = 'none';
        }
    }

    function confirmBulkDelete() {
        if (confirm('é¸æŠã—ãŸå•é¡Œã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\né–¢é€£ã™ã‚‹å›ç­”ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
            const form = document.getElementById('bulk-delete-action-form');
            form.innerHTML = ''; // clear
            document.querySelectorAll('.bulk-check:checked').forEach(c => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'problem_ids';
                input.value = c.value;
                form.appendChild(input);
            });
            form.submit();
        }
    }
</script>
<!-- Bulk Delete Submission Form -->
<form id="bulk-delete-action-form" action="{{ url_for('bulk_delete_problems') }}" method="POST" style="display:none;">
</form>
{% endblock %}